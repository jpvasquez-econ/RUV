---
title: "2-State_country"
output:
  html_notebook:
    toc: yes
    df_print: paged
    number_sections: yes    
  pdf_document:
    number_sections: yes
  word_document: default
header-includes:
- \usepackage{amsmath}
- \usepackage{amssymb}
- \usepackage{pifont}
- \usepackage{mathpazo}
---

## General information

1) Takes imports and exports data from census and changes the sectors to final 1-14.

2) This code calculates the state-country bilateral trade flows $X_{ij,k}$ when $i\in US\;  \&\;  j \notin US$ (exports from each state to each country) and $i\notin US\;  \&\;  j \in US$ (imports from each country to each state), for all sectors $k$ (except services).

## Input files

1. `0-Raw_Data/regions.csv`
2. `0-Raw_Data/sectors.csv`
3. `0-Raw_Data//State-Exports-Imports//State Exports by NAICS Commodities-i.csv`
4. `0-Raw_Data//State-Exports-Imports//State Imports by NAICS Commodities-i.csv`
5. `1-Intermediate_Processed_Data//census_exports.csv`
6. `1-Intermediate_Processed_Data//census_imports.csv`
7. `1-Intermediate_Processed_Data/state_imports_exports.csv`
8. `1-Intermediate_Processed_Data/country_country_step_.csv`

## Output files

1. `1-Intermediate_Processed_Data//census_exports.csv`
2. `1-Intermediate_Processed_Data//census_imports.csv`
3. `1-Intermediate_Processed_Data/state_imports_exports.csv`
4. `1-Intermediate_Processed_Data//state_country_step_y_.csv`
5. `1-Intermediate_Processed_Data//state_country_step_e_.csv`


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
remove(list = ls())
```

```{r warning=FALSE, include=FALSE, message=FALSE, results='hide', cache=FALSE}

# libraries
#options( scipen=100, stringsAsFactors=FALSE );
# vector of libraries to be used
libs <- c( 'dplyr', 'tidyr', 'readstata13', 'haven', 'stringr', 'nleqslv', 'gdata', 'Statamarkdown', 'formattable', 'ggplot2', 'viridis', 'RColorBrewer', 'reshape2', 'foreign', 'readxl', 'writexl', 'rjson', 'read_excel', 'Matrix', 'geodist');
# Install libraries in case they are not installed
#for( i in length(libs)){ 
  #if( !(libs[i] %in% installed.packages()) ) install.packages( libs ) 
#};
# Carga de bibliotecas
lapply( libs, require, character.only=TRUE );
```


# Task 1

## Importing datasets to R

```{r data, warning=FALSE}
reclass_sectors <- read.csv(paste("0-Raw_Data/sectors_naics.csv", sep=""), header = TRUE, sep = ",", dec = ".", fileEncoding="UTF-8-BOM")
reclass_sectors <- reclass_sectors %>%
  dplyr::rename(naics = NAICS) %>%
  filter(is.na(naics) == FALSE) %>%
  select(final_sector, naics)

#Export data
base_e <- c()
for (i in 1:5){
temp <- read.csv(paste("0-Raw_Data//State-Exports-Imports//State Exports by NAICS Commodities-",i,".csv", sep=""), skip = 3, header = FALSE, sep = ",", dec = ".")
base_e <- rbind(base_e, temp)
}


#Import data
base_i <- c()
for (i in 1:5){
temp <- read.csv(paste("0-Raw_Data//State-Exports-Imports//State Imports by NAICS Commodities-",i,".csv", sep=""), skip = 3, header = FALSE, sep = ",", dec = ".")
base_i <- rbind(base_i, temp)
}


```



```{r}
# Unifying .csv files

colnames(base_e) <- c("state", "naics3", "country", "year", "exports")
colnames(base_i) <- c("state", "naics3", "country", "year", "imports")

base_e <- base_e %>%
  arrange(year, state) %>%
  select(year, state, naics3, country, everything())
base_e$exports <- as.numeric(gsub(",","",base_e$exports))
base_i <- base_i %>%
  arrange(year, state) %>%
  select(year, state, naics3, country, everything())
base_i$imports <- as.numeric(gsub(",","",base_i$imports))


#exporting to .csv
write.table(base_e, file = paste("1-Intermediate_Processed_Data//census_exports.csv", sep=""), sep = ",", row.names = FALSE)
write.table(base_i, file = paste("1-Intermediate_Processed_Data//census_imports.csv", sep=""), sep = ",", row.names = FALSE)

```

## Changing sectors to relevant 1-14 sectors

```{r}

list_countries <- c("Australia", "Austria", "Belgium", "Brazil", "Bulgaria", "Canada", "China", "Cyprus", "Czech Republic", "Denmark", "Estonia", "Finland", "France", "United Kingdom", "Germany", "Greece", "Hungary", "India", "Indonesia", "Ireland", "Italy", "Japan", "Korea, South", "Lithuania", "Mexico", "Netherlands", "Poland", "Portugal", "Romania", "Russia", "Slovakia", "Slovenia", "Spain", "Sweden", "Taiwan", "Turkey", "Rest of world")
list_codes <- c("AUS" , "AUT" , "BEL" , "BRA", "BGR", "CAN" , "CHN", "CYP", "CZE", "DNK", "EST", "FIN", "FRA", "GBR", "DEU", "GRC", "HUN", "IND", "IDN", "IRL", "ITA", "JPN", "KOR", "LTU", "MEX", "NLD", "POL", "PRT", "ROU", "RUS", "SVK", "SVN", "ESP", "SWE", "TWN", "TUR", "RoW")
list <- data.frame(cbind(list_countries, list_codes))
list$list_countries <- as.character(list$list_countries)
list$list_codes <- as.character(list$list_codes)
final <- c()

for (type in c("exports", "imports")){
base <- read.csv(paste("1-Intermediate_Processed_Data//census_", type, ".csv", sep=""), header = TRUE, sep = ",", dec = ".")  
colnames(base) <- c("year", "state", "naics3", "country", "value") 
base <- base %>%
  filter(state!="Dist of Columbia" & state!="Puerto Rico" & state!="US Virgin Islands" & state!="Unknown") %>%
  filter(country!="APEC - Asia Pacific Economic Co-operation" & country!="ASEAN - Association of Southeast Asian Nations" & country!="Asia" & country!="Australia and Oceania" & country!="Central American Common Market" & country!="Euro Area" & country!="Europe" & country!="European Union" & country!="LAFTA - Latin American Free Trade Association" & country!="NATO (North Atlantic Treaty Organization) Allies" & country!="NICS - Newly Industrialized Countries" & country!="OECD - Organization for Economic Co-operation and Development" & country!="OPEC - Organization of Petroleum Exporting Countries" & country!="North America" & country!="Pacific Rim Countries" & country!="South/Central America" & country!="Twenty Latin American Republics" & country!="US Trade Agreements Partners" & country!="Western Sahara") %>%
  mutate(country = as.character(country)) %>%
  mutate(country = ifelse(country %in% list_countries, as.character(country), "Rest of world")) %>%
  left_join(list, by=c('country'='list_countries')) %>% 
  dplyr::rename(region = list_codes) %>%
  select(-country) %>%
  group_by(year, state, naics3, region) %>%
  mutate(value = sum(value)) %>%
  ungroup() %>%
  distinct(year, state, naics3, region, .keep_all = TRUE)
if (type == "exports"){
base <- base %>%
    dplyr::rename(origin = state) %>%
    dplyr::rename(destination = region)
} 
if (type == "imports"){
base <- base %>%
    dplyr::rename(destination = state) %>%
    dplyr::rename(origin = region)
}  

#Changing sectors Naics to final: only sending sector
base <- base %>%
    filter(naics3 != "All Commodities") %>%
    mutate(sec_naics = as.numeric(substr(x=naics3, start=1, stop=3))) %>%
    left_join(reclass_sectors, by=c('sec_naics'='naics')) %>% 
    dplyr::rename(sector = final_sector) %>%
    select(-naics3, -sec_naics) %>%
    filter(is.na(sector) == FALSE) %>%
    group_by(year, sector, destination, origin) %>%
    mutate(value = sum(value)) %>%
    ungroup() %>%
    distinct(year, sector, destination, origin, .keep_all = TRUE)

if (type == "exports"){
base <- base %>%
    mutate(file="i in US, j not in US")
} 
if (type =="imports"){
base <- base %>%
    mutate(file = "i not in US, j in US")
}  
base <- base %>% arrange(file, year, sector, destination)
base <- base %>% select(origin, year, destination, sector, value, file)
base$origin <- gsub(" ", "", base$origin, fixed = TRUE)
base$destination <- gsub(" ", "", base$destination, fixed = TRUE)
final <- rbind(final, base)  
}

write.table(final, file = paste("1-Intermediate_Processed_Data/state_imports_exports.csv", sep=""), sep = ",", row.names = FALSE)

```


# Task 2

We use $X_{ij,k}^{Census}$ and $X_{ij,k}^{ICIO}$ plus proportionality to calculate $X_{ij,k}$ for $i\in US\;  \&\;  j \notin US$ (exports from each State to each country) and $i\notin US\;  \&\;  j \in US$ (imports from each country to each State), and $\forall k$ (except services). We do the same procedure each year. Census data on exports and imports starts in 2002 and 2008 respectively.

Intermediate variables 

Define the share of exports of US State $i$ in sector $k$, going to country $j$ as: $$y_{ij,k}^{Census}\equiv\dfrac{X_{ij,k}^{Census}}{\sum_{h\in US}X_{hj,k}^{Census}} \; \forall i\in US \, , \, j\notin US.$$ 

Similarly, only for $j \in US$ define the share of imports of State $j$ in sector $k$, coming from country $i$ as
$$e_{ij,k}^{Census}\equiv\dfrac{X_{ij,k}^{Census}}{\sum_{l\in US}X_{il,k}^{Census}}. \; \forall i\notin US \, , \, j\in US.$$ 

**Note**: There are some very few cases that required corrections. For instance, say country j (i) did not import (export) from (to) the US in a given sector $k$ according to CENSUS data but it did it according to ICIO data. Then we would calculate $e_{ij,k}$ ($y_{ij,k}$) by splitting ICIO imports (exports) between the states according to the share of imports (exports) of that state in the total US imports (exports) of that sector $k$. This means:

$$
y_{i\;j,k}^{census}\equiv\dfrac{\sum_{j\notin US}X_{ij,k}^{census}}{\sum_{h\in US}\sum_{l\notin US}X_{hl,k}^{census}}, \; i\in US \, , \, j\notin US
$$

$$
e_{i\;j,k}^{census}\equiv\dfrac{\sum_{i\notin US}X_{ij,k}^{census}}{\sum_{h\notin US}\sum_{l\in US}X_{hl,k}^{census}}, \; i\notin US \, , \, j\in US
$$

Main variable

Define $\forall k$: 

$$X_{ij,k}=
\begin{cases}
e_{ij,k}^{Census}X_{i\,US,k}^{ICIO} \quad \forall i\notin US, \; \forall j\in US\\
y_{ij,k}^{Census}X_{US\,j,k}^{ICIO} \quad \forall i\in US, \; \forall j\notin US
\end{cases} $$

## Importing datasets to R

```{r}
#state level imports and exports
state_imp_exp_0 <- read.csv("1-Intermediate_Processed_Data//state_imports_exports.csv")
state_imp_exp_0 <- state_imp_exp_0 %>% filter(origin != "AllStates", destination != "AllStates")

#ICIO
icio_base <- c()
for (yr in 2015:2018) {
  icio <- read.csv(paste('1-Intermediate_Processed_Data//country_country_step_', yr, '.csv', sep= ""), header = TRUE, sep = ",", dec = ".")
  icio_base <- rbind(icio_base, icio)
}


#General parameters
regions <- read.csv("0-Raw_Data/regions.csv")
c_names <- regions %>% filter(status=="country", region!="USA")
c_names <- c_names$region

s_names <- regions %>% filter(status=="state") 
s_names <- s_names$region

n_s <- length(s_names)
n_c <- length(c_names)

reclass_sectors <- read.csv("0-Raw_Data/sectors_naics.csv", fileEncoding="UTF-8-BOM")
n_sec <- length(unique(reclass_sectors$final_sector)) - 3

epsilon <- 0.0001;

```


## States' imports from countries

```{r}

for (yr in 2015:2018) {

### Base year for imports
state_imp_exp <- data.frame(state_imp_exp_0) %>% 
  filter(year == yr, file == "i not in US, j in US") %>%
  select(-year, -file)

state_imp_exp <-spread(state_imp_exp, origin, value, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)
base_e <- state_imp_exp %>% 
  arrange(sector, destination) %>%
  filter(sector <= n_sec | sector == (n_sec + 2))

colnames(base_e) <- c("importer", "sector", c_names)
base_e[is.na(base_e)] <- 0  
  
#ICIO
icio <- subset(icio_base, year == yr)
icio <- subset(icio, select = -year) 


##################################################

eijkBase <- melt(base_e, id.vars=c("importer", "sector"), variable.name="origin", value.name = "value")
eijkBase <-spread(eijkBase, importer, value, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)
eijkBase <- eijkBase[, 3:dim(eijkBase)[2]] / rowSums(eijkBase[, 3:dim(eijkBase)[2]]) 


#######################################Main Variable
#e
df_icio <- data.frame(icio)
df_icio <- df_icio %>%
  filter(sector <= n_sec | sector == (n_sec + 2)) %>%
  filter(importer == 'USA')
df_icio1 <- df_icio %>% select(-USA, -importer)
colnames(df_icio1) <- c("sector", c_names)
df_icio1 <- melt(df_icio1, id.vars=c("sector"), variable.name = "origin", value.name = "value")
df_icio1 <- df_icio1 %>% arrange(sector, origin)

step3e <- eijkBase*df_icio1$value
step3e <- cbind(df_icio1[, 1:2], step3e)


#Check
check <- as.matrix(rowSums(step3e[, 3:dim(step3e)[2]]) - df_icio1$value)

##############################
#Correcting if needed
m_correct <- c()
for (sec in c(1:(n_sec), (n_sec + 2))) {
m <- base_e %>% filter(sector == sec)
m <- (rowSums(m[, 3:dim(m)[2]]) / sum(m[, 3:dim(m)[2]]))
m <- t(matrix(replicate(n_c, m), nrow = length(m), ncol = n_c))
m_correct <- rbind(m_correct, m) 
}
m_correct <- m_correct*df_icio1$value

for (r in 1:(dim(check)[1])) {
  if(is.na(check[r]) == TRUE){step3e[r, 3:dim(step3e)[2]] = m.correct[r, ]}
}

if(sum(abs(rowSums(step3e[, 3:dim(step3e)[2]])/df_icio1$value -1))>epsilon) 
   stop(paste("states' imports from countries != ICIO US imports from countries for", yr, " value=", sum(abs(rowSums(step3e[, 3:dim(step3e)[2]])/df_icio1$value -1))))
################

step3e <- melt(step3e, id.vars=c("origin", "sector"), variable.name="importer", value.name = "value")
step3e <-spread(step3e, origin, value, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)

step3e <- step3e %>%
  mutate(year = yr) %>%
  select(year, importer, sector, everything())

  #Exporting dataset
write.table(step3e, file = paste("1-Intermediate_Processed_Data//state_country_step_e_", yr,".csv", sep=""), sep = ",", row.names = FALSE)
}

```


## States' exports to countries

```{r}

for (yr in 2015:2018) {

#ICIO
icio <- subset(icio_base, year == yr)
icio <- subset(icio, select = -year) 


#Base year for exports
state_imp_exp <- data.frame(state_imp_exp_0) %>% 
  filter(year == yr, file == "i in US, j not in US") %>%
  select(-year, -file)
state_imp_exp <- spread(state_imp_exp, origin, value, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)

#### adding rows if no trade info for country-sector 
temp_names_1 <- as.character(unique(state_imp_exp$destination))
for (i in temp_names_1) {
  for (sec in c(1:12, 14)) {
    temp_1 <- state_imp_exp %>% filter(destination == i, sector == sec)
    if(dim(temp_1)[1] == 0){
      #print(yr)
      #print(i)
      #print(sec)
      row <- c(i, sec, matrix(0, nrow = 1, ncol = n_s))
      state_imp_exp <- rbind(state_imp_exp, row)}
    }
}
#### 
state_imp_exp$sector <- as.numeric(state_imp_exp$sector)

base_y <- state_imp_exp %>% 
  arrange(sector, destination) %>%
  filter(sector <= n_sec | sector == (n_sec + 2))
colnames(base_y) = c("importer", "sector", s_names)
base_y[is.na(base_y)] <- 0
base_y <- cbind(base_y[, 1:2], mapply(base_y[, 3:dim(base_y)[2]], FUN=as.numeric))


##################################################

##################################################

yijkBase <- base_y[, 3:dim(base_y)[2]] / rowSums(base_y[, 3:dim(base_y)[2]]) 

############################### Main variable
#y
df_icio <- data.frame(icio)
df_icio <- df_icio %>%
  filter(sector <= n_sec | sector == (n_sec + 2)) %>%
  filter(importer != 'USA') 

df_icio1 <- df_icio %>% select(importer, sector, USA)

step3y <- yijkBase*df_icio1$USA
step3y <- cbind(df_icio1[, 1:2], step3y)

#Check
check <- as.matrix(rowSums(step3y[, 3:dim(step3y)[2]]) - df_icio1$USA)


##############################
#Correcting if needed
base_y1 <- melt(base_y, id.vars=c("importer", "sector"), variable.name="origin", value.name = "value")
base_y1 <-spread(base_y1, importer, value, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)

m_correct <- c()
for (sec in c(1:(n_sec), (n_sec + 2))) {
m <- base_y1 %>% filter(sector == sec)
m <- (rowSums(m[, 3:dim(m)[2]]) / sum(m[, 3:dim(m)[2]]))
m <- t(matrix(replicate(n_c, m), nrow = length(m), ncol = n_c))
m_correct <- rbind(m_correct, m) 
}
m_correct <- m_correct*df_icio1$USA

for (r in 1:(dim(check)[1])) {
  if(is.na(check[r]) == TRUE){step3y[r, 3:dim(step3y)[2]] = m_correct[r, ]}
}

if(sum(abs(rowSums(step3y[, 3:dim(step3y)[2]])/df_icio1$USA -1))>epsilon) 
   stop(paste("states' exports to countries != ICIO US exports to countries for", yr, " value=", sum(abs(rowSums(step3y[, 3:dim(step3y)[2]])/df_icio1$USA -1))))
################

step3y <- step3y %>%
  mutate(year = yr) %>%
  select(year, importer, sector, everything())
colnames(step3y) <- c("year", "importer", "sector", s_names)

#Exporting data
write.table(step3y, file = paste("1-Intermediate_Processed_Data//state_country_step_y_", yr,".csv", sep=""), sep = ",", row.names = FALSE)
}
```

