---
title: "Agriculture data"
output:
  html_notebook:
    toc: yes
    df_print: paged
    number_sections: yes    
  pdf_document:
    number_sections: yes
header-includes:
- \usepackage{amsmath}
- \usepackage{amssymb}
- \usepackage{pifont}
- \usepackage{mathpazo}
---

# General information

This code creates a file that contains information about distances between regions, agricultural production for all regions and agricultural consumption for countries. In doing so, the code also applies the usual proportionality rule so that aggregate expenditure and production matches WIOD. 

## Input files

1. `0-Raw_Data/regions.csv`
2. `0-Raw_Data/sectors.csv`
3. `1-Intermediate_Processed_Data/state_imports_exports.csv`
4. `1-Intermediate_Processed_Data/country_country_step_.csv`
5. `0-Raw_Data//Agriculture_Census/data_agriculture.csv`
6. `1-Intermediate_Processed_Data/data_services.csv`

## Output files

1. `1-Intermediate_Processed_Data/census.exp.agri.proportionality.csv`
2. `1-Intermediate_Processed_Data/census.imp.agri.proportionality.csv`
3. `1-Intermediate_Processed_Data/data_agriculture.csv`


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, warning=FALSE, include=FALSE, message=FALSE, results='hide', cache=FALSE}
# libraries
remove(list = ls())
# vector of libraries to be used
libs <- c( 'dplyr', 'tidyr', 'readstata13', 'haven', 'stringr', 'nleqslv', 'gdata', 'Statamarkdown', 'formattable', 'ggplot2', 'viridis', 'RColorBrewer', 'reshape2', 'foreign', 'readxl');
#Installing libraries in case they are not installed
#for( i in length(libs)){ 
  #if( !(libs[i] %in% installed.packages()) ) install.packages( libs ) 
#};
#Loading libraries
lapply( libs, require, character.only=TRUE );
```

## Importing data to R

```{r data-importing}
#General parameters
regions <- read.csv("0-Raw_Data/regions.csv")
regions$region <- as.character(regions$region)
c.names <- regions %>% filter(status == "country", region != "USA")
c.names <- c.names$region

s.names <- regions %>% filter(status == "state") 
s.names <- s.names$region

n.s <- length(s.names)
n.c <- length(c.names)

reclass_sectors <- read.csv("0-Raw_Data/sectors.csv")
#non-gravity sectors
n.sec <- length(unique(reclass_sectors$final_sector)) -3
reclass_sectors <- reclass_sectors %>% 
  select(final_sector, wiod_sector) %>%
  distinct(wiod_sector, .keep_all = TRUE)

#WIOD
wiod_base <- c()
for (yr in 2000:2007) {
  wiot <- country.country <- read.csv(paste('1-Intermediate_Processed_Data//country_country_step_', yr, '.csv', sep= ""), header = TRUE, sep = ",", dec = ".")
  wiod_base <- rbind(wiod_base, wiot)
}
wiod_full <- read.csv("1-Intermediate_Processed_Data//wiot_full.csv")

#CENSUS
census <- read.csv("1-Intermediate_Processed_Data//state_imports_exports.csv")
state_imp_exp.0 <- census %>%
  filter(origin != "AllStates", destination != "AllStates")
  
#Agriculture production states
data_agri <- read.csv("0-Raw_Data//Agriculture_Census//data_agriculture.csv")

#Fish production states
data_fish <- read.csv("0-Raw_Data//Agriculture_Census//data_fish.csv")

#Trade distances
#temporarily using data_services to get the structure of the output and the distances
data_agriculture <- read.csv("1-Intermediate_Processed_Data//data_services.csv")
data_agriculture <- data_agriculture %>%
                    select(-R_i, -E_j) 
#names as characters
data_agriculture$iso_o<-as.character(data_agriculture$iso_o)
data_agri$iso_o <- lapply(data_agri$iso_o, as.character)
#epsilon for checks
epsilon <- 0.0001


```


# State's agriculture production 

## Production of agriculture of US states according to census of agriculture

```{r agric-census}
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 1. sum of crops, livestock, and fish
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
states_full <- merge(data_agri,data_fish, by=c("iso_o", "year"))
states_full$tot_prod <- states_full$fish_prod + states_full$R_i

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 2. calculating relative state productions
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
states_full <- states_full %>%
  group_by(year) %>%
  mutate(tot_US = sum(tot_prod)) %>%
  ungroup() %>%
  mutate(rel = tot_prod/tot_US) 
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 3. Assigning data to years
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
agri <- c() 
# We use Agriculture Census of 2002 for years 2000-2004 
# and Agriculture Census of 2007 for years 2005-2007
agri.2002 <- states_full %>% filter(year == 2002)
agri.2007 <- states_full %>% filter(year == 2007)
for (yr in 2000:2007) {
  if (yr<2005) {
    num  <- agri.2002
  } else {
    num  <- agri.2007  
  }  
  num    <- num %>%
            select(iso_o, rel,tot_prod) %>%
            mutate(year=yr)
  
  agri <- rbind(agri, num)
}
agri$R_i  <- NA
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 4. APPLYING PROPORTIONALITY TO WIOD
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
## SUM OF PRODUCTIONS ACROSS STATES = TOTAL PRODUCTION OF US ACCORDING TO WIOD

##
## 4.1 TOTAL PRODUCTION OF US IN AGRICULTURE ACCORDING TO WIOD
## 

wiod.agri <- wiod_full %>%
  filter(row_country == "USA", row_item == (n.sec + 2), year<=2007) %>%
  group_by(year) %>%
  mutate(production = sum(value)) %>%
  ungroup() %>%
  distinct(year, .keep_all = TRUE) %>%
  select(-value, -col_item, -col_country)

##
## 4.2 DIVIDING TOTAL US PRODUCTION ACROSS STATES ACCORDING TO RELATIVE IMPORTANCE IN CENSUS
## 

for (yr in 2000:2007) {
  wiod.value  <- wiod.agri %>%
                 filter(year == yr)
  wiod.value  <- wiod.value$production[1]
  agri        <- agri %>%
                 mutate(R_i= ifelse(year == yr, rel*wiod.value, R_i))
}

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 5. CHECKING
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

##
## 5.1 Check: total production of US states = total US in WIOD
## 

# total production of US states from proportionality 
check_1     <- agri %>%
               group_by(year) %>%
               mutate(total = sum(R_i)) %>%
               ungroup() %>% 
               select(total, year) %>%
               distinct(year, total) 

# total production of US states from WIOD 
check_2     <- wiod_full %>%
               filter(row_country == "USA", row_item == (n.sec + 2)) %>%
               filter(year<=2007) %>%
               group_by(year) %>%
               mutate(production = sum(value)) %>%
               ungroup() %>%
               distinct(year, .keep_all = TRUE) %>%
               select(production, year)
#check
if(abs(sum(check_2$production / check_1$total-1)>epsilon)) 
   stop(paste("states' production does not add to WIOD for")) 

##
## 5.2 Check: total production of each state > total exports of each state
## 

#importing exports by state
exports <- c()
for (yr in 2000:2007) {
exports_0      <- read.csv(paste('1-Intermediate_Processed_Data//state_country_step_y_', yr, '.csv', sep= ""),                   header = TRUE, sep = ",", dec = ".")  
exports_0      <- exports_0 %>%
                  filter(sector == (n.sec + 2)) %>%
                  select(-importer, -year, -sector)
exports_0      <- colSums(exports_0)
exports_0      <- as.data.frame(exports_0)
exports_0$year <- yr
exports_0$iso_o<- rownames(exports_0)
exports        <- rbind(exports, exports_0)
}

#comparing production and exports 

non_exports                   <- merge(exports,agri, by=c("iso_o", "year"));
non_exports$share_non_exports <- 1-non_exports$exports_0/non_exports$R_i;  
#there is an issue with Alaska and Louisiana. Exports seem to be bigger than production. We will increase production by $\eta_1$ in order to get production> exports*1.05

```

### Fixing exports>production for Alaska and Louisiana

Define $s_0 = \dfrac{Y_{AK}^{Ag.Census}}{\sum_{j \in US\, ,\, j\neq AK}Y_{j}^{Ag.Census}+Y_{AK}^{Ag.Census}}$ as the relative importance of the production of Alaska in the total of the US according to the agriculture (plus fishing) Census. We want to find a value $\eta_1$ such that increasing the origina value $Y_{AK}^{Ag.Census}$ by $\eta_1$ percent would make the total production of Alaska equal to its total exports  (after accounting for the proportionality with WIOD). We want that:

$$
\dfrac{Y_{AK}^{Ag.Census}(1+\eta_1)}{\sum_{j \in US\, ,\, j\neq AK}Y_{j}^{Ag.Census}+Y_{AK}^{Ag.Census}(1+\eta_1)} \times Y^{WIOD}_{US} = \sum_{j \notin US} X_{AK\, j}
$$
Define $\omega_0=\dfrac{\sum_{j \notin US} X_{AK\, j}}{Y^{WIOD}_{US}}$. Using the definition of $s_o$, we get that:

$$
\eta_1 = \dfrac{\omega_0 s_0^{-1} -1 }{1-\omega_0}
$$
Finally, we compute $Y^{new}_{AK}=Y_{AK}^{Ag.Census}(1+\eta_1)\times 1.05$, and use proportionality to match WIOD.

```{r alaska}
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 1. COMPUTING $\eta_1$
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

##
## 1.1 computing $\omega_0$
##
#exports
exports_ak <- exports %>%
              filter(iso_o == "Alaska" | iso_o == "Louisiana") %>%
              merge(wiod.agri, by=c("year")) %>%
              mutate(omega_0 = exports_0 / production) %>%
              select(iso_o, year, omega_0)

##
## 1.2 computing $s_0$
##
agri_ak    <- agri %>% 
              group_by(year) %>%
              mutate(tot_census= sum(R_i)) %>%
              ungroup() %>%
              filter(iso_o == "Alaska" | iso_o == "Louisiana") %>%
              mutate(s_o=R_i / tot_census) %>%
              select(year, iso_o, s_o, tot_prod)
              
##
## 1.3 computing $\eta_1$
##

agri_ak    <- agri_ak %>%
              merge(exports_ak, by=c("year", "iso_o")) %>%
              mutate(eta_1 = (omega_0*s_o^(-1)-1) / (1-omega_0))

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 2. FIXING VALUE OF ALASKA
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

agri_ak   <- agri_ak %>%
             filter(eta_1>-0.05) %>%
             mutate(tot_prod_fixed = tot_prod*(1+eta_1)*1.05) %>%
             select(iso_o, tot_prod_fixed, year)


#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 3. REPLACING IN ORIGINAL DATA
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
agri      <- as.data.frame(lapply(agri, unlist))

agri_new  <- agri %>%
             select(iso_o, tot_prod, year) %>%
             merge(agri_ak, by=c("iso_o", "year"), all=TRUE) %>%
             mutate(tot_prod = ifelse(is.na(tot_prod_fixed), tot_prod, tot_prod_fixed)) %>%
             select(iso_o, year, tot_prod)
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 4. RECOMPUTING THE SHARES AND PROPORTIONALITY TO WIOD
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%              
##
## 4.2 SHARES
##
agri_new      <- agri_new %>%
                 group_by(year) %>%
                 mutate(tot_US = sum(tot_prod)) %>%
                 ungroup() %>%
                 mutate(rel = tot_prod/tot_US) 
agri_new$R_i  <- NA
##
## 4.1 DIVIDING TOTAL US PRODUCTION ACROSS STATES ACCORDING TO RELATIVE IMPORTANCE IN CENSUS
## 

for (yr in 2000:2007) {
  wiod.value  <- wiod.agri %>%
                 filter(year == yr)
  wiod.value  <- wiod.value$production[1]
  agri_new    <- agri_new %>%
                 mutate(R_i = ifelse(year == yr, rel*wiod.value, R_i))
}
agri_new <- agri_new %>%
            select(iso_o, year, R_i)
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 5. CHECKING WITH EXPORTS AGAIN
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
non_exports <- merge(exports,agri_new, by=c("iso_o", "year")) %>%
               mutate(share_non_exports = 1 - exports_0/R_i)        
#check
if(min(non_exports$share_non_exports<0)) 
   stop(paste("Still production<exports")) 

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 6. CORRECT PRODUCTION OF US STATES
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

data_agriculture <- data_agriculture %>%
                    merge(agri_new, by=c("iso_o", "year"), all=TRUE) 

```

## Production and expenditure for countries

```{r prod-exp-countries}
##
## 1. agricultural production for countries 
##

wiod_p <- wiod_full %>%
          filter(row_item == n.sec + 2) %>%
          group_by(year, row_country) %>%
          mutate(production = sum(value)) %>%
          ungroup() %>%
          distinct(year, row_country, .keep_all = TRUE) %>%
          mutate(iso_o = row_country) %>%
          select(iso_o, year, production)
##
## 2. agricultural expenditure for countries
##

wiod_c <- wiod_full %>%
          filter(row_item==n.sec+2) %>%
          group_by(year, col_country) %>%
          mutate(E_j= sum(value)) %>%
          ungroup() %>%
          distinct(year, col_country, .keep_all = TRUE) %>%
          mutate(iso_d=col_country) %>%
          select(iso_d, year, E_j)

##
## 3. merging with data_agriculture
##

#expenditure
data_agriculture <- data_agriculture %>%
                    merge(wiod_c, by=c("iso_d", "year"), all=TRUE) 
#production
data_agriculture <- data_agriculture %>%
                    merge(wiod_p, by=c("iso_o", "year"), all=TRUE) %>%
                    mutate(R_i= ifelse(is.na(production), R_i, production)) %>%
                    select(-production)
#arranging before saving
data_agriculture <- data_agriculture %>%
                    mutate(iso_o=as.character(iso_o), iso_d=as.character(iso_d)) %>%
                    mutate(c_o=ifelse(nchar(iso_o)>3, 0, 1), c_d=ifelse(nchar(iso_d)>3, 0, 1)) %>%
                    arrange(year, c_o, iso_o, c_d, iso_d) %>%
                    select(-c_o,-c_d)
data_agriculture <- data_agriculture[c("year", "iso_o", "iso_d", "dist", "R_i", "E_j")]
data_agriculture <- data_agriculture %>%
  filter(iso_o != "USA" & iso_d != "USA")

write.table(data_agriculture, file = paste("1-Intermediate_Processed_Data//data_agriculture.csv", sep=""), sep = ",", row.names = FALSE)
```

# Proportionality for state-level imports and exports in agriculture

This is useful to calculate $E_j$ in a later code

## Imports of agriculture

```{r imports}
### Base year for imports (2008)
state_imp_exp <- data.frame(state_imp_exp.0) %>% 
  filter(year == 2008, file=="i not in US, j in US") %>%
  select(-year, -file)

state_imp_exp <-spread(state_imp_exp, origin, value, fill = 0, convert = TRUE,  drop = TRUE, sep = NULL)
base_e <- state_imp_exp %>% 
  arrange(sector, destination) %>%
  filter(sector == n.sec + 2)

colnames(base_e)= c("importer", "sector", c.names)
#base_e[is.na(base_e)] <- 0

step3e_1 <- c()
for (yr in 2000:2007) {

#WIOD
wiod <- subset(wiod_base, year == yr)
wiod <- subset(wiod, select = -year) 


##################################################

eijkBase <- melt(base_e, id.vars=c("importer", "sector"), variable.name="origin", value.name = "value")
eijkBase <-spread(eijkBase, importer, value, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)
eijkBase <- eijkBase[, 3:dim(eijkBase)[2]] / rowSums(eijkBase[, 3:dim(eijkBase)[2]]) 


#######################################Main Variable
#e
df_wiod <- data.frame(wiod)
df_wiod <- df_wiod %>%
  filter(sector==n.sec+2) %>%
  filter(importer=='USA')
df_wiod1 <- df_wiod %>% select(-USA, -importer)
colnames(df_wiod1) <- c("sector", c.names)
df_wiod1 <- melt(df_wiod1, id.vars=c("sector"), variable.name="origin", value.name = "value")
df_wiod1 <- df_wiod1 %>% arrange(sector, origin)

step3e=eijkBase*df_wiod1$value
step3e <- cbind(df_wiod1[, 1:2], step3e)


#Check
check= as.matrix(rowSums(step3e[, 3:dim(step3e)[2]]) - df_wiod1$value)

##############################
#Correcting if needed
m.correct <- c()
for (sec in (n.sec + 2)) {
m <- base_e %>% filter(sector == sec)
m <- (rowSums(m[, 3:dim(m)[2]]) / sum(m[, 3:dim(m)[2]]))
m= t(matrix(replicate(n.c, m), nrow = length(m), ncol = n.c))
m.correct <- rbind(m.correct, m) 
}
m.correct <- m.correct*df_wiod1$value

for (r in 1:(dim(check)[1])) {
  if(is.na(check[r]) == TRUE){step3e[r, 3:dim(step3e)[2]] = m.correct[r, ]}
}

if(abs(sum(rowSums(step3e[, 3:dim(step3e)[2]]) - df_wiod1$value))>epsilon) 
   stop(paste("states' imports from countries != WIOD US imports from countries for", yr, " value=", abs(sum(step3e[, 3:dim(step3e)[2]] - df.WIOD1$value))))
################

step3e <- melt(step3e, id.vars=c("origin", "sector"), variable.name="importer", value.name = "value")
step3e <-spread(step3e, origin, value, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)

step3e <- step3e %>%
  mutate(year = yr) %>%
  select(year, importer, sector, everything()) %>%
  select(-sector)
step3e_1 <- rbind(step3e_1, step3e)

}

census_imp <- melt(step3e_1, id.var=c("year", "importer"), variable.name = "origin")
census_imp$origin <- as.character(census_imp$origin)
write.table(census_imp, file = paste("1-Intermediate_Processed_Data//census.imp.agri.proportionality.csv", sep=""), sep = ",", row.names = FALSE)
```

## Exports of agriculture

```{r exports}
step3y_1 <- c()
for (yr in 2000:2007) {

#WIOD
wiod <- subset(wiod_base, year == yr)
wiod <- subset(wiod, select = -year) 


#Base year for exports (2002)
yr. <- yr
if(yr < 2002){yr. = 2002}
state_imp_exp <- data.frame(state_imp_exp.0) %>% 
  filter(year == yr., file == "i in US, j not in US") %>%
  select(-year, -file)
state_imp_exp <-spread(state_imp_exp, origin, value, fill = 0, convert = TRUE,  drop = TRUE, sep = NULL)
#no trade from US states to SVK in sector 4 in 2002
#if(yr <= 2002) {row <- c("SVK", 4L, matrix(0, nrow = 1, ncol = n.s))
#state_imp_exp <- rbind(state_imp_exp, row)}
#state_imp_exp$sector <- as.numeric(state_imp_exp$sector)

base_y <- state_imp_exp %>% 
  arrange(sector, destination) %>%
  filter(sector == (n.sec + 2)) #agric always sector n.sec+2
colnames(base_y) <- c("importer", "sector", s.names)
#base_y[is.na(base_y)] <- 0
base_y <- cbind(base_y[, 1:2], mapply(base_y[, 3:dim(base_y)[2]], FUN = as.numeric))


########################################################
# proportions of trade of states to countries in agricu 
#######################################################

yijkBase <- base_y[, 3:dim(base_y)[2]] / rowSums(base_y[, 3:dim(base_y)[2]]) 

############################### Main variable
#y
df_wiod <- data.frame(wiod)
df_wiod <- df_wiod %>%
  filter(sector == n.sec + 2) %>%
  filter(importer != 'USA') 

df_wiod1 <- df_wiod %>% select(importer, sector, USA)

step3y <- yijkBase*df_wiod1$USA
step3y <- cbind(df_wiod1[, 1:2], step3y)

#Check
check= as.matrix(rowSums(step3y[, 3:dim(step3y)[2]]) / df_wiod1$USA-1)
if(sum(abs(check))>epsilon) 
   stop(paste("check not satisfied in", yr, " value=", abs(check)))

##############################
#Correcting if needed
base_y1 <- melt(base_y, id.vars=c("importer", "sector"), variable.name = "origin", value.name = "value")
base_y1 <-spread(base_y1, importer, value, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)

m.correct <- c()
for (sec in (n.sec + 2)) {
m <- base_y1 %>% filter(sector == sec)
m <- (rowSums(m[, 3:dim(m)[2]]) / sum(m[, 3:dim(m)[2]]))
m= t(matrix(replicate(n.c, m), nrow = length(m), ncol = n.c))
m.correct <- rbind(m.correct, m) 
}
m.correct <- m.correct*df_wiod1$USA

for (r in 1:(dim(check)[1])) {
  if(is.na(check[r]) == TRUE){step3y[r, 3:dim(step3y)[2]] = m.correct[r, ]}
}

if(abs(sum(rowSums(step3y[, 3:dim(step3y)[2]]) - df_wiod1$USA))>epsilon) 
   stop(paste("states' exports to countries != WIOD US exports to countries for", yr, " value=", abs(sum(step3y[, 3:dim(step3y)[2]] - df_wiod1$value))))
################

step3y <- step3y %>%
  mutate(year = yr) %>%
  select(year, importer, sector, everything()) %>%
  filter(sector == n.sec + 2) %>%
  select(-sector)
colnames(step3y) <- c("year", "importer", s.names)

step3y_1 <- rbind(step3y_1, step3y)
}
census.exp <- melt(step3y_1, id.var=c("year", "importer"), variable = "origin")
census.exp$origin <- as.character(census.exp$origin)
write.table(census.exp, file = paste("1-Intermediate_Processed_Data//census.exp.agri.proportionality.csv", sep=""), sep = ",", row.names = FALSE)

```


