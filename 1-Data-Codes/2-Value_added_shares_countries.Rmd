---
title: "Country-level value-added share"
output:
  html_notebook:
    toc: yes
    df_print: paged
    number_sections: yes    
  pdf_document:
    number_sections: yes
  word_document: default
header-includes:
- \usepackage{amsmath}
- \usepackage{amssymb}
- \usepackage{pifont}
- \usepackage{mathpazo}
---

# General information

This code calculates the share of value-added (mapped in the model to the labor share) for each country, each sector, and each year using data from WIOD. 

## Input files

1. `0-Raw_Data/regions.csv`
2. `0-Raw_Data/sectors.csv`
3. `1-Intermediate_Processed_Data/wiot_full.csv`

## Output files

1. `1-Intermediate_Processed_Data/labor_shares_countries.csv`
2. `1-Intermediate_Processed_Data//value_added_countries", yr, ".csv`

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
remove(list = ls())
```

```{r packages, warning=FALSE, include=FALSE, message=FALSE, results='hide', cache=FALSE}
# libraries
options( scipen=100, stringsAsFactors=FALSE );
## vector of libraries to be used
libs <- c( 'dplyr', 'tidyr', 'readstata13', 'haven', 'stringr', 'nleqslv', 'gdata', 'Statamarkdown', 'readxl', 'reshape2');
# Install libraries in case they are not installed
for( i in length(libs)){
  if( !(libs[i] %in% installed.packages()) ) install.packages( libs )
};
# Carga de bibliotecas
lapply( libs, require, character.only=TRUE );
```

## Importing datasets to R
```{r data, warning=FALSE}
regions <- read.csv("0-Raw_Data/regions.csv")
c.names <- regions %>% filter(status == "country")
c.names <- c.names$region

s.names <- regions %>% filter(status == "state") 
s.names <- s.names$region

n.s <- length(s.names)
n.c <- length(c.names) -1

reclass_sectors <- read.csv("0-Raw_Data/sectors.csv")
reclass_sectors <- reclass_sectors %>% 
  select(final_sector, wiod_sector) %>%
  distinct(wiod_sector, .keep_all = TRUE)

wiot <- read.csv("1-Intermediate_Processed_Data//wiot_full.csv")
wiot <- wiot %>%
  filter(row_item != 0, col_item != 0) #NOT CONSUMPTION
```


## Calculations

Gross output for each region, for each sector

$$R_{i,k}= \sum_j X_{ij,k} \quad \forall j$$

```{r gross-output, warning=FALSE}
R <- wiot %>%
  group_by(year, row_country, row_item) %>%
  mutate(val = sum(value)) %>%
  ungroup() %>%
  distinct(year, row_country, row_item, .keep_all = TRUE) %>%
  select(-col_country, -col_item, -value) %>%
  dplyr::rename(sector = row_item, region = row_country) %>%
  arrange(year, sector, region)

```

Calculating value added:

$$VA_{i,k}= R_{i,k}- \sum_s X_{j,sk} $$
```{r value-added, warning=FALSE}
#calculating value added for countries
sum.s.X_jsk <- wiot %>%
  group_by(year, col_country, col_item) %>%
  mutate(val = sum(value)) %>%
  ungroup() %>%
  distinct(year, col_country, col_item, .keep_all = TRUE) %>%
  select(-row_country, -row_item, -value) %>%
  dplyr::rename(region = col_country, sector = col_item) %>%
  arrange(year, sector, region)
VA <- R$val - sum.s.X_jsk$val
VA <- cbind(R[1:3], VA)
colnames(VA) <- c("year", "region", "sector", "value_added")

VA<-spread(VA, sector, value_added, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)
R <-spread(R, sector, val, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)
```

Calculating the share of value added in gross output:

$$\alpha_{i,k} = \frac{VA_{i,k}}{R_{i,k}}$$
```{r value-added-share, warning=FALSE}
labor_shares <- VA[, 3:dim(VA)[2]] / R[, 3:dim(R)[2]]
labor_shares[labor_shares>1] <- 1
labor_shares[labor_shares<(-1)] <- (-1)
labor_shares <- cbind(VA[, 1:2], labor_shares)

for (yr in 2000:2007) {
  VA.c <- VA %>% filter(year == yr)
  write.table(VA.c, file = paste("1-Intermediate_Processed_Data//value_added_countries", yr, ".csv", sep=""), sep = ",", row.names = FALSE)

  final <- labor_shares %>% filter(year == yr)
  write.table(final, file = paste("1-Intermediate_Processed_Data//labor_shares_countries", yr, ".csv", sep=""), sep = ",", row.names = FALSE)
}


```
