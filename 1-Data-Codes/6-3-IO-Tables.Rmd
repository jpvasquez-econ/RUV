---
title: "6-3-IO-Tables"
output:
  html_document:
    df_print: paged
  pdf_document:
    number_sections: yes
  word_document: default
header-includes:
- \usepackage{amsmath}
- \usepackage{amssymb}
- \usepackage{pifont}
- \usepackage{mathpazo}
- \newcommand{\xmark}{\ding{55}}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
remove(list = ls())
```

```{r warning=FALSE, include=FALSE, message=FALSE, results='hide', cache=FALSE}
# libraries
options( scipen=100, stringsAsFactors=FALSE );
# vector of libraries to be used
libs <- c( 'dplyr', 'tidyr', 'readstata13', 'haven', 'stringr', 'nleqslv', 'gdata', 'Statamarkdown', 'readxl', 'foreign', 'reshape2');
# Install libraries in case they are not installed
for( i in length(libs)){ 
  if( !(libs[i] %in% installed.packages()) ) install.packages( libs ) 
};
# Carga de bibliotecas
lapply( libs, require, character.only=TRUE );
```

# General Instructions

This code calculates the input output trade shares for each sector, country and year. The final output of this code, for each year separately, is a (sectors*countries)$\times$(2+sectors) matrix, where the first two columns indicate the year and country, and the rest the sectors associated with the shares of the country.    

Define $\alpha_{j,ks}$ for region j as the share of purchases of sector s that come from sector k in the total purchases of sector s (this is the input output coefficient). We have that:

$$\alpha_{j,ks}=\dfrac{\sum_{i}X_{ij,ks}}{\sum_{r}\sum_{i}X_{ij,rs}}=\dfrac{X_{j,ks}}{\sum_{r}X_{j,rs}}$$

Note that $\sum_{k}\alpha_{j,ks}=1\quad\forall j$. 

## Importing datasets to R
```{r}
n.s <- 50
n.c <- 37

#WIOD Full
wiot.full.inter <- read.dta13("1-Intermediate_Processed_Data//wiot_full.dta")
#Transforming WIOD sectors to 1-14 CDP sectors
wiot.full.inter <- wiot.full.inter %>%
  mutate(col_country= recode(col_country, "ROM"="ROU")) %>%
  mutate(row_country= recode(row_country, "ROM"="ROU")) %>%
  filter(col_country != "LVA" & col_country != "LUX" & col_country != "MLT") %>%
  filter(row_country != "LVA" & row_country != "LUX" & row_country != "MLT") 
wiot.full.inter <- wiot.full.inter %>%
  mutate(row_item= recode(row_item, '1'=14L, '2'=4L, '3'=1L, '4'=2L, '5'=2L, '6'=3L, '7'=3L, '8'=4L, '9'=5L, '10'=6L, '11'=7L, '12'=8L, '13'=9L, '14'=10L, '15'=11L, '16'=12L, '17'=0L, '18'=13L, '19'=13L, '20'=13L, '21'=13L, '22'=13L, '23'=13L, '24'=13L, '25'=13L, '26'=13L, '27'=13L, '28'=13L, '29'=13L, '30'=13L, '31'=0L, '32'=13L, '33'=13L, '34'=13L, '35'=0L, '36'=0L, '37'=0L, '38'=0L, '39'=0L, '40'=0L, '41'=0L, '42'=0L )) %>%
  mutate(col_item= recode(col_item, '1'=14L, '2'=4L, '3'=1L, '4'=2L, '5'=2L, '6'=3L, '7'=3L, '8'=4L, '9'=5L, '10'=6L, '11'=7L, '12'=8L, '13'=9L, '14'=10L, '15'=11L, '16'=12L, '17'=0L, '18'=13L, '19'=13L, '20'=13L, '21'=13L, '22'=13L, '23'=13L, '24'=13L, '25'=13L, '26'=13L, '27'=13L, '28'=13L, '29'=13L, '30'=13L, '31'=0L, '32'=13L, '33'=13L, '34'=13L, '35'=0L, '36'=0L, '37'=0L, '38'=0L, '39'=0L, '40'=0L, '41'=0L, '42'=0L )) %>%
  filter(col_item!=0 & row_item!=0) 
wiot.full.inter <- wiot.full.inter %>%
  arrange(year, row_country, col_country, row_item, col_item) %>%
  group_by(year, row_country, col_country, row_item, col_item) %>% #aggregating repeated r-c sequence
  mutate(value1= sum(value)) %>%
  ungroup() %>%
  distinct(year, row_country, col_country, row_item, col_item, .keep_all = TRUE) %>%
  select(-value) %>%
  dplyr::rename(value=value1)

c.names <- unique(wiot.full.inter$row_country)
c.names <- c.names[1:37]
c.names <- c("USA", c.names)

```

#Calculating input-output matrices
```{r}
num <- wiot.full.inter %>%
  group_by(year, col_country, col_item, row_item) %>%
  mutate(val= sum(value)) %>%
  ungroup() %>%
  distinct(year, col_country, col_item, row_item, .keep_all = TRUE) %>%
  select(-row_country, -value) %>%
  dplyr::rename(region=col_country, sector_o=row_item, sector_d=col_item)

num <-spread(num, sector_o, val, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)

io.shares <- num[, 4:dim(num)[2]] / rowSums(num[, 4:dim(num)[2]])
io.shares <- cbind(num[, 1:3], io.shares)

io <- melt(io.shares, id.vars=c("year", "region", "sector_d"), variable.name="sector_o", value.name = "share")
id.tot <- data.frame(c.names)
id.tot$id <- c(1:(n.c+1))
colnames(id.tot) <- c("regions", "id")

io <- io %>%
  left_join(id.tot, by=c('region'='regions')) %>%
  mutate(region=id) %>%
  select(-id) %>%
  arrange(year, region, sector_d)

io <-spread(io, sector_d, share, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)
io <- io %>% 
  dplyr::rename(sector=sector_o) %>%
  left_join(id.tot, by=c('region'='id')) %>%
  mutate(region=regions) %>%
  select(-regions)

# #check: 8x38=304
# colSums(io[, 4:dim(io)[2]])


for (yr in 2000:2007) {
  final <- io %>%
    filter(year==yr)
  write.table(final, file = paste("1-Intermediate_Processed_Data//io_shares", yr, ".csv", sep=""), sep = ",", row.names = FALSE)
}


```

