---
title: "WIOD trade flows between countries"
output:
  html_notebook:
    toc: yes
    df_print: paged
    number_sections: yes    
  pdf_document:
    number_sections: yes
  word_document: default
header-includes:
- \usepackage{amsmath}
- \usepackage{amssymb}
- \usepackage{pifont}
- \usepackage{mathpazo}
---

# General information

This code calculates the sector-country bilateral trade flows $X_{ij,k}$ between countries using data from WIOD. 

## Input files

1. `0-Raw_Data/regions.csv`
2. `0-Raw_Data/sectors.csv`
3. `1-Intermediate_Processed_Data/wiot_full.csv`

## Output files

One CSV file per year with root: `1-Intermediate_Processed_Data/country_country_step_.csv`

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
remove(list = ls())
```

```{r packages, warning=FALSE, include=FALSE, message=FALSE, results='hide', cache=FALSE}
# libraries
options( scipen=100, stringsAsFactors=FALSE );
# vector of libraries to be used
libs <- c( 'dplyr', 'tidyr', 'readstata13', 'haven', 'stringr', 'nleqslv', 'gdata', 'Statamarkdown', 'read_excel', 'readxl');
# Install libraries in case they are not installed
for( i in length(libs)){ 
if( !(libs[i] %in% installed.packages()) ) install.packages( libs ) 
};
# load library
lapply( libs, require, character.only=TRUE );
```

# Bilateral trade matrix


## Importing datasets to R

```{r data}
regions <- read.csv("0-Raw_Data/regions.csv")
c.names <- regions %>% filter(status == "country")
c.names <- c.names$region

s.names <- regions %>% filter(status == "state") 
s.names <- s.names$region

n.s <- length(s.names)
n.c <- length(c.names) -1

reclass_sectors <- read.csv("0-Raw_Data/sectors.csv")
reclass_sectors <- reclass_sectors %>% 
  select(final_sector, wiod_sector) %>%
  distinct(wiod_sector, .keep_all = TRUE)

# WIOD 
wiot <- read.csv("1-Intermediate_Processed_Data//wiot_full.csv")
```

## Trade flows between countries

```{r}
#colapsing by origin sectors 
wiot <- wiot %>%
  group_by(year, row_country, col_country, row_item) %>%
  mutate(val = sum(value)) %>%
  ungroup() %>%
  distinct(year, row_country, col_country, row_item, .keep_all = TRUE) %>%
  select(-value, -col_item) %>%
  dplyr::rename(value = val)
colnames(wiot) <- c("year", "exporter", "importer", "sector", "value")  
wiot <-spread(wiot, exporter, value, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)
wiot <- wiot %>% arrange(year, sector, importer)
wiot <- data.frame(wiot)

for (yr in 2000:2007) {
  Step1 <- wiot %>%
    filter(year == yr) %>%
    select(year, importer, sector, everything())
  #Exporting
  write.table(Step1, file = paste("1-Intermediate_Processed_Data//country_country_step_", yr,".csv", sep=""), sep = ",", row.names = FALSE)
}
```



