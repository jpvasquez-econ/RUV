---
title: "Gravity for Agriculture: Inputs for the System"
author: "JP"
date: "April 2, 2020"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##General description

This file generates the inputs of the gravity system that we take to solve in matlab.

Start with the standard gravity equation,
$$
X_{ij}=\left(\frac{w_{i}\tau_{ij}}{P_{j}}\right)^{-\varepsilon}X_{j}.
$$
Define: $\Pi_{i}^{-\varepsilon}=\sum_{j}\tau_{ij}^{-\varepsilon}P_{j}^{\varepsilon}X_{j}$. Let $\tilde{P}_{j}\equiv P_{j}^{-\varepsilon}$ and $\tilde{\Pi}_{i}\equiv\Pi_{i}^{-\varepsilon}, and \tilde{\tau}_{ij}\equiv\tau_{ij}^{-\varepsilon}$. Then we have the system
$$
\tilde{P}_{j}=\sum_{i}\tilde{\tau}_{ij}\tilde{\Pi}_{i}^{-1}Y_{i} \nonumber
$$

$$
\tilde{\Pi}_{i}=\sum_{j}\tilde{\tau}_{ij}\tilde{P}_{j}^{-1}X_{j}
$$

So far this is the same we had before. Given $\{X_{j}\}$ and $\{Y_{i}\}$ and $\{\tilde{\tau}_{ij}\}$ then from here one can get $\{\tilde{P}_{j}\}$ and $\{\tilde{\Pi}_{i}\}$. Then we get $\{X_{ij}\}$ from 
$$
X_{ij}=\tilde{\tau}_{ij}\tilde{\Pi}_{i}^{-1}\tilde{P}_{j}^{-1}Y_{i}X_{j} \label{eq:Xij}
$$
We don't know $\{X_{j}\}_{j\in US}$. But we know: 1) $\{X_{ij}\}\quad\forall i,j\notin US$ (from WIOD), 2) $\{X_{ij}\}\quad\forall i\notin US\;or\:j\notin US$ (from CENSUS). Rearranging the system in order to separate the cases of $\{X_{j}\}_{j\not\notin US}$ vs. $\{X_{j}\}_{j\in US}$ (and replacing $\tilde{\tau}_{ij}=\tilde{\Pi}_{i}\tilde{P}_{j}Y_{i}^{-1}X_{j}^{-1}X_{ij}$) we get the new system
$$
\tilde{P}_{j}=\sum_{i}\tilde{\tau}_{ij}\tilde{\Pi}_{i}^{-1}Y_{i},\quad\forall j\in US \nonumber
$$
$$
\tilde{P}_{j}=\sum_{i\in US}\tilde{P}_{j}X_{j}^{-1}X_{ij}+\sum_{i\notin US}\tilde{\tau}_{ij}\tilde{\Pi}_{i}^{-1}Y_{i},\quad\forall j\notin US \nonumber
$$
$$
\tilde{\Pi}_{i}=\sum_{j\notin US}\tilde{\tau}_{ij}\tilde{P}_{j}^{-1}X_{j}+\tilde{\Pi}_{i}Y_{i}^{-1}\underbrace{\sum_{j\in US}X_{ij}}_{Y_{i}-\sum_{j\notin US}X_{ij}},\quad i\in US \nonumber
$$
$$
\tilde{\Pi}_{i}=\sum_{j\notin US}\tilde{\tau}_{ij}\tilde{P}_{j}^{-1}X_{j}+\sum_{j\in US}\tilde{\Pi}_{i}Y_{i}^{-1}X_{ij},\quad i\notin US \nonumber
$$

==Until here everything is the same as before. New notation starts below==

One can split the first equation of the previous system into the cases $i\in US$ vs. $i \notin US$. Define: $\lambda_{NotUS,j}\equiv\sum_{i\notin US}X_{ij}/X_{j}\quad\forall j\notin US$, $\chi_{i,NotUS}\equiv\sum_{j\notin US}X_{ij}/Y_{i}\quad\forall i$

Then, the system becomes:
$$
\tilde{P}_{j}=\sum_{i}\tilde{\tau}_{ij}\tilde{\Pi}_{i}^{-1}Y_{i},\quad\forall j\in US \nonumber 
$$

$$
\lambda_{NotUS,j}\tilde{P}_{j}=\sum_{i\notin US}\tilde{\tau}_{ij}\tilde{\Pi}_{i}^{-1}Y_{i},\quad \forall j \notin US \nonumber
$$
$$
\chi_{i,NotUS}\tilde{\Pi}_{i}=\sum_{j\notin US}\tilde{\tau}_{ij}\tilde{P}_{j}^{-1}X_{j},\quad\forall i \label{eq:sys}
$$
which can now be solved. In order to do so, first define:                   $\lambda_{state,j}=(1,.,1)'$, $\lambda_{country,j}=(\lambda_{NotUS,51},.,\lambda_{NotUS,87} )'$,$\chi_{state,i}=(\chi_{1,NotUS},.,\chi_{50,NotUS})'$, $\chi_{country,i}=(\chi_{51,NotUS},.,\chi_{87,NotUS} )'$, $\lambda=(\lambda_{state,j},\lambda_{country,j},\chi_{state,i},\chi_{country,i})'$, $P_{state,j}=(\tilde{P}_{1},...,\tilde{P}_{50})'$, $P_{country,j}=(\tilde{P}_{51},.,\tilde{P}_{87})'$,  $\Pi_{state,i}=(\tilde{\Pi}_{1},...,\tilde{\Pi}_{50})'$, $\Pi_{country,i}=(\tilde{\Pi}_{51},.,\tilde{\Pi}_{87})'$,                          $S=\left(P_{state,j},P_{country,j},\Pi_{state,i},\Pi_{country,i}\right)'$ and with some abuse of notation, $S^{-1}=\left(P_{state,j}^{-1},P_{country,j}^{-1},\Pi_{state,i}^{-1},\Pi_{country,i}^{-1}\right)'$

Also, define:
$$
\boldsymbol{\left(\mathcal{T} Y\right)_{}}=\left(\begin{array}{ccc}
\tilde{\tau}_{s_{1}s_{1}}Y_{s_{1}} & \cdots & \tilde{\tau}_{s_{50}s_{1}}Y_{s_{50}} & \tilde{\tau}_{s_{51}s_{1}}Y_{s_{51}} & \cdots & \tilde{\tau}_{s_{87}s_{1}}Y_{s_{87}}\\
\vdots & \ddots & \vdots & \vdots & \ddots & \vdots\\
\tilde{\tau}_{s_{1}s_{50}}Y_{s_{1}} & \cdots & \tilde{\tau}_{s_{50}s_{50}}Y_{s_{50}} & \tilde{\tau}_{s_{51}s_{50}}Y_{s_{51}} & \cdots & \tilde{\tau}_{s_{87}s_{50}}Y_{s_{87}} \\\
0 & \cdots & 0 & \tilde{\tau}_{s_{51}s_{51}}Y_{s_{51}} & \cdots & \tilde{\tau}_{s_{87}s_{51}}Y_{s_{87}}\\
\vdots & \ddots & \vdots & \vdots & \ddots & \vdots\\
0 & \cdots & 0 & \tilde{\tau}_{s_{51}s_{87}}Y_{s_{51}} & \cdots & \tilde{\tau}_{s_{87}s_{87}}Y_{s_{87}}
\end{array}\right)= \left(\begin{array}{cc}
\left(\mathcal{T} Y\right)_{ss} & \left(\mathcal{T} Y\right)_{sc}\\
0 & \left(\mathcal{T} Y\right)_{cc}
\end{array}\right), 
$$
$$
\boldsymbol{\left(\mathcal{T} X\right)_{}}=\left(\begin{array}{ccc}
0 & \cdots & 0 & \tilde{\tau}_{s_{1}s_{51}}X_{s_{51}} & \cdots & \tilde{\tau}_{s_{1}s_{87}}X_{s_{87}}\\
\vdots & \ddots & \vdots & \vdots & \ddots & \vdots\\
0 & \cdots & 0 & \tilde{\tau}_{s_{50}s_{51}}X_{s_{51}} & \cdots & \tilde{\tau}_{s_{50}s_{87}}X_{s_{87}} \\\
0 & \cdots & 0 & \tilde{\tau}_{s_{51}s_{51}}X_{s_{51}} & \cdots & \tilde{\tau}_{s_{51}s_{87}}X_{s_{87}}\\
\vdots & \ddots & \vdots & \vdots & \ddots & \vdots\\
0 & \cdots & 0 & \tilde{\tau}_{s_{87}s_{51}}X_{s_{51}} & \cdots & \tilde{\tau}_{s_{87}s_{87}}X_{s_{87}}
\end{array}\right)= \left(\begin{array}{cc}
0 & \left(\mathcal{T} X\right)_{sc}\\
0 & \left(\mathcal{T} X\right)_{cc}
\end{array}\right)
$$


Then, the system can be written as:
$$
\lambda\circ S=\left(\begin{array}{cccc}
0 & 0 & \left(\mathcal{T} Y\right)_{ss} & \left(\mathcal{T} Y\right)_{sc}\\
0 & 0 & 0 & \left(\mathcal{T} Y\right)_{cc}\\
0 & \left(\mathcal{T} X\right)_{sc} & 0 & 0\\
0 & \left(\mathcal{T} X\right)_{cc} & 0 & 0
\end{array}\right)\cdot S^{-1}
$$

or as: 
$$
\lambda\circ S=B\cdot S^{-1}
$$
where $\circ$ is the element-by-element product and $B$ is the big matrix. Given $\left\{ X_{j} \; \forall j \notin US\right\}$, $\left\{ X_{ij} \;  for \; i \notin US \; and \; for \; j \in US\right\}$, $\left\{ Y_{i}\right\}$  and $\left\{ \tilde{\tau}_{ij}\right\}$,  we can get $\left\{ \tilde{P}_{j}\right\}$  and $\left\{ \tilde{\Pi}_{i}\right\}$. The solution for $\left\{ \tilde{P}_{j}, \tilde{\Pi}_{i} \right\}$ is unique up to a constant. This indeterminacy requires a normalization. We thus impose $\tilde{P}_{1}=100$. Then we compute $\left\{ X_{ij}\right\}$  from $X_{ij}=\tilde{\tau}_{ij}\tilde{\Pi}_{i}^{-1}\tilde{P}_{j}^{-1}Y_{i}X_{j}.$


How to compute $\{X_{ij}\}$? We cannot simply apply equation $\eqref{eq:Xij}$ when $j\in US$ because we do not know $\{X_{j}\}_{j\in US}$. But from equation $\eqref{eq:Xij}$ we know that
$$
X_{j}=\tilde{\tau}_{ij}^{-1}\tilde{\Pi}_{i}\tilde{P}_{j}Y_{i}^{-1}X_{ij}
$$
Summing across $i\notin US$ we have:
$$
\sum_{i\notin US}X_{j}=N_{c}X_{j}=\tilde{P}_{j}\sum_{i\notin US}\tilde{\tau}_{ij}^{-1}\tilde{\Pi}_{i}Y_{i}^{-1}X_{ij},
$$
where $N_{c}$ is the number of countries (excluding the US). Thus, $for j\in US$ we impute expenditure from:
$$
\hat{X}_{j}=\dfrac{1}{N_{c}}\tilde{P}_{j}\sum_{i\notin US}\tilde{\tau}_{ij}^{-1}\tilde{\Pi}_{i}Y_{i}^{-1}X_{ij},
$$
and then proceed to impute $X_{ij}$ for $i,j\in US$ from $\eqref{eq:Xij}$. 


##Data and Libraries
```{r warning=FALSE, include=FALSE, message=FALSE, results='hide', cache=FALSE}
# libraries
remove(list = ls())
options( scipen=100, stringsAsFactors=FALSE );
# vector of libraries to be used
libs <- c( 'dplyr', 'readstata13', 'nleqslv', 'haven', 'tidyverse', 'optimx', 'optimization',
           'optimx', 'tidyr', 'readxl', 'Rcpp', 'DEoptim', 'parallel', 'reshape2');
# Install libraries in case they are not installed
for( i in length(libs)){ 
  if( !(libs[i] %in% installed.packages()) ) install.packages( libs ) 
};
# Carga de bibliotecas
lapply( libs, require, character.only=TRUE );
```

```{r warning=FALSE, include=FALSE, message=FALSE, results='hide', cache=FALSE}
# OPTIONS AND LIBRARIES
options( scipen=100 );
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#example vs real
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
## real
# number of countries (n.c) and number of states (n.s)
n.c <- 37; 
n.s <- 50; 
WIOD.base <- read.dta13( file="2-Final_Data//WIOD_countries.dta" )
data_gravity_agriculture.base <- read.csv( file="2-Final_Data//data_agriculture.csv", header=TRUE, sep="," )
#state level imports and exports
CENSUS.2 <- read.csv("1-Intermediate_Processed_Data//census.agri.proportionality.csv")
wiot.full <- read.dta13("1-Intermediate_Processed_Data//wiot_full.dta")
wiot.full=data.frame(wiot.full)
wiot.full <- wiot.full %>% 
  filter(year>=2000, col_country!="LUX", col_country!="LVA", col_country!="MLT", row_country!="LUX", row_country!="LVA", row_country!="MLT") %>% #since distances are available from that year on
  mutate(row_country= ifelse(row_country=="ROM", "ROU", row_country)) %>%
  mutate(col_country= ifelse(col_country=="ROM", "ROU", col_country)) 


# ##################example  (do not run creation of dist.matrix in section 3)
# example <- read_excel( "2-Final_Data//ejemplo.xlsx")
# WIOD.base <- WIOD.base [1:3, 1:7]
# WIOD.base$value_AUS[2] <- example$`X_{ij}`[1]
# WIOD.base$value_AUS[3] <- example$`X_{ij}`[2]
# WIOD.base$value_AUT[2] <- example$`X_{ij}`[5]
# WIOD.base$value_AUT[3] <- example$`X_{ij}`[6]
# WIOD.base$value_AUS[1] <- example$`X_{ij}`[3] + example$`X_{ij}`[4]
# WIOD.base$value_AUT[1] <- example$`X_{ij}`[7] + example$`X_{ij}`[8]
# WIOD.base$value_USA[2] <- example$`X_{ij}`[9] + example$`X_{ij}`[13]
# WIOD.base$value_USA[3] <- example$`X_{ij}`[10] + example$`X_{ij}`[14]
# WIOD.base$value_USA[1] <- NA
# WIOD.base <- WIOD.base %>%
#   mutate(sector=14)
# data_gravity_agriculture.base <- data_gravity_agriculture.base %>%
#   filter(year==2000, (iso_o=="Alabama" | iso_o=="Alaska" | iso_o=="AUS" | iso_o=="AUT"), (iso_d=="Alabama" | iso_d=="Alaska" | iso_d=="AUS" | iso_d=="AUT") ) %>%
#   mutate(X_j= ifelse(iso_d=="AUS", example$X_j[1], X_j)) %>%
#   mutate(X_j= ifelse(iso_d=="AUT", example$X_j[2], X_j)) %>%
#   mutate(Y_i= ifelse(iso_o=="AUS", example$Y_i[1], Y_i)) %>%
#   mutate(Y_i= ifelse(iso_o=="AUT", example$Y_i[5], Y_i)) %>%
#   mutate(Y_i= ifelse(iso_o=="Alabama", example$Y_i[9], Y_i)) %>%
#   mutate(Y_i= ifelse(iso_o=="Alaska", example$Y_i[13], Y_i))
# data_gravity_agriculture.base$Y_i <- as.numeric((data_gravity_agriculture.base$Y_i))
# data_gravity_agriculture.base$X_j <- as.numeric(as.character(data_gravity_agriculture.base$X_j))
# dist.matrix <- matrix(c(example$phi_ij[11], example$phi_ij[12], example$phi_ij[9], example$phi_ij[10], example$phi_ij[15], example$phi_ij[16], example$phi_ij[13], example$phi_ij[14], example$phi_ij[3], example$phi_ij[4], example$phi_ij[1], example$phi_ij[2], example$phi_ij[7], example$phi_ij[8], example$phi_ij[5], example$phi_ij[6]), nrow=4, ncol=4)
# dist.matrix <- data.frame(dist.matrix)
# colnames(dist.matrix) <- c("1", "2", "3", "4")
# dist.matrix <- matrix(unlist(dist.matrix), ncol = 4, byrow = TRUE)
# n.c <- 2; 
# n.s <- 2; 
# yr=2000
# CENSUS.2 <- CENSUS.2 %>%
#   filter(year==2000, (origin=="Alabama" | origin=="Alaska"), (importer=="AUS" | importer=="AUT")) %>%
#   mutate(value= ifelse(origin=="Alabama" & importer=="AUS", example$`X_{ij}`[9], value)) %>%
#   mutate(value= ifelse(origin=="Alabama" & importer=="AUT", example$`X_{ij}`[10], value)) %>%
#   mutate(value= ifelse(origin=="Alaska" & importer=="AUS", example$`X_{ij}`[13], value)) %>%
#   mutate(value= ifelse(origin=="Alaska" & importer=="AUT", example$`X_{ij}`[14], value))
# wiot.full <- wiot.full %>%
#   filter(year==2000, (row_country=="AUS" | row_country=="AUT" | row_country=="USA"), (col_country=="AUS" | col_country=="AUT" | col_country=="USA"), row_item==1, col_item==1) %>%
#   mutate(value= ifelse(row_country=="AUS" & col_country=="AUS", WIOD.base$value_AUS[2], value)) %>%
#   mutate(value= ifelse(row_country=="AUS" & col_country=="AUT", WIOD.base$value_AUS[3], value)) %>%
#   mutate(value= ifelse(row_country=="AUS" & col_country=="USA", WIOD.base$value_AUS[1], value)) %>%
#   mutate(value= ifelse(row_country=="AUT" & col_country=="AUS", WIOD.base$value_AUT[2], value)) %>%
#   mutate(value= ifelse(row_country=="AUT" & col_country=="AUT", WIOD.base$value_AUT[3], value)) %>%
#   mutate(value= ifelse(row_country=="AUT" & col_country=="USA", WIOD.base$value_AUT[1], value)) %>%
#   mutate(value= ifelse(row_country=="USA" & col_country=="AUS", WIOD.base$value_USA[2], value)) %>%
#   mutate(value= ifelse(row_country=="USA" & col_country=="AUT", WIOD.base$value_USA[3], value)) %>%
#   mutate(value= ifelse(row_country=="USA" & col_country=="USA", WIOD.base$value_USA[1], value))
# CENSUS.2$value <- as.numeric(CENSUS.2$value) 
# ##############################

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

for (yr in 2000:2007) {
# 1. LOAD DATA
WIOD<-WIOD.base
## path
## WIOD US
us.us.wiod <- WIOD %>% 
  filter( year==yr, sector==14 ) %>% 
  filter( importer_country=='USA' ) %>% 
  select( value_USA );
us.us.wiod <- as.numeric(us.us.wiod[1]);
# US exports
us.exports.wiod <- WIOD %>% 
  filter( year==yr, sector==14 ) %>% 
  filter( importer_country!='USA' ) %>% 
  select( value_USA ); 
#us.exports.wiod <-sum(us.exports.wiod)
# US imports
us.imports.wiod <- WIOD %>% 
  filter( year==yr, sector==14 ) %>% 
  filter( importer_country=='USA' ) %>% 
  select( -year, -value_USA, -sector, -importer_country, -importer  ) ;
#us.imports.wiod <-sum(us.imports.wiod)
## WIOD
WIOD <- WIOD.base %>% 
  filter( year==yr, sector==14 ) %>% 
  filter( importer_country!='USA' ) %>% 
  select( -year, -value_USA, -sector, -importer_country, -importer  ) ;
## Gravity data csv format with comma as the separator
data_gravity_agriculture <- data_gravity_agriculture.base %>% 
  filter( year==yr ) %>% 
  select( -year ) %>% 
  mutate( iso_o=as.character(iso_o), iso_d=as.character(iso_d) ) %>% 
  mutate( len_o=ifelse(nchar(iso_o)<4, 'COUNTRY', 'STATE'), 
          len_d=ifelse(nchar(iso_d)<4, 'COUNTRY', 'STATE') );

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 2. NUMBER STATES AND COUNTRIES
# States
id.states <- data_gravity_agriculture %>% 
  filter( len_o=='STATE' ) %>% 
  select( iso_o ) %>% 
  distinct( iso_o ) %>% 
  arrange( iso_o ) %>% 
  mutate( id=row_number() ) %>% 
  dplyr::rename( region=iso_o ) %>% 
  select( id, region );
# Countries
id.countries <- data_gravity_agriculture %>% 
  filter( len_o=='COUNTRY' ) %>% 
  select( iso_o ) %>% 
  distinct( iso_o ) %>% 
  arrange( iso_o ) %>% 
  mutate( id=n.s+row_number() ) %>% 
  dplyr::rename( region=iso_o ) %>% 
  select( id, region );
# Total
id.total <- rbind( id.states, id.countries );
t(id.total)

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 3. ELEMENTARY MATRICES FOR KRONECKER PRODUCTS

# 3.1. DISTANCE MATRIX
dist.matrix <- data_gravity_agriculture %>% 
  select( iso_o, iso_d, dist ) %>% 
  left_join( y=id.total, by=c('iso_o'='region') ) %>% 
  dplyr::rename( id_o=id ) %>% 
  left_join( y=id.total, by=c('iso_d'='region') ) %>% 
  dplyr::rename( id_d=id ) %>% 
  select( id_o, id_d, dist ) %>% 
  arrange( id_o, id_d ) %>% 
  spread( key=id_d, value=dist );
dist.matrix <- as.matrix( dist.matrix[,2:(n.c+n.s+1)] );

#Phis 
#we use the coefficients from 4-4-Country_Gravity_Services_WIOD.
#own dummy=6.5, Distance elasticity=0.7
phi<-diag(x = 6.5, n.c+n.s, n.c+n.s);
phi<-exp(phi);
phi<-phi/dist.matrix^0.7; 
dist.matrix<-phi

# 3.2. GDP VECTOR 
gdp.vector <- data_gravity_agriculture %>% 
  select( iso_o, Y_i ) %>% 
  distinct( iso_o, .keep_all=TRUE ) %>% 
  left_join( y=id.total, by=c('iso_o'='region') ) %>% 
  select( id, Y_i ) %>% 
  arrange( id );
gdp.vector <- as.vector( gdp.vector$Y_i );

# 3.3. EXPENDITURE VECTOR 
exp.vector <- data_gravity_agriculture %>% 
  select( iso_d, X_j ) %>% 
  distinct( iso_d, .keep_all=TRUE ) %>% 
  left_join( y=id.total, by=c('iso_d'='region') ) %>% 
  select( id, X_j ) %>% 
  arrange( id );
exp.vector <- as.vector( exp.vector$X_j );

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 4. BIG MATRICES

# 4.1 Matrices X and Y (repeat gdp and expenditure vectors in ns+nc rows)
mat.Y <- matrix( data=rep(gdp.vector, (n.s+n.c)), nrow=(n.s+n.c), byrow=TRUE );
mat.X <- matrix( data=rep(exp.vector, (n.s+n.c)), nrow=(n.s+n.c), byrow=TRUE );

# 4.2 Submatrices
##phi*Y submatrices
phi.Y.ss <- dist.matrix[(1:n.s), (1:n.s)] * mat.Y[(1:n.s), (1:n.s)];
phi.Y.sc <- dist.matrix[(1:n.s), ((n.s+1):(n.s+n.c))] * mat.Y[(1:n.s), ((n.s+1):(n.s+n.c))];
#phi.Y.cs <- dist.matrix[((n.s+1):(n.s+n.c)), (1:n.s)] * mat.Y[((n.s+1):(n.s+n.c)), (1:n.s)];
phi.Y.cc <- dist.matrix[((n.s+1):(n.s+n.c)), ((n.s+1):(n.s+n.c))] * 
  mat.Y[((n.s+1):(n.s+n.c)), ((n.s+1):(n.s+n.c))];
## phi*X submatrices
#phi.X.ss <- dist.matrix[(1:n.s), (1:n.s)] * mat.X[(1:n.s), (1:n.s)];
phi.X.sc <- dist.matrix[(1:n.s), ((n.s+1):(n.s+n.c))] * mat.X[(1:n.s), ((n.s+1):(n.s+n.c))];
#phi.X.cs <- dist.matrix[((n.s+1):(n.s+n.c)), (1:n.s)] * mat.X[((n.s+1):(n.s+n.c)), (1:n.s)];
phi.X.cc <- dist.matrix[((n.s+1):(n.s+n.c)), ((n.s+1):(n.s+n.c))] * 
  mat.X[((n.s+1):(n.s+n.c)), ((n.s+1):(n.s+n.c))];


#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 5. WIOD MATRIX AND RELATED QUANTITIES

## 5.1 WIOD matrix (d,o)
wiod.matrix <- as.matrix( WIOD );

## 5.2 lambda vector
### imports and exports of countries to countries
exports.to.countries <- as.matrix( apply(X=wiod.matrix, MARGIN=2, FUN=sum) )

wiot.full.c <- wiot.full %>%
  filter(col_country!="USA", row_country!="USA", col_item==1) %>%
  group_by(year, col_country) %>%
  mutate(consumption= sum(value)) %>%
  ungroup() %>%
  distinct(year, col_country, .keep_all = TRUE) 
wiot.full.c <- wiot.full.c %>%
  filter(year==yr) %>%
  arrange(col_country)
imports.from.countries <- matrix(wiot.full.c$consumption);


### shares of imports and exports of countries
X_c <- as.matrix( exp.vector[(n.s+1):(n.s+n.c)] );
Y_s <- as.matrix( gdp.vector[(1):(n.s)] );
Y_c <- as.matrix( gdp.vector[(n.s+1):(n.s+n.c)] );

state.exports.to.countries <- CENSUS.2 %>%
  filter(year==yr) %>%
  group_by(origin) %>%
  mutate(exp= sum(value)) %>%
  ungroup() %>%
  distinct(origin, .keep_all = TRUE) %>%
  arrange(origin)
state.exports.to.countries <- matrix(state.exports.to.countries$exp)


### lambdas and chis
lambda.cj <- imports.from.countries/ X_c;
chi.si <- state.exports.to.countries/Y_s;
chi.ci <- exports.to.countries/Y_c;
### lambda vector
ones.ns <- matrix( data=rep(1, n.s), nrow=n.s, ncol=1 );
lambda_vector <- rbind( ones.ns, lambda.cj, chi.si, chi.ci );

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
## 6.1 Big zeros matrices
zeros.nc.ns <- matrix( data=rep(0, n.c*n.s), nrow=n.c, ncol=n.s );
zeros.ns.ns <- matrix( data=rep(0, n.s*n.s), nrow=n.s, ncol=n.s );
zeros.big <- matrix( data=rep(0, (n.s+n.c)*(n.s+n.c)), nrow=(n.s+n.c), ncol=(n.s+n.c) );

## 6.2 GIANT MATRIX 
### Block for system 10
block.10 <- rbind( cbind(phi.Y.ss, phi.Y.sc),
                   cbind(zeros.nc.ns, phi.Y.cc) );
### Block for system 11
block.11 <- rbind( cbind(zeros.ns.ns, phi.X.sc),
                   cbind(zeros.nc.ns, phi.X.cc) );
### Relevant matrix
BIG.MAT <- rbind( cbind(zeros.big, block.10),
                  cbind(block.11, zeros.big) );

### Saving input matrices for the matlab code
write.csv(BIG.MAT, file= paste('1-Intermediate_Processed_Data//agric_mat_B_',yr, '.csv', sep= ""), row.names=FALSE, na="" );
write.csv(lambda_vector, file= paste('1-Intermediate_Processed_Data//agric_vec_lambda_',yr, '.csv', sep= ""), row.names=FALSE, na="" );
}
```
