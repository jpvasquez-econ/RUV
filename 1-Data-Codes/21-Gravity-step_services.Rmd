---
title: "Creating bilateral trade in services with gravity solution"
output:
  html_notebook:
    toc: yes
    df_print: paged
    number_sections: yes    
  pdf_document:
    number_sections: yes
header-includes:
- \usepackage{amsmath}
- \usepackage{amssymb}
- \usepackage{pifont}
- \usepackage{mathpazo}
---

# General information

This takes the solution of the gravity system and computes the bilateral trade in services among states and between states and other countries. 

Given $\{X_{j}\}$ and $\{Y_{i}\}$ and $\{\tilde{\tau}_{ij}\}$, and the solutions for $\{\tilde{P}_{j}\}$ and $\{\tilde{\Pi}_{i}\}$ we get $\{X_{ij}\}$ from:

$$
X_{ij}=\tilde{\tau}_{ij}\tilde{\Pi}_{i}^{-1}\tilde{P}_{j}^{-1}Y_{i}X_{j}
$$

## Input files

1. `0-Raw_Data/regions.xlsx`
2. `0-Raw_Data/sectors.xlsx`
3. `1-Intermediate_Processed_Data/country_country_step_`
4. `1-Intermediate_Processed_Data/data_agriculture.csv`
5. `1-Intermediate_Processed_Data//data_services.csv`
6. Coefficients from `Country_Gravity_WIOD`
7. `1-Intermediate_Processed_Data/io_shares`
8. `1-Intermediate_Processed_Data/labor_shares_countries`

## Output files
 
1. `1-Intermediate_Processed_Data//Xij_matrix_services_`


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##General description

This file generates the inputs of the gravity system that we take to solve in matlab.

##Data and Libraries
```{r warning=FALSE, include=FALSE, message=FALSE, results='hide', cache=FALSE}
# libraries
remove(list = ls())
options( scipen=100, stringsAsFactors=FALSE );
# vector of libraries to be used
libs <- c( 'dplyr', 'readstata13', 'nleqslv', 'haven', 'tidyverse', 'optimx', 'optimization',
           'optimx', 'tidyr', 'readxl', 'Rcpp', 'DEoptim', 'parallel');
# Install libraries in case they are not installed
for( i in length(libs)){ 
  if( !(libs[i] %in% installed.packages()) ) install.packages( libs ) 
};
# Carga de bibliotecas
lapply( libs, require, character.only=TRUE );
```

##Data 

```{r}
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# Data
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#COEFFIENTS FROM REGRESSIONS
own_dummy<- 7.357
dist_coeff<- -0.376

# number of countries (n.c) and number of states (n.s)
regions <- read_excel("0-Raw_Data/regions.xlsx")
c.names <- regions %>% filter(status=="country", region!="USA")
c.names <- c.names$region

s.names <- regions %>% filter(status=="state") 
s.names <- s.names$region

n.s <- length(s.names)
n.c <- length(c.names)

WIOD.base <- c()
for (yr in 2000:2007) {
  wiot <- country.country <- read.csv(paste('1-Intermediate_Processed_Data//country_country_step_', yr, '.txt', sep= ""), header = TRUE, sep = ",", dec = ".") 
  WIOD.base <- rbind(WIOD.base, wiot)
}

data_gravity_services.base <- read.csv( file="1-Intermediate_Processed_Data//data_services.csv", header=TRUE, sep="," )

#### epsilon to check between calculations
epsilon<-0.01;

sector.file <- read_excel("0-Raw_Data/sectors.xlsx")
n.sec <- length(unique(sector.file$final_sector)) -3
```

##Loop for years

```{r warning=FALSE, message=FALSE}
# OPTIONS AND LIBRARIES
options( scipen=100 );

for (yr in 2000:2007) {
# 1. LOAD DATA
WIOD<-WIOD.base
## path
## WIOD US
us.us.wiod <- WIOD %>% 
  filter( year==yr, sector==n.sec+1 ) %>% 
  filter( importer=='USA' ) %>% 
  select( USA );
us.us.wiod <- as.numeric(us.us.wiod[1]);
# US exports
us.exports.wiod <- WIOD %>% 
  filter( year==yr, sector==n.sec+1 ) %>% 
  filter( importer!='USA' ) %>% 
  select( USA ); 
#us.exports.wiod <-sum(us.exports.wiod)
# US imports
us.imports.wiod <- WIOD %>% 
  filter( year==yr, sector==n.sec+1 ) %>% 
  filter( importer=='USA' ) %>% 
  select( -year, -USA, -sector, -importer  ) ;
#us.imports.wiod <-sum(us.imports.wiod)
## WIOD
WIOD <- WIOD.base %>% 
  filter( year==yr, sector==n.sec+1 ) %>% 
  filter( importer!='USA' ) %>% 
  select( -year, -USA, -sector, -importer  ) ;
## Gravity data csv format with comma as the separator
data_gravity_services <- data_gravity_services.base %>% 
  filter( year==yr ) %>% 
  select( -year ) %>% 
  mutate( iso_o=as.character(iso_o), iso_d=as.character(iso_d) ) %>% 
  mutate( len_o=ifelse(nchar(iso_o)<4, 'COUNTRY', 'STATE'), 
          len_d=ifelse(nchar(iso_d)<4, 'COUNTRY', 'STATE') );

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 2. NUMBER STATES AND COUNTRIES
# States
id.states <- data_gravity_services %>% 
  filter( len_o=='STATE' ) %>% 
  select( iso_o ) %>% 
  distinct( iso_o ) %>% 
  arrange( iso_o ) %>% 
  mutate( id=row_number() ) %>% 
  rename( region=iso_o ) %>% 
  select( id, region );
# Countries
id.countries <- data_gravity_services %>% 
  filter( len_o=='COUNTRY' ) %>% 
  select( iso_o ) %>% 
  distinct( iso_o ) %>% 
  arrange( iso_o ) %>% 
  mutate( id=n.s+row_number() ) %>% 
  rename( region=iso_o ) %>% 
  select( id, region );
# Total
id.total <- rbind( id.states, id.countries );

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 3. ELEMENTARY MATRICES FOR KRONECKER PRODUCTS

# 3.1. DISTANCE MATRIX
dist.matrix <- data_gravity_services %>% 
  select( iso_o, iso_d, dist ) %>% 
  left_join( y=id.total, by=c('iso_o'='region') ) %>% 
  rename( id_o=id ) %>% 
  left_join( y=id.total, by=c('iso_d'='region') ) %>% 
  rename( id_d=id ) %>% 
  select( id_o, id_d, dist ) %>% 
  arrange( id_o, id_d ) %>% 
  spread( key=id_d, value=dist );
dist.matrix <- as.matrix( dist.matrix[,2:(n.c+n.s+1)] );

#Phis
#we use the coefficients from Country_Gravity_WIOD.
phi<-diag(x = own_dummy, n.c+n.s, n.c+n.s);
phi<-exp(phi);
phi<-phi*dist.matrix^dist_coeff;
dist.matrix<-phi

# 3.2. GDP VECTOR
gdp.vector <- data_gravity_services %>% 
  select( iso_o, Y_i ) %>% 
  distinct( iso_o, .keep_all=TRUE ) %>% 
  left_join( y=id.total, by=c('iso_o'='region') ) %>% 
  select( id, Y_i ) %>% 
  arrange( id );
gdp.vector <- as.vector( gdp.vector$Y_i );

# 3.3. EXPENDITURE VECTOR
exp.vector <- data_gravity_services %>% 
  select( iso_d, X_j ) %>% 
  distinct( iso_d, .keep_all=TRUE ) %>% 
  left_join( y=id.total, by=c('iso_d'='region') ) %>% 
  select( id, X_j ) %>% 
  arrange( id );
exp.vector <- as.vector( exp.vector$X_j );

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 4. BIG MATRICES

# 4.1 Matrices X and Y (repeat gdp and expenditure vectors in ns+nc rows)
mat.Y <- matrix( data=rep(gdp.vector, (n.s+n.c)), nrow=(n.s+n.c), byrow=TRUE );
mat.X <- matrix( data=rep(exp.vector, (n.s+n.c)), nrow=(n.s+n.c), byrow=TRUE );

# 4.2 Submatrices
##phi*Y submatrices
phi.Y.ss <- dist.matrix[(1:n.s), (1:n.s)] * mat.Y[(1:n.s), (1:n.s)];
phi.Y.sc <- dist.matrix[(1:n.s), ((n.s+1):(n.s+n.c))] * mat.Y[(1:n.s), ((n.s+1):(n.s+n.c))];
phi.Y.cs <- dist.matrix[((n.s+1):(n.s+n.c)), (1:n.s)] * mat.Y[((n.s+1):(n.s+n.c)), (1:n.s)];
phi.Y.cc <- dist.matrix[((n.s+1):(n.s+n.c)), ((n.s+1):(n.s+n.c))] * 
  mat.Y[((n.s+1):(n.s+n.c)), ((n.s+1):(n.s+n.c))];
## phi*X submatrices
phi.X.ss <- dist.matrix[(1:n.s), (1:n.s)] * mat.X[(1:n.s), (1:n.s)];
phi.X.sc <- dist.matrix[(1:n.s), ((n.s+1):(n.s+n.c))] * mat.X[(1:n.s), ((n.s+1):(n.s+n.c))];
phi.X.cs <- dist.matrix[((n.s+1):(n.s+n.c)), (1:n.s)] * mat.X[((n.s+1):(n.s+n.c)), (1:n.s)];
phi.X.cc <- dist.matrix[((n.s+1):(n.s+n.c)), ((n.s+1):(n.s+n.c))] * 
  mat.X[((n.s+1):(n.s+n.c)), ((n.s+1):(n.s+n.c))];


#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 5. WIOD MATRIX AND RELATED QUANTITIES

## 5.1 WIOD matrix (d,o)
wiod.matrix <- as.matrix( WIOD );

## 5.2 lambda vector

### imports and exports
imports.from.countries <- as.matrix( apply(X=wiod.matrix, MARGIN=1, FUN=sum) );
exports.to.countries <- as.matrix( apply(X=wiod.matrix, MARGIN=2, FUN=sum) )
### shares of imports and exports of countries
X_c <- as.matrix( exp.vector[(n.s+1):(n.s+n.c)] );
Y_c <- as.matrix( gdp.vector[(n.s+1):(n.s+n.c)] );
### lambdas
lambda.p <- (X_c-imports.from.countries) / X_c;
lambda.pi <-(Y_c- exports.to.countries) / Y_c;
### lambda vector
ones.ns <- matrix( data=rep(1, n.s), nrow=n.s, ncol=1 );
lambda_vector <- rbind( ones.ns, lambda.p, ones.ns, lambda.pi );

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
## 6.1 Big zeros matrices
zeros.nc.nc <- matrix( data=rep(0, n.c*n.c), nrow=n.c, ncol=n.c );
zeros.big <- matrix( data=rep(0, (n.s+n.c)*(n.s+n.c)), nrow=(n.s+n.c), ncol=(n.s+n.c) );

## 6.2 GIANT MATRIX 
### Block for system 10
block.10 <- rbind( cbind(phi.Y.ss, phi.Y.sc),
                   cbind(phi.Y.cs, zeros.nc.nc) );
### Block for system 11
block.11 <- rbind( cbind(phi.X.ss, phi.X.sc),
                   cbind(phi.X.cs, zeros.nc.nc) );
### Relevant matrix
BIG.MAT <- rbind( cbind(zeros.big, block.10),
                  cbind(block.11, zeros.big) );

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
###SOLUTION FROM MATLAB
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
SOL <- read_xls(paste('1-Intermediate_Processed_Data//vector_solution_',yr, '.xls', sep=""),col_names=FALSE)
SOL <- as.matrix(SOL)
lambda_before <- as.matrix(read.csv(paste('1-Intermediate_Processed_Data//vector_lambda_',yr, '.csv', sep="")))
B_before <-as.matrix(read.csv(paste('1-Intermediate_Processed_Data//matrix_B_',yr, '.csv', sep="")))
checking_sol <- lambda_before*SOL / B_before %*% SOL^{-1}-1;
if(norm(checking_sol, "2")>epsilon) 
  stop(paste("Solution from Matlab does not seem to work for year", yr))

#checking
#checking
value <-  lambda_vector*SOL / BIG.MAT %*% SOL^{-1}-1;
if(norm(value, "2")>epsilon) 
  stop(paste("Solution from Matlab does not seem to work for year", yr))

x<- SOL;
##calculating Xij
  #x<-as.matrix( c(normalization,x) )
### Basic vector
P.s <- as.matrix( x[1:n.s] );
P.c <- as.matrix( x[(n.s+1):(n.s+n.c)] );
Pi.s <- as.matrix( x[(n.s+n.c+1):(2*n.s+n.c)] );
Pi.c <- as.matrix( x[(2*n.s+n.c+1):(2*(n.s+n.c))] );

### Inverted basic
P.s.inv <- P.s^(-1); 
P.c.inv <- P.c^(-1);
Pi.s.inv <- Pi.s^(-1);
Pi.c.inv <- Pi.c^(-1);

Pi.sq.mat <- matrix( data=rep(c(Pi.s.inv, Pi.c.inv)*gdp.vector, (n.s+n.c)),
                     nrow=(n.s+n.c), ncol=(n.s+n.c), byrow=TRUE );
P.sq.mat <- matrix( data=rep(c(P.s.inv, P.c.inv)*exp.vector, (n.s+n.c)),
                    nrow=(n.s+n.c), ncol=(n.s+n.c), byrow=FALSE );
#consistent with WIOD notation
Xij.matrix <- Pi.sq.mat * dist.matrix * P.sq.mat;
write.csv(Xij.matrix, file= paste('1-Intermediate_Processed_Data//Xij_matrix_services_', yr, '.csv', sep= ""), row.names=FALSE, na="" );
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
###CHECKS
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

#CHECK: US consumption from US =US consumption from US from WIOD
value1 <- sum(Xij.matrix[(1:n.s), (1:n.s)])
value2 <- WIOD.base %>%
  filter(sector==n.sec+1, year==yr, importer=="USA") %>%
  select(-importer, -sector, -year)
value2=value2$USA;
#checking
if(abs(value1/value2-1)>epsilon) 
  stop(paste(" US consumption from US != value from WIOD for", yr, " value=", sum(X_j.mod.s)/sum(xj.us)-1))

#Check: states' exports to countries add to WIOD US exports to countries (sector 13)
value1 <- sum(Xij.matrix[((n.s+1):(n.s+n.c)), (1:n.s)])
value2 <- WIOD.base %>%
  filter(year==yr, sector==n.sec+1, importer!="USA")
value2 <- sum(value2$USA)
if(abs(value1/value2-1)>epsilon) 
  stop(paste("states' exports to countries != WIOD US exports to countries for", yr, " value=", abs(value1/value2-1)))

#Check: states' imports from countries add to WIOD US imports from countries (sector 13)
value1 <- sum(Xij.matrix[(1:n.s), ((n.s+1):(n.s+n.c))])
value2 <- WIOD.base %>%
  filter(year==yr, sector==n.sec+1, importer=="USA") %>%
  select(-year, -importer, -sector, - USA)
value2 <- sum(value2)
if(abs(value1/value2-1)>epsilon) 
  stop(paste("states' imports from countries != WIOD US imports from countries for", yr, " value=", abs(value1/value2-1)))


#Check: states' exports to states add to WIOD US exports to US (sector 13)
value1 <- sum(Xij.matrix[(1:n.s), (1:n.s)])
value2 <- WIOD.base %>%
  filter(year==yr, sector==n.sec+1, importer=="USA")
value2 <- value2$USA[1]
if(abs(value1/value2-1)>epsilon) 
  stop(paste("states' exports to states != WIOD US exports to US for", yr, " value=", abs(value1/value2-1)))

}
```
