------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Users\Jose Pablo\Dropbox\NK trade\JP\Data_Construction\1-Codes\3-Log_Files\3-1-CFS-to-Sectors-Cross.log
  log type:  text
 opened on:  12 Mar 2020, 14:17:25

. 
. /*
> ***********************************************************************************************************************************************
> ***     THIS DO FILE DOES THE FOLLOWING:
> ***********************************************************************************************************************************************
> Associates each commodity code with a NAICS code and then transforms the latter in the 14 desired sector categories.
> It is important to note that each commodity can be associated with more than one NAICS, depending on the industry that that
> commodity was produced in. 
> The code takes CFS 2007 and 2012 for the US, and calculates the proportion of the amount of commodity c associated with
> NAICS n, with respect to the total amount of commodity c. This gives a matrix of (#commodities)x14 for each year. 
> In general, this do file gives a matrix that shows how to redistribute the amount of each commodity into 14 sectors for the US
> for 2002, 2007 and 2012; the matrix for 2002 is the same as the one for 2007. 
> */
. 
. *********************** 
. ***  OUTPUT FILES   ***  
. ***********************
. global CFSapportionment "1-Intermediate_Processed_Data\CFSapportionment.dta"

. ********************** 
. ***  INPUT FILES   ***  
. **********************
. global data_2007 "import excel "0-Raw_Data\CFS\NAICS to CFS Crosswalk.xlsx", sheet("CF0700A18") cellrange(A1) firstrow clear"

. global data_2012 "import delimited "0-Raw_Data\CFS\CFS_2012_00A18_with_ann.csv", varnames(1) rowrange(3) clear"

. 
. foreach year in 2007 2012{
  2. 
. * Import CFS data with both NAICS and CFS codes
. ${data_`year'}
  3. * Keep just total data for all of the US, not separated by state. 
. capture keep if GEOTYPE==1
  4. 
. * Recode manufacturing as NAICS 3 and destring NAICS code
. capture rename NAICS2002 NAICS`year'
  5. capture rename NAICS2002_MEANING NAICS`year'_MEANING
  6. capture rename naicsid NAICS`year'
  7. 
. replace NAICS`year'="3" if NAICS`year'=="31-33"
  8. capture replace NAICS`year'="4931" if NAICS`year'=="4931(CF1)"
  9. destring NAICS`year', replace force
 10. 
. * Keep just relevant variables, NAICS code, SCTG code and value shipped
. capture rename naicsdisplaylabel NAICS`year'_MEANING
 11. capture rename commid COMM
 12. capture rename commdisplaylabel COMM_MEANING
 13. capture rename val VAL
 14. capture destring VAL, replace force
 15. 
. keep NAICS* COMM COMM_MEANING VAL
 16. 
. * Drop all commodities category and unknown commodity category
. capture tostring COMM, replace
 17. foreach v in 07 08 17 18 {
 18. capture replace COMM="`v'" if COMM=="`v'-R"
 19. }
 20. capture destring COMM, replace
 21. drop if COMM==0 | COMM==99
 22. 
. * Also drop superflous NAICS and turn them all into 3 digit numbers
. drop if NAICS`year'==3 
 23. drop if NAICS`year'==423 | NAICS`year'==424
 24. drop if NAICS`year'>4230 & NAICS`year'<4250
 25. replace NAICS`year'=421 if NAICS`year'==42
 26. replace NAICS`year'=454 if NAICS`year'==4541
 27. replace NAICS`year'=455 if NAICS`year'==45431
 28. replace NAICS`year'=493 if NAICS`year'==4931
 29. replace NAICS`year'=511 if NAICS`year'==5111
 30. replace NAICS`year'=551 if NAICS`year'==551114
 31. 
. * The 22 sectors in CDP are:
. 
. * 01) Food, Beverage, and Tobacco Products (NAICS 311-312); 
. * 02) Textile, Textile Product Mills, Apparel, Leather, and Allied Products (NAICS 313-316);
. * 03) Wood Products, Paper, Printing, and Related Support Activities (NAICS 321-323); 
. * 04) Petroleum and Coal Products (NAICS 324); 
. * 05) Chemical (NAICS 325); 
. * 06) Plastics and Rubber Products (NAICS 326); 
. * 07) Nonmetallic Mineral Products (NAICS 327);
. * 08) Primary Metal and Fabricated Metal Products (NAICS 331-332); 
. * 09) Machinery (NAICS 333);
. * 10) Computer and Electronic Products, and Electrical Equipment and Appliance (NAICS 334-335); 
. * 11) Transportation Equipment (NAICS 336); 
. * 12) Furniture and Related Products, and Miscellaneous Manufacturing (NAICS 337-339); 
. * 14) Trade (NAICS 42-45);
. * 13) Construction (NAICS 23);
. * 15) Transport Services (NAICS 481-488); 
. * 16) Information Services (NAICS 511-518);
. * 17) Finance and Insurance (NAICS 521-525); 
. * 18) Real Estate (NAICS 531-533); 
. * 19) Education (NAICS 61); 
. * 20) Health Care (NAICS 621-624); 
. * 21) Accommodation and Food Services (NAICS 721-722); 
. * 22) Other Services (NAICS 493, 541, 55, 561, 562, 711-713, 811-814);
. *23.    (NAICS 111-115) Agriculture, Forestry, Fishing, and Hunting (c1)
. *Mining, Quarrying, and Oil and Gas Extraction (c2). 
. 
. * Switch from NAICS to CDP sectors
. 
. recode NAICS`year' ///
> (311 = 1 ) ///
> (312 = 1 ) /// 
> (313 = 2 ) ///
> (314 = 2 ) ///
> (315 = 2 ) ///
> (316 = 2 ) ///
> (321 = 3 ) ///
> (322 = 3 ) ///
> (323 = 3 ) ///
> (324 = 4 ) ///
> (325 = 5 ) ///
> (326 = 6 ) ///
> (327 = 7 ) ///
> (331 = 8 ) /// 
> (332 = 8 ) ///
> (333 = 9 ) ///
> (334 = 10) ///
> (335 = 10) ///
> (336 = 11) ///
> (337 = 12) ///
> (339 = 12) ///
> (421 = 14) ///
> (454 = 14) ///
> (455 = 14) ///
> (493 = 22) ///
> (511 = 16) /// 
> (551 = 22) ///
> (nonmissing = .), gen(cdp)
 32. *** AGRIC AND MINING
. replace cdp=14 if (NAICS`year'==212)==1
 33. ***
. drop if cdp==.
 34. collapse (sum) VAL, by(cdp COMM)
 35. *Services
. replace cdp=13 if (cdp>=13 & cdp<=22)==1
 36. ***
. *agriculture
. replace cdp=14 if COMM>=1 & COMM<=4
 37. *mining
. replace cdp=14 if COMM>=10 & COMM<=14
 38. collapse (sum) VAL, by(cdp COMM)
 39. 
. order COMM cdp VAL
 40. sort COMM cdp
 41. 
. by COMM: egen totalsent=total(VAL)
 42. gen portion=VAL/totalsent
 43. 
. xtset COMM cdp
 44. 
. tsfill, full
 45. 
. replace portion=0 if portion==.
 46. 
. drop VAL totalsent
 47. 
. reshape wide portion, i(COMM) j(cdp)
 48. gen year=`year'
 49. tempfile data`year'
 50. save `data`year'', replace
 51. }
(43 real changes made)
NAICS2007 contains nonnumeric characters; replaced as long
(96 observations deleted)
(41 observations deleted)
(82 observations deleted)
(547 observations deleted)
(41 real changes made)
(33 real changes made)
(24 real changes made)
(39 real changes made)
(21 real changes made)
(41 real changes made)
(762 differences between NAICS2007 and cdp)
(29 real changes made)
(0 observations deleted)
(103 real changes made)
(30 real changes made)
(51 real changes made)
       panel variable:  COMM (unbalanced)
        time variable:  cdp, 1 to 14, but with gaps
                delta:  1 unit
(225 real changes made)
(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14)

Data                               long   ->   wide
-----------------------------------------------------------------------------
Number of obs.                      574   ->      41
Number of variables                   3   ->      15
j variable (14 values)              cdp   ->   (dropped)
xij variables:
                                portion   ->   portion1 portion2 ... portion14
-----------------------------------------------------------------------------
(note: file C:\Users\JOSEPA~1\AppData\Local\Temp\ST_00000001.tmp not found)
file C:\Users\JOSEPA~1\AppData\Local\Temp\ST_00000001.tmp saved
(16 vars, 1415 obs)
(43 real changes made)
NAICS2012 contains nonnumeric characters; replaced as long
(57 observations deleted)
(41 observations deleted)
(81 observations deleted)
(499 observations deleted)
(41 real changes made)
(31 real changes made)
(19 real changes made)
(38 real changes made)
(11 real changes made)
(37 real changes made)
(737 differences between NAICS2012 and cdp)
(19 real changes made)
(41 observations deleted)
(91 real changes made)
(25 real changes made)
(46 real changes made)
       panel variable:  COMM (unbalanced)
        time variable:  cdp, 1 to 14, but with gaps
                delta:  1 unit
(250 real changes made)
(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14)

Data                               long   ->   wide
-----------------------------------------------------------------------------
Number of obs.                      574   ->      41
Number of variables                   3   ->      15
j variable (14 values)              cdp   ->   (dropped)
xij variables:
                                portion   ->   portion1 portion2 ... portion14
-----------------------------------------------------------------------------
(note: file C:\Users\JOSEPA~1\AppData\Local\Temp\ST_00000002.tmp not found)
file C:\Users\JOSEPA~1\AppData\Local\Temp\ST_00000002.tmp saved

. ***
. *** APPENDING YEARS
. ***
. use `data2007', clear

. replace year=2002
(41 real changes made)

. append using `data2007'

. append using `data2012'

. 
. save $CFSapportionment, replace
file 1-Intermediate_Processed_Data\CFSapportionment.dta saved

. 
end of do-file

. tab year'
' invalid name
r(198);

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       2002 |         41       33.33       33.33
       2007 |         41       33.33       66.67
       2012 |         41       33.33      100.00
------------+-----------------------------------
      Total |        123      100.00

. do "C:\Users\Jose Pablo\Dropbox\0-mycomputer\mydocuments\Berkeley\6 Fifth Year\RUV\Data_Construction\1-Codes\3-2-makeTradeMatrixCFS.do"

. capture log close
