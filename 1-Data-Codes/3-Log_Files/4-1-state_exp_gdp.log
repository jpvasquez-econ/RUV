------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Users\Jose Pablo\Dropbox\NK trade\JP\Data_Construction\1-Codes\3-Log_Files\4-1-state_exp_gdp.log
  log type:  text
 opened on:  13 Mar 2020, 14:48:35

. /*
> ***********************************************************************************************************************************************
> ***     THIS DO FILE DOES THE FOLLOWING:
> ***********************************************************************************************************************************************
> 1. Constructs the data of GDP by state
> 2. Constructs the data of EXPENDITURE by state
> 3. Merges GDP with Expenditure
> 4. Proportionality with WIOD
> */
. ********************** 
. ***  INPUT FILES   ***  
. **********************
. global state_code ""0-Raw_Data\Fips\state_codes.txt""

. global BEA_RAW ""0-Raw_Data\Expenditure\SAEXP1_1997_2017_ALL_AREAS_.csv""

. global WIOD_countries "2-Final_Data\WIOD_countries.dta"

. global SAGDP "0-Raw_Data\SAGDP\"

. ********************** 
. ***  OUTPUT FILES  ***  
. **********************
. global state_exp_gdp_services "2-Final_Data\state_exp_gdp_services.dta"

. ********************** 
. ***  State codes   ***  
. **********************
. import delimited $state_code , delimiter("-") 
(2 vars, 50 obs)

. rename v1 state

. gen code = subinstr(v2," ","",.) 

. drop v2

. levelsof code, local(state_code) 
`"AK"' `"AL"' `"AR"' `"AZ"' `"CA"' `"CO"' `"CT"' `"DE"' `"FL"' `"GA"' `"HI"' `"IA"' `"ID"' `"IL"' `"IN"' `"KS"' `"KY"' `"LA"' `"MA"' `"MD"' `"ME"' `"M
> I"' `"MN"' `"MO"' `"MS"' `"MT"' `"NC"' `"ND"' `"NE"' `"NH"' `"NJ"' `"NM"' `"NV"' `"NY"' `"OH"' `"OK"' `"OR"' `"PA"' `"RI"' `"SC"' `"SD"' `"TN"' `"TX
> "' `"UT"' `"VA"' `"VT"' `"WA"' `"WI"' `"WV"' `"WY"'

. display `state_code'
AKALARAZCACOCTDEFLGAHIIAIDILINKSKYLAMAMDMEMIMNMOMSMTNCNDNENHNJNMNVNYOHOKORPARISCSDTNTXUTVAVTWAWIWVWY

. *************** 
. ***  WIOD   ***  
. ***************
. {
. use $WIOD_countries, clear
. gen serv=(sector==13)
. keep if serv==1
(5928 observations deleted)
. ***
. *** EXPORTS OF US
. ***
. preserve
. keep value_USA year
. bys year: egen double val_=total(value_USA)
. bys year: gen dup=cond(_N==1,0,_n)
. drop if dup>1
(444 observations deleted)
. levelsof year, local(levels) 
2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 2010 2011
. foreach l of local levels {
  2. display "`l'"
  3. summ val_ if year == `l'
  4. global wiod_us_all_`l'=`r(mean)'
  5. }
2000

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        val_ |         1    1.15e+07           .   1.15e+07   1.15e+07
2001

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        val_ |         1    1.19e+07           .   1.19e+07   1.19e+07
2002

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        val_ |         1    1.22e+07           .   1.22e+07   1.22e+07
2003

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        val_ |         1    1.28e+07           .   1.28e+07   1.28e+07
2004

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        val_ |         1    1.37e+07           .   1.37e+07   1.37e+07
2005

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        val_ |         1    1.49e+07           .   1.49e+07   1.49e+07
2006

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        val_ |         1    1.58e+07           .   1.58e+07   1.58e+07
2007

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        val_ |         1    1.66e+07           .   1.66e+07   1.66e+07
2008

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        val_ |         1    1.69e+07           .   1.69e+07   1.69e+07
2009

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        val_ |         1    1.62e+07           .   1.62e+07   1.62e+07
2010

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        val_ |         1    1.67e+07           .   1.67e+07   1.67e+07
2011

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        val_ |         1    1.72e+07           .   1.72e+07   1.72e+07
. restore
. ***
. *** IMPORTS OF US
. ***
. keep imp* year val*
. keep if importer_c=="USA"
(444 observations deleted)
. egen double val_=rowtotal(value*)
. levelsof year, local(levels) 
2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 2010 2011
. foreach l of local levels {
  2. display "`l'"
  3. summ val_ if year == `l'
  4. global wiod_all_us_`l'=`r(mean)'
  5. }
2000

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        val_ |         1    1.14e+07           .   1.14e+07   1.14e+07
2001

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        val_ |         1    1.17e+07           .   1.17e+07   1.17e+07
2002

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        val_ |         1    1.21e+07           .   1.21e+07   1.21e+07
2003

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        val_ |         1    1.27e+07           .   1.27e+07   1.27e+07
2004

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        val_ |         1    1.36e+07           .   1.36e+07   1.36e+07
2005

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        val_ |         1    1.47e+07           .   1.47e+07   1.47e+07
2006

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        val_ |         1    1.56e+07           .   1.56e+07   1.56e+07
2007

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        val_ |         1    1.63e+07           .   1.63e+07   1.63e+07
2008

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        val_ |         1    1.66e+07           .   1.66e+07   1.66e+07
2009

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        val_ |         1    1.60e+07           .   1.60e+07   1.60e+07
2010

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        val_ |         1    1.64e+07           .   1.64e+07   1.64e+07
2011

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        val_ |         1    1.70e+07           .   1.70e+07   1.70e+07
. }

. ***********************************************************************************************************************************************
. ***     1. Constructs the data of GDP by state
. ***********************************************************************************************************************************************
. {
. ****************************** 
. ***  LOOPING OVER STATES   ***  
. ******************************
. foreach l of local state_code {
  2. display "Importing State `l'"
  3. quiet{
  4. import delimited "${SAGDP}\\SAGDP2N_`l'_1997_2018.csv", delimiter(comma) clear 
  5. drop table component unit
  6. drop if region==.
  7. gen code="`l'"
  8. *value for years
. ds v*,
  9. local vari `r(varlist)'
 10. scalar i=1997
 11. foreach v of local vari{
 12. rename `v' value`=i'
 13. destring value`=i', replace force
 14. scalar i=`=i'+1 
 15. }
 16. drop value2018
 17. tempfile file`l'
 18. save `file`l'', replace
 19. }
 20. }
Importing State AK
Importing State AL
Importing State AR
Importing State AZ
Importing State CA
Importing State CO
Importing State CT
Importing State DE
Importing State FL
Importing State GA
Importing State HI
Importing State IA
Importing State ID
Importing State IL
Importing State IN
Importing State KS
Importing State KY
Importing State LA
Importing State MA
Importing State MD
Importing State ME
Importing State MI
Importing State MN
Importing State MO
Importing State MS
Importing State MT
Importing State NC
Importing State ND
Importing State NE
Importing State NH
Importing State NJ
Importing State NM
Importing State NV
Importing State NY
Importing State OH
Importing State OK
Importing State OR
Importing State PA
Importing State RI
Importing State SC
Importing State SD
Importing State TN
Importing State TX
Importing State UT
Importing State VA
Importing State VT
Importing State WA
Importing State WI
Importing State WV
Importing State WY
. ******************** 
. ***  APPENDING   ***  
. ********************
. clear
. set obs 1
obs was 0, now 1
. gen temp=0
. foreach l of local state_code {
  2. display "APPENDING STATE `l'"
  3. quiet{
  4. append using `file`l''
  5. }
  6. }
APPENDING STATE AK
APPENDING STATE AL
APPENDING STATE AR
APPENDING STATE AZ
APPENDING STATE CA
APPENDING STATE CO
APPENDING STATE CT
APPENDING STATE DE
APPENDING STATE FL
APPENDING STATE GA
APPENDING STATE HI
APPENDING STATE IA
APPENDING STATE ID
APPENDING STATE IL
APPENDING STATE IN
APPENDING STATE KS
APPENDING STATE KY
APPENDING STATE LA
APPENDING STATE MA
APPENDING STATE MD
APPENDING STATE ME
APPENDING STATE MI
APPENDING STATE MN
APPENDING STATE MO
APPENDING STATE MS
APPENDING STATE MT
APPENDING STATE NC
APPENDING STATE ND
APPENDING STATE NE
APPENDING STATE NH
APPENDING STATE NJ
APPENDING STATE NM
APPENDING STATE NV
APPENDING STATE NY
APPENDING STATE OH
APPENDING STATE OK
APPENDING STATE OR
APPENDING STATE PA
APPENDING STATE RI
APPENDING STATE SC
APPENDING STATE SD
APPENDING STATE TN
APPENDING STATE TX
APPENDING STATE UT
APPENDING STATE VA
APPENDING STATE VT
APPENDING STATE WA
APPENDING STATE WI
APPENDING STATE WV
APPENDING STATE WY
. drop if temp==0
(1 observation deleted)
. drop temp
. distinct code 

       |        Observations
       |      total   distinct
-------+----------------------
  code |       4550         50
. assert `r(ndistinct)'==50
. ************************** 
. ***  SERVICE SECTORS   ***  
. **************************
. /*
> ***********************************************************************************************************************************************
> ***     SECTORS USED AND THEIR MAPPING TO WIOD (indexed by ci)
> ***********************************************************************************************************************************************
> 13.     (NAICS XX) Construction (c18); 
> 14.     (NAICS 42-45) Wholesale and Retail Trade (c19–c21); 
> 15.     (NAICS 481-488) Transport Services (c23–c26);
> 16.     (NAICS 511–518) Information Services (c27); 
> 17.     (NAICS 521–525) Finance and Insurance (c28); 
> 18.     (NAICS 531-533)  Real Estate (c29–c30); 
> 19.     (NAICS 61) Education (c32); 
> 20.     (NAICS 621–624) Health Care (c33); 
> 21.     (NAICS 721–722) Accommodation and Food Services (c22); 
> 22.     (NAICS 493, 541, 55, 561, 562, 711–713, 811-814) Other Services (c34).
> */
. rename industryclass naics
. rename geoname state
. gen cdp_sector=.
(4550 missing values generated)
. *13.    ((NAICS 23) Construction (c18); 
. replace cdp_sector=13 if naics=="23"
(50 real changes made)
. *14.    (NAICS 42-45) Wholesale and Retail Trade (c19–c21); 
. replace cdp_sector=14 if naics=="42" | naics=="43" | naics=="44-45"
(100 real changes made)
. *15.    (NAICS 481-488) Transport Services (c23–c26);
. replace cdp_sector=15 if naics=="481" | naics=="482" | naics=="483" | ///
> naics=="484" | naics=="485" | naics=="486" | naics=="487-488, 492" 
(350 real changes made)
. *16.    (NAICS 511–518) Information Services (c27);
. replace cdp_sector=16 if naics=="511" | naics=="512" | naics=="515, 517"  | naics=="518, 519"
(200 real changes made)
. *17.    (NAICS 521–525) Finance and Insurance (c28); 
. replace cdp_sector=17 if naics=="521-522" | naics=="523" | naics=="524"  | naics=="525"  
(200 real changes made)
. *18.    (NAICS 531-533)  Real Estate (c29–c30); 
. replace cdp_sector=18 if naics=="531" | naics=="532-533"  
(100 real changes made)
. *19.    (NAICS 61) Education (c32); 
. replace cdp_sector=19 if naics=="61"
(50 real changes made)
. *20.    (NAICS 621–624) Health Care (c33);
. replace cdp_sector=20 if naics=="621" | naics=="622" | naics=="623"  | naics=="624"  
(200 real changes made)
. *21.    (NAICS 721–722) Accommodation and Food Services (c22); 
. replace cdp_sector=21 if naics=="721" | naics=="722"
(100 real changes made)
. *22.    (NAICS 493, 541, 55, 561, 562, 711–713, 811-814) Other Services (c34).
. replace cdp_sector=22 if naics=="493" | naics=="54" | naics=="55" | ///
> naics=="561" | naics=="562" | naics=="711-712" | naics=="713" | naics=="81"
(400 real changes made)
. * exports of china in Manuf
. keep if cdp_sector!=. 
(2800 observations deleted)
. ***************************** 
. ***  SETTING FINAL DATA   ***  
. *****************************
. * only sending sector
. rename cdp_s sector
. collapse (sum) value* , by(state code sector)
. reshape long value, i(state code sector) j(year)
(note: j = 1997 1998 1999 2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 2010 2011 2012 2013 2014 2015 2016 2017)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                      500   ->   10500
Number of variables                  24   ->       5
j variable (21 values)                    ->   year
xij variables:
      value1997 value1998 ... value2017   ->   value
-----------------------------------------------------------------------------
. rename value gdp
. keep if sector>=13
(0 observations deleted)
. collapse (sum) gdp, by(state code year) 
. tempfile gdp
. save `gdp', replace
(note: file C:\Users\JOSEPA~1\AppData\Local\Temp\ST_0100001i.tmp not found)
file C:\Users\JOSEPA~1\AppData\Local\Temp\ST_0100001i.tmp saved
. }

. ***********************************************************************************************************************************************
. ***     2. Constructs the data of EXPEDITURE by state
. ***********************************************************************************************************************************************
. {
. ***  IMPORTING BEA DATA
. import delimited $BEA_RAW, clear
(30 vars, 1444 obs)
. **  KEEPING AND RENAMING RELEVANT VARIABLES
. ***
. *** keeping only states
. ***
. *removing quotes from geofios
. replace geofips = subinstr(geofips, `"""', "",.) 
(1440 real changes made)
. *making it a number instead of string
. destring geofips, replace force
geofips contains nonnumeric characters; replaced as long
(4 missing values generated)
. *dropping regions (leaving only states)
. drop if geofips>90000
(196 observations deleted)
. drop if geofips==0
(24 observations deleted)
. *dropping DC
. drop if geoname=="District of Columbia"
(24 observations deleted)
. *keeping relevant variables
. keep geoname line description v*
. *renaming 
. rename geoname state
. ds v*
v10  v11  v12  v13  v14  v15  v16  v17  v18  v19  v20  v21  v22  v23  v24  v25  v26  v27  v28  v29  v30
. local variab `r(varlist)'
. local n_years : word count `variab'
. local year=1997
. forval j=1/`n_years' {
  2.     local vari `: word `j' of `variab''
  3.         rename `vari' exp`year'
  4.         local year=`year'+1
  5. }
. ***********************************************************************************************************************************************
. ***     KEEPING RELEVANT LINES
. ***********************************************************************************************************************************************
. *keeping only services
. keep if line==13
(1150 observations deleted)
. format exp* %16.0g
. drop line descrip
. distinct state

       |        Observations
       |      total   distinct
-------+----------------------
 state |         50         50
. assert `r(ndistinct)'==50
. reshape long exp, i(state) j(year)
(note: j = 1997 1998 1999 2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 2010 2011 2012 2013 2014 2015 2016 2017)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                       50   ->    1050
Number of variables                  22   ->       3
j variable (21 values)                    ->   year
xij variables:
            exp1997 exp1998 ... exp2017   ->   exp
-----------------------------------------------------------------------------
. format exp %16.0g
. }

. ***********************************************************************************************************************************************
. ***     3. Merging Expenditure with GDP
. ***********************************************************************************************************************************************
. {
. merge 1:1 year state using `gdp'

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                             1,050  (_merge==3)
    -----------------------------------------
. summ _m

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
      _merge |      1050           3           0          3          3
. assert `r(mean)'==3
. drop _m
. order state code year exp gdp
. }

. ***********************************************************************************************************************************************
. ***     4. Proportionality with WIOD
. ***********************************************************************************************************************************************
. compress
  state was str20 now str14
  (6,300 bytes saved)

. gen double exp2=exp

. drop exp

. rename exp2 exp

. levelsof year, local(levels)
1997 1998 1999 2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 2010 2011 2012 2013 2014 2015 2016 2017

. 
. bys year: egen double tot_exp=total(exp)

. bys year: egen double tot_gdp=total(gdp)

. gen double sh_exp=exp/tot_exp

. gen double sh_gdp=gdp/tot_gdp

. keep if year<=2011
(300 observations deleted)

. keep if year>=2000
(150 observations deleted)

. 
. levelsof year, local(levels)
2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 2010 2011

. display "`levels'"
2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 2010 2011

. 
. foreach l of local levels {
  2. display `l'
  3. replace exp= ${wiod_all_us_`l'} * sh_exp if year==`l'
  4. replace gdp= ${wiod_us_all_`l'} * sh_gdp if year==`l'
  5. }
2000
(50 real changes made)
(50 real changes made)
2001
(50 real changes made)
(50 real changes made)
2002
(50 real changes made)
(50 real changes made)
2003
(50 real changes made)
(50 real changes made)
2004
(50 real changes made)
(50 real changes made)
2005
(50 real changes made)
(50 real changes made)
2006
(50 real changes made)
(50 real changes made)
2007
(50 real changes made)
(50 real changes made)
2008
(50 real changes made)
(50 real changes made)
2009
(50 real changes made)
(50 real changes made)
2010
(50 real changes made)
(50 real changes made)
2011
(50 real changes made)
(50 real changes made)

. 
. preserve

. collapse (sum)  gdp exp, by(year)

. levelsof year, local(levels)
2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 2010 2011

. foreach l of local levels {
  2. assert round(gdp)==round(${wiod_us_all_`l'}) if year==`l'
  3. assert round(exp)==round(${wiod_all_us_`l'}) if year==`l'
  4. }

. restore

. keep state exp gdp year

. compress
  (0 bytes saved)

. 
. save $state_exp_gdp_services, replace
file 2-Final_Data\state_exp_gdp_services.dta saved

. 
end of do-file

. tab yaer
variable yaer not found
r(111);

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       2000 |         50        8.33        8.33
       2001 |         50        8.33       16.67
       2002 |         50        8.33       25.00
       2003 |         50        8.33       33.33
       2004 |         50        8.33       41.67
       2005 |         50        8.33       50.00
       2006 |         50        8.33       58.33
       2007 |         50        8.33       66.67
       2008 |         50        8.33       75.00
       2009 |         50        8.33       83.33
       2010 |         50        8.33       91.67
       2011 |         50        8.33      100.00
------------+-----------------------------------
      Total |        600      100.00

. summ *

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
       state |         0
        year |       600      2005.5    3.454933       2000       2011
         gdp |       600      293964    374101.3   15563.88    2390831
         exp |       600    290228.6    346872.7   18117.56    2238295

. do "C:\Users\JOSEPA~1\AppData\Local\Temp\STD01000000.tmp"

. capture log close
