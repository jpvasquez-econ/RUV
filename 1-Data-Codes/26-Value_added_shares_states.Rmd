---
title: "6-2-Value-shares"
output:
  html_document:
    df_print: paged
  pdf_document:
    number_sections: yes
  word_document: default
header-includes:
- \usepackage{amsmath}
- \usepackage{amssymb}
- \usepackage{pifont}
- \usepackage{mathpazo}
- \newcommand{\xmark}{\ding{55}}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
remove(list = ls())
```

```{r warning=FALSE, include=FALSE, message=FALSE, results='hide', cache=FALSE}
# libraries
options( scipen=100, stringsAsFactors=FALSE );
## vector of libraries to be used
libs <- c( 'dplyr', 'tidyr', 'readstata13', 'haven', 'stringr', 'nleqslv', 'gdata', 'Statamarkdown', 'readxl', 'reshape2');
# Install libraries in case they are not installed
for( i in length(libs)){
  if( !(libs[i] %in% installed.packages()) ) install.packages( libs )
};
# Carga de bibliotecas
lapply( libs, require, character.only=TRUE );
```

# General Instructions

This code calculates the share of value added in gross output for each US state, for each sector.

### Constructing Value-Added ("Labor Shares")

We need to compute the share of value added in gross output the 50 for US states.  We can obtain data on sectoral and regional value added for the US from the Bureau of Economic Analysis (BEA). The final output would a matrix 50 $\times$ 13 with the shares of value added in gross output for each state, for each sector. Let's focus on the year 2000.

- Value added for each of the 50 U.S. states and 13 sectors can be obtained from the Bureau of Economic Analysis (BEA) by subtracting taxes and subsidies from GDP data 
- Gross outputs for each region $i$ is just $Y_{i,k}= \sum_j X_{ij,k}$ 
- In a few cases, gross output might be smaller than value added (probably due to some small discrepancies between trade and production data, etc). In such cases, just constrain value added to be equal to gross output. 


## Importing datasets to R
```{r}

regions <- read_excel("0-Raw_Data/regions.xlsx")
c.names <- regions %>% filter(status=="country", region!="USA")
c.names <- c.names$region
c.names <- as.matrix(c.names)

s.names <- regions %>% filter(status=="state") 
s.names <- s.names$region
s.names <- as.matrix(s.names)

names.all <- rbind(s.names, c.names)

n.s <- length(s.names)
n.c <- length(c.names)

sector.file <- read_excel("0-Raw_Data/sectors.xlsx")
id.sectors <- sector.file %>% 
  select(final_sector, WIOD_sector) %>%
  distinct(WIOD_sector, .keep_all = TRUE)

Base=c()
VA.US=c()
GDP=c()
TAXES=c()
SUBSIDIES=c()
for (yr in 2000:2007) {
#Final matrices
m <- read.csv(paste("1-Intermediate_Processed_Data//final_matrix_", yr, ".csv", sep=""), header = TRUE, sep = ",", dec = ".")
m$year=yr
m <- m %>% select(year, everything())
Base=rbind(Base, m)

#Value added USA
m1 <- read.csv(paste("1-Intermediate_Processed_Data//labor_shares_countries", yr, ".csv", sep=""), header = TRUE, sep = ",", dec = ".")
VA.US=rbind(VA.US, m1)

#State GDP
gdp <- read.csv(paste("0-Raw_Data//Labor_shares//gdp_state_", yr, ".csv", sep=""), header = FALSE, sep = ",", dec = ".")
gdp = gdp[6:(dim(gdp)[1]-7),1:dim(gdp)[2]]
gdp=data.frame(gdp)
gdp$year= yr
gdp <- gdp %>% select(year, everything())
GDP=rbind(GDP, gdp)  
#These databases were downloaded from BEA, Regional Data section; specifically, the base is named SAGDP2. After choosing this information, select the NAICS option, All areas, All statistics in table, and each year from 2000 to 2007, separately (to download the next year just go to the previous time section window and change the selected year). Download each base in a csv file.
#Each of this annual base needs an additional column that was added manually in excel. The column's name is "code" and contains the sectors' code in expanded form (1-24). If the base needs to be downloaded again in the future all that has to be done to the new one is copy and paste this "code" column (as it is) to the new base.

#State taxes
taxes <- read.csv(paste("0-Raw_Data//Labor_shares//taxes_state_", yr, ".csv", sep=""), header = FALSE, sep = ",", dec = ".")
taxes = taxes[6:(dim(taxes)[1]-6),1:dim(taxes)[2]]
taxes=data.frame(taxes)
taxes$year= yr
taxes <- taxes %>% select(year, everything())
TAXES=rbind(TAXES, taxes)  
#These databases were downloaded from BEA, Regional Data section; specifically, the base is named SAGDP6. After choosing this information, select the NAICS option, All areas, All statistics in table, and each year from 2000 to 2007, separately (to download the next year just go to the previous time section window and change the selected year). Download each base in a csv file.

#State subsidies
subsidies <- read.csv(paste("0-Raw_Data//Labor_shares//subsidies_state_", yr, ".csv", sep=""), header = FALSE, sep = ",", dec = ".")
subsidies = subsidies[6:(dim(subsidies)[1]-6),1:dim(subsidies)[2]]
subsidies=data.frame(subsidies)
subsidies$year= yr
subsidies <- subsidies %>% select(year, everything())
SUBSIDIES=rbind(SUBSIDIES, subsidies)  
#These databases were downloaded from BEA, Regional Data section; specifically, the base is named SAGDP5. After choosing this information, select the NAICS option, All areas, All statistics in table, and each year from 2000 to 2007, separately (to download the next year just go to the previous time section window and change the selected year). Download each base in a csv file.
}

VA.US <- VA.US %>% filter(region=="USA")
#taking out spaces between states' names: the option sub eliminates only the first space it finds 
GDP$V2 <- sub(' ', '', GDP$V2)
TAXES$V2 <- sub(' ', '', TAXES$V2)
SUBSIDIES$V2 <- sub(' ', '', SUBSIDIES$V2)

```


Gross output for each region, for each sector
$Y_{i,k}= \sum_j X_{ij,k} \quad for \quad all \quad j$
```{r}
Base <- melt(Base, id.vars=c("year", "importer", "sector"), variable.name="exporter", value.name = "value")
Base <-spread(Base, importer, value, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)
Y <- data.frame(rowSums(Base[, 4:dim(Base)[2]]))
Y <- cbind(Base[, 1:3], Y)
colnames(Y) <- c("year", "sector", "region", "value")
Y <- Y %>% filter(region %in% s.names)
Y <- spread(Y, sector, value, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)

```


Calculating value added
$VA_{i,k}=GDP_{i,k}-tax_{i,k}-subsidy_{i,k}, \quad where \quad subsidy<0$
```{r}
value <- GDP
value$tax=TAXES[, 6]
value$sub=SUBSIDIES[, 6]
colnames(value)=c("year", "id" ,"state", "line", "description", "gdp", "sector", "tax", "sub")
value$id=as.numeric(value$id)
value$sector=as.numeric(value$sector)
value$gdp=as.numeric(value$gdp) #some NA generated because base is not clean yet (cleaned in next steps)
value$tax=as.numeric(value$tax)
value$sub=as.numeric(value$sub)

VA.s <- value %>%
  mutate(gdp= ifelse(is.na(gdp)==TRUE, 0, gdp)) %>%
  mutate(tax= ifelse(is.na(tax)==TRUE, 0, tax)) %>%
  mutate(sub= ifelse(is.na(sub)==TRUE, 0, sub)) %>%
  filter(sector!=0) %>%
  filter(state!="Districtof Columbia" & state!="UnitedStates *") %>%
  filter(id <=56000) %>% #id's of interest
  left_join(id.sectors, by=c('sector'='WIOD_sector')) %>%
  mutate(sector = final_sector) %>%
  select(-final_sector) %>%
  mutate(sector= sector+100) %>%
  select(-id, -line, -description) %>%
  mutate(amount= (gdp)-(tax/1000)-(sub/1000)) %>%
  group_by(year, state, sector) %>%
  mutate(value_added=sum(as.numeric(as.character(amount)))) %>%
  ungroup() %>%
  distinct(year, state, sector, .keep_all=TRUE ) %>%
  select(-amount) %>%
  arrange(year, state, sector) %>%
  select(-gdp, -tax, -sub) %>%
  dplyr::rename(region=state)


VA.US <- melt(VA.US, id.vars=c("year", "region"), variable.name="sector", value.name = "value")
VA.US <- VA.US %>% arrange(year)
VA.US <-as.matrix(VA.US[, 4])

#proportionality for states' VA
VA.s<-spread(VA.s, region, value_added, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)
VA.s.1 <- VA.s[ , (3:dim(VA.s)[2])] /rowSums(VA.s[ , (3:dim(VA.s)[2])])
# check <- rowSums(VA.s.1)
# print(check)
value1 <- VA.s.1*VA.US
# check1 <- VA.US - rowSums(value1)
# print(check1)
VA.s <- cbind(VA.s[, 1:2], value1)
VA.s <- melt(VA.s, id.vars=c("year", "sector"), variable.name="region", value.name = "value_added")
VA.s$region <- as.character(VA.s$region)

VA.s<-spread(VA.s, sector, value_added, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)

#some NA generated at the beginning of the chunk because base was not clean yet
```

share of value added in gross output
$Labor share = \frac{VA_{i,k}}{Y_{i,k}}$
```{r}
labor_shares <- VA.s[, 3:dim(VA.s)[2]] / Y[, 3:dim(Y)[2]]
labor_shares[labor_shares>1] <- 1
labor_shares[labor_shares<(-1)] <- (-1)
labor_shares <- cbind(VA.s[, 1:2], labor_shares)

for (yr in 2000:2007) {
  final <- labor_shares %>%
    filter(year==yr)
  write.table(final, file = paste("1-Intermediate_Processed_Data//labor_shares_states", yr, ".csv", sep=""), sep = ",", row.names = FALSE)
}


```
