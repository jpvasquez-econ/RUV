---
title: "5-Gravity_agriculture"
output:
  html_notebook:
    toc: yes
    df_print: paged
    number_sections: yes    
  pdf_document:
    number_sections: yes
header-includes:
- \usepackage{amsmath}
- \usepackage{amssymb}
- \usepackage{pifont}
- \usepackage{mathpazo}
---

## General information

1) This code creates a file that contains information about distances between regions, agricultural production for all regions and agricultural consumption for countries. In doing so, the code also applies the usual proportionality rule so that aggregate expenditure and production matches WIOD.

2) This code generates the inputs of the agricultural gravity system and solves it.

## Input files

1. `0-Raw_Data/regions.csv`
2. `0-Raw_Data/sectors.csv`
3. `1-Intermediate_Processed_Data/state_imports_exports.csv`
4. `1-Intermediate_Processed_Data/country_country_step_.csv`
5. `0-Raw_Data//Agriculture_Census/data_agriculture.csv`
6. `0-Raw_Data//Agriculture_Census//data_fish.csv`
7. `1-Intermediate_Processed_Data/data_services.csv`
8. `1-Intermediate_Processed_Data/state_country_step_y_.csv`
9. `1-Intermediate_Processed_Data/state_country_step_e_.csv`
10. Coefficients from `Country_Gravity_WIOD`
11. `1-Intermediate_Processed_Data/io_shares.csv`
12. `1-Intermediate_Processed_Data/labor_shares_countries.csv`

## Output files

1. `1-Intermediate_Processed_Data/data_agriculture.csv`
2. `1-Intermediate_Processed_Data/agric_mat_B_.csv`
3. `1-Intermediate_Processed_Data/agric_vec_lambda_.csv`
4. `1-Intermediate_Processed_Data//vec_agric_solution_.csv`
5. `1-Intermediate_Processed_Data//Xij_matrix_agric_.csv`


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, warning=FALSE, include=FALSE, message=FALSE, results='hide', cache=FALSE}
# libraries
remove(list = ls())
# vector of libraries to be used
libs <- c( 'dplyr', 'tidyr', 'readstata13', 'haven', 'stringr', 'nleqslv', 'gdata', 'Statamarkdown', 'formattable', 'ggplot2', 'viridis', 'RColorBrewer', 'reshape2', 'foreign', 'readxl', 'writexl', 'rjson', 'read_excel', 'Matrix', 'geodist', 'pracma');
#Installing libraries in case they are not installed
#for( i in length(libs)){ 
  #if( !(libs[i] %in% installed.packages()) ) install.packages( libs ) 
#};
#Loading libraries
lapply( libs, require, character.only=TRUE );
```

# Task 1

## Importing data to R

```{r data-importing}
#General parameters
regions <- read.csv("0-Raw_Data/regions.csv")
regions$region <- as.character(regions$region)
c_names <- regions %>% filter(status == "country", region != "USA")
c_names <- c_names$region

s_names <- regions %>% filter(status == "state") 
s_names <- s_names$region

n_s <- length(s_names)
n_c <- length(c_names)

#sectors
reclass_sectors <- read.csv("0-Raw_Data/sectors.csv")
n_sec <- length(unique(reclass_sectors$final_sector)) -3
reclass_sectors <- reclass_sectors %>% 
  select(final_sector, wiod_sector) %>%
  distinct(wiod_sector, .keep_all = TRUE)

#State to country
state_to_country <- c()
for (yr in 2000:2007) {
  temp <- read.csv(paste('1-Intermediate_Processed_Data//state_country_step_y_', yr, '.csv', sep= ""), header = TRUE, sep = ",", dec = ".")
  state_to_country <- rbind(state_to_country, temp)
}
census_exp <- state_to_country %>%
  filter(sector == n_sec + 2) %>%
  select(-sector)
census_exp <- melt(census_exp, id.var=c("year", "importer"), variable = "origin")

#Country to state
country_to_state <- c()
for (yr in 2000:2007) {
  temp <- read.csv(paste('1-Intermediate_Processed_Data//state_country_step_e_', yr, '.csv', sep= ""), header = TRUE, sep = ",", dec = ".")
  country_to_state <- rbind(country_to_state, temp)
}
census_imp <- country_to_state %>%
  filter(sector == n_sec + 2) %>%
  select(-sector)
census_imp <- melt(census_imp, id.var=c("year", "importer"), variable = "origin")

#WIOD
wiod_base <- c()
for (yr in 2000:2007) {
  wiot <- read.csv(paste('1-Intermediate_Processed_Data//country_country_step_', yr, '.csv', sep= ""), header = TRUE, sep = ",", dec = ".")
  wiod_base <- rbind(wiod_base, wiot)
}

wiod_full <- read.csv("1-Intermediate_Processed_Data//wiot_full.csv")

#CENSUS
census <- read.csv("1-Intermediate_Processed_Data//state_imports_exports.csv")
state_imp_exp_0 <- census %>%
  filter(origin != "AllStates", destination != "AllStates")

#### Agriculture and fish
#Agriculture production states
data_agri <- read.csv("0-Raw_Data//Agriculture_Census//data_agriculture.csv")

#Fish production states
data_fish <- read.csv("0-Raw_Data//Agriculture_Census//data_fish.csv")
######

#Trade distances
data_agriculture <- read.csv("1-Intermediate_Processed_Data//data_services.csv")

data_agriculture <- data_agriculture %>%
  mutate(R_i=NA, E_j=NA)
epsilon <- 0.0001

```


## State's agricultural revenue 

```{r}

#Each state agricultural production is defined as the sum of: i) total exports to other countries (we apply proportionality to Census so that the total US export to country c according to WIOD equals the sum of exports of each state to that country) and ii) the total exports to US states (the sum of these exports across states equals US to US exports in WIOD; this last value is divided between states to obtain ii, according to the Agriculture Census relative state production). 
#Initially, state production (total export) was defined as a fraction of US total export from WIOD, depending on state Agri Census relative production. But, this definition generated some problems, for example, when comparing Alaska's and Illionois's total export to countries with their total export; specifically, the first term was 26 times bigger than the second, when theoretically, the first is a part of the second. This problem may be due to subestimations in their calculation of those states' productions. 
#One way to solve this is to apply the definition used at the beginning, which assumes that the distribution of US total export by state applies as well to US total export to states. One way is to apply this solution only to the states that generate issues, but this would require to apply proportionality again and verify that new problems of the same nature don't arise. Therefore, and for now, the solution will be applied to all states, guaranteeing, by definition, that the issue doesn't occur again. 

##########Component i of state production: export to countries

census_exp <- census_exp %>%
  group_by(year, origin) %>%
  mutate(R_i_1 = sum(value)) %>%
  ungroup() %>%
  distinct(year, origin, .keep_all = TRUE) %>%
  arrange(year, origin) %>%
  select(-importer, -value) %>%
  dplyr::rename(iso_o = origin)

data_agriculture <- data_agriculture %>%
  left_join(census_exp, by=c('year'='year', 'iso_o'='iso_o'))

##########Component ii of state production: export to US states
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# sum of crops, livestock, and fish
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
data_agri<- merge(data_agri,data_fish, by=c("iso_o", "year"))
data_agri <- data_agri %>% 
  arrange(year) %>%
  mutate(R_i = fish_prod + R_i) %>%
  select(-fish_prod)

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# calculating relative state productions
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
data_agri <- data_agri %>%
  dplyr::rename(R_i_2 = R_i) %>%
  group_by(year) %>%
  mutate(tot_US = sum(R_i_2)) %>%
  ungroup() %>%
  mutate(rel = R_i_2/tot_US) 
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# Assigning data to years
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
agri <- c() 
# We use Agriculture Census of 2002 for years 2000-2004 
# and Agriculture Census of 2007 for years 2005-2007
agri_2002 <- data_agri %>% filter(year == 2002)
agri_2007 <- data_agri %>% filter(year == 2007)
for (yr in 2000:2011) {
  if (yr<2005) {
    num  <- agri_2002
  } else {
    num  <- agri_2007  
  }  
  num    <- num %>%
            select(iso_o, rel,R_i_2) %>%
            mutate(year = yr)
  
  agri <- rbind(agri, num)
}
agri$R_i_2  <- NA
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 4. APPLYING PROPORTIONALITY TO WIOD
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
## SUM OF PRODUCTIONS ACROSS STATES = TOTAL PRODUCTION OF US ACCORDING TO WIOD

##
## 4.1 TOTAL PRODUCTION OF US IN AGRICULTURE ACCORDING TO WIOD
## 

wiod_agri <- wiod_full %>%
  filter(row_country == "USA", col_country == "USA", row_item == (n_sec + 2)) %>%
  group_by(year) %>%
  mutate(production = sum(value)) %>%
  ungroup() %>%
  distinct(year, .keep_all = TRUE) %>%
  select(-value, -col_item, -col_country)

##
## 4.2 DIVIDING TOTAL US PRODUCTION ACROSS STATES ACCORDING TO RELATIVE IMPORTANCE IN CENSUS
## 

for (yr in 2000:2011) {
  wiod_value  <- wiod_agri %>%
                 filter(year == yr)
  wiod_value  <- wiod_value$production[1]
  agri        <- agri %>%
                 mutate(R_i_2= ifelse(year == yr, rel*wiod_value, R_i_2))
}
agri <- agri %>% select(-rel)

data_agriculture <- data_agriculture %>%
  left_join(agri, by=c('year'='year', 'iso_o'='iso_o'))
data_agriculture <- data_agriculture %>%
  mutate(R_i = R_i_1 + R_i_2) %>%
  select(-R_i_1, -R_i_2)

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 5. CHECKING
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

##
## 5.1 Check: total production of US states = total US in WIOD
## 

# total production of US states from proportionality 
check_1     <- data_agriculture %>%
               filter(iso_o %in% s_names, year <= 2007) %>%
               distinct(year, iso_o, .keep_all = TRUE) %>%
               group_by(year) %>%
               mutate(total = sum(R_i)) %>%
               ungroup() %>% 
               distinct(year, .keep_all = TRUE) %>%
               select(total, year)

# total production of US states from WIOD 
check_2     <- wiod_full %>%
               filter(row_country == "USA", row_item == (n_sec + 2), year <= 2007) %>%
               group_by(year) %>%
               mutate(production = sum(value)) %>%
               ungroup() %>%
               distinct(year, .keep_all = TRUE) %>%
               select(production, year)
#check
if(abs(sum(check_2$production / check_1$total-1))>epsilon)
   stop(paste("states' production does not add to WIOD for"))


```


## Agricultural revenue and expenditure for countries

```{r prod-exp-countries}
#agricultural production for countries 
wiod_p <- wiod_full %>%
  filter(row_item == n_sec + 2) %>%
  group_by(year, row_country) %>%
  mutate(production = sum(value)) %>%
  ungroup() %>%
  distinct(year, row_country, .keep_all = TRUE) %>%
  dplyr::rename(iso_o = row_country) %>%
  select(year, iso_o, production)

data_agriculture <- data_agriculture %>%
  left_join(wiod_p, by=c('year'='year', 'iso_o'='iso_o')) %>%
  mutate(R_i = ifelse(iso_o %in% c_names, production, R_i))
  

#agricultural consumption for countries 
wiod_c <- wiod_full %>%
  filter(row_item == n_sec + 2) %>%
  group_by(year, col_country) %>%
  mutate(consumption = sum(value)) %>%
  ungroup() %>%
  distinct(year, col_country, .keep_all = TRUE) %>% 
  dplyr::rename(iso_d = col_country) %>%
  select(year, iso_d, consumption)

data_agriculture <- data_agriculture %>%
  left_join(wiod_c, by=c('year'='year', 'iso_d'='iso_d')) %>%
  mutate(E_j = ifelse(iso_d %in% c_names, consumption, E_j)) %>%
  select(-production, -consumption)
  
#saving
data_agriculture <- data_agriculture %>%
  arrange(year, iso_o, iso_d)
write.table(data_agriculture, file = paste("1-Intermediate_Processed_Data//data_agriculture.csv", sep=""), sep = ",", row.names = FALSE)
```


# Task 2

## Theory

Start with the standard gravity equation,
$$
X_{ij}=\left(\frac{w_{i}\tau_{ij}}{P_{j}}\right)^{-\varepsilon}X_{j}.
$$
Define: $\Pi_{i}^{-\varepsilon}=\sum_{j}\tau_{ij}^{-\varepsilon}P_{j}^{\varepsilon}X_{j}$. Let $\tilde{P}_{j}\equiv P_{j}^{-\varepsilon}$ and $\tilde{\Pi}_{i}\equiv\Pi_{i}^{-\varepsilon}, and \tilde{\tau}_{ij}\equiv\tau_{ij}^{-\varepsilon}$. Then we have the system
$$
\tilde{P}_{j}=\sum_{i}\tilde{\tau}_{ij}\tilde{\Pi}_{i}^{-1}Y_{i} \nonumber
$$

$$
\tilde{\Pi}_{i}=\sum_{j}\tilde{\tau}_{ij}\tilde{P}_{j}^{-1}X_{j}
$$

So far this is the same we had before. Given $\{X_{j}\}$ and $\{Y_{i}\}$ and $\{\tilde{\tau}_{ij}\}$ then from here one can get $\{\tilde{P}_{j}\}$ and $\{\tilde{\Pi}_{i}\}$. Then we get $\{X_{ij}\}$ from 
$$
X_{ij}=\tilde{\tau}_{ij}\tilde{\Pi}_{i}^{-1}\tilde{P}_{j}^{-1}Y_{i}X_{j}
$$
See explanation for agriculture gravity system in paper, and also see the services gravity system math.  

## Importing data to R

```{r data, warning=FALSE}
# COEFFIENTS FROM REGRESSIONS
own_dummy <- 4.143
dist_coeff <- -1.745

data_gravity_agriculture.base <- read.csv(file = "1-Intermediate_Processed_Data//data_agriculture.csv", header = TRUE, sep = ",")
data_gravity_serv.base <- read.csv(file = "1-Intermediate_Processed_Data//data_services.csv", header = TRUE, sep = ",")

wiot_full <- wiod_full

#State to country
state_to_country <- c()
for (yr in 2000:2007) {
  temp <- read.csv(paste('1-Intermediate_Processed_Data//state_country_step_y_', yr, '.csv', sep= ""), header = TRUE, sep = ",", dec = ".")
  state_to_country <- rbind(state_to_country, temp)
}
census_exp <- state_to_country %>%
  filter(sector == n_sec + 2) %>%
  select(-sector)
census_exp <- melt(census_exp, id.var=c("year", "importer"), variable = "origin")

#Country to state
country_to_state <- c()
for (yr in 2000:2007) {
  temp <- read.csv(paste('1-Intermediate_Processed_Data//state_country_step_e_', yr, '.csv', sep= ""), header = TRUE, sep = ",", dec = ".")
  country_to_state <- rbind(country_to_state, temp)
}
census_imp <- country_to_state %>%
  filter(sector == n_sec + 2) %>%
  select(-sector)
census_imp <- melt(census_imp, id.var=c("year", "importer"), variable = "origin")

```

## Creating and solving gravity system for agriculture

```{r warning=FALSE}

for (yr in 2000:2007) {

  ## Gravity data csv format with comma as the separator
  data_gravity_agriculture <- data_gravity_agriculture.base %>%
    filter(year == yr) %>%
    select(-year) %>%
    mutate(iso_o = as.character(iso_o), iso_d = as.character(iso_d)) %>%
    mutate(
      len_o = ifelse(nchar(iso_o) < 4, "COUNTRY", "STATE"),
      len_d = ifelse(nchar(iso_d) < 4, "COUNTRY", "STATE")
    )
  data_gravity_serv <- data_gravity_serv.base %>%
    filter(year == yr) %>%
    select(-year)
  # %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  # 1. ID OF STATES AND COUNTRIES
  # %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  # States
  id_states <- data_gravity_agriculture %>%
    filter(len_o == "STATE") %>%
    select(iso_o) %>%
    distinct(iso_o) %>%
    arrange(iso_o) %>%
    mutate(id = row_number()) %>%
    dplyr::rename(region = iso_o) %>%
    select(id, region)
  # Countries
  id_countries <- data_gravity_agriculture %>%
    filter(len_o == "COUNTRY" & iso_o!= "USA") %>%
    select(iso_o) %>%
    distinct(iso_o) %>%
    arrange(iso_o) %>%
    mutate(id = n_s + row_number()) %>%
    dplyr::rename(region = iso_o) %>%
    select(id, region)
  # Total
  id_total <- rbind(id_states, id_countries)
  state_names <- id_total$region[1:n_s]
  # t(id.total)
  # %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  # 2. PRODUCTION AND EXPENDITURE: services and agriculture
  # %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  # GDP VECTOR: services and agriculture
  gdp_vector_serv <- data_gravity_serv %>%
    select(iso_o, R_i) %>%
    distinct(iso_o, .keep_all = TRUE) %>%
    left_join(y = id_total, by = c("iso_o" = "region")) %>%
    select(id, R_i) %>%
    arrange(id)
  gdp_vector_serv <- matrix(gdp_vector_serv$R_i)
  gdp_vector_serv_s <- data.frame(gdp_vector_serv[1:n_s])
  gdp_vector_serv_s$sector <- n_sec + 1
  gdp_vector_serv_s$exporter <- state_names
  colnames(gdp_vector_serv_s) <- c("export", "sector", "exporter")
  gdp_vector_agri <- data_gravity_agriculture %>%
    select(iso_o, R_i) %>%
    distinct(iso_o, .keep_all = TRUE) %>%
    left_join(y = id_total, by = c("iso_o" = "region")) %>%
    select(id, R_i) %>%
    arrange(id)
  gdp_vector_agri <- matrix(gdp_vector_agri$R_i)
  gdp_vector_agri_s <- data.frame(gdp_vector_agri[1:n_s])
  gdp_vector_agri_s$sector <- n_sec + 2
  gdp_vector_agri_s$exporter <- state_names
  colnames(gdp_vector_agri_s) <- c("export", "sector", "exporter")

  # Expenditure vector: services
  expenditure_vector_serv <- data_gravity_serv %>%
    select(iso_d, E_j) %>%
    distinct(iso_d, .keep_all = TRUE) %>%
    left_join(y = id_total, by = c("iso_d" = "region")) %>%
    select(id, E_j) %>%
    arrange(id)
  expenditure_vector_serv <- matrix(expenditure_vector_serv$E_j)
  expenditure_vector_serv_s <- data.frame(expenditure_vector_serv[1:n_s])
  expenditure_vector_serv_s$sector <- n_sec + 1
  expenditure_vector_serv_s$importer <- state_names
  colnames(expenditure_vector_serv_s) <- c("import", "sector", "importer")
  expenditure_vector_serv_s <- expenditure_vector_serv_s %>% select(importer, sector, import)

  # %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  # 3. share of US agriculture consumption to total US consumption (\gamma)
  # %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  wiot_full_0 <- wiot_full %>%
    filter(year == yr, col_item == 0 & col_country == "USA")
  wiot_full_1 <- wiot_full_0 %>%
    group_by(year, col_country) %>%
    mutate(C_us = sum(value)) %>%
    ungroup() %>%
    distinct(year, col_country, .keep_all = TRUE)
  wiot_full_2 <- wiot_full_0 %>%
    filter(row_item == n_sec + 2) %>%
    group_by(year, col_country) %>%
    mutate(C_us_agri = sum(value)) %>%
    ungroup() %>%
    distinct(year, col_country, .keep_all = TRUE)
  C_us <- wiot_full_1$C_us
  C_us_agri <- wiot_full_2$C_us_agri
  gamma <- C_us_agri / C_us
  # gamma
  frac_gamma <- gamma / (1 - gamma)

  # %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  # 4. CALCULATING E_j FOR AGRICULTURE
  # %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  ##
  ## 4.1 sum.14: first component in E_j
  ##
  io_shares <- read.csv(file = paste("1-Intermediate_Processed_Data//io_shares", yr, ".csv", sep = ""))
  labor_shares <- read.csv(file = paste("1-Intermediate_Processed_Data//labor_shares_countries", yr, ".csv", sep = ""))

  io_0 <- io_shares %>%
    filter(region == "USA", sector == n_sec + 2) %>%
    select(-year, -region, -sector)

  labor_shares_0 <- labor_shares %>%
    filter(region == "USA") %>%
    select(-year, -region)

  phi_14 <- io_0 * (1 - labor_shares_0)

  state_state <- read.csv(paste("1-Intermediate_Processed_Data//state_cfs_step_", yr, ".csv", sep = ""), header = TRUE, sep = ",", dec = ".")
  state_country_y <- data.frame(read.csv(paste("1-Intermediate_Processed_Data//state_country_step_y_", yr, ".csv", sep = ""), header = TRUE, sep = ",", dec = ".")) %>% filter(sector <= n_sec)
  state_country_e <- data.frame(read.csv(paste("1-Intermediate_Processed_Data//state_country_step_e_", yr, ".csv", sep = ""), header = TRUE, sep = ",", dec = ".")) %>% filter(sector <= n_sec)
  state_exports <- rbind(state_state, state_country_y)
  exp_v <- c()
  for (sec in 1:n_sec) {
    state_exports_1 <- state_exports %>%
      filter(sector == sec) %>%
      select(-year, -importer, -sector)
    export <- matrix(colSums(state_exports_1))
    export <- data.frame(export)
    export$sector <- sec
    export$exporter <- state_names
    exp_v <- rbind(exp_v, export)
  }
  # TOTAL R_i PER STATE
  gdp_tot_v <- rbind(exp_v, gdp_vector_serv_s, gdp_vector_agri_s)
  US_sum <- gdp_tot_v %>%
    group_by(sector) %>%
    mutate(total_R = sum(export)) %>%
    ungroup() %>%
    distinct(sector, .keep_all = TRUE) %>%
    select(sector, total_R)
  ##
  ## Checking US totals
  ##
  US_totals <- wiod_base %>%
    filter(year == yr) %>%
    select(year, importer, sector, USA) %>%
    group_by(year, sector) %>%
    mutate(total = sum(USA)) %>%
    ungroup() %>%
    distinct(year, sector, .keep_all = TRUE) %>%
    select(sector, total)
  # check
  if (sum(abs(US_sum$total_R / US_totals$total - 1)) > epsilon) {
    stop(paste("sum(R_i) over states != US WIOD for year", yr))
  }
  ##
  ## 4.2 CALCULATING \sum_{s}\phi_{14,s}Y_{j,s} (SUM OF INTERMEDIATE USES IN AGRIC) FOR EACH STATE
  ##
  # reshaping gdp.tot.v
  gdp_tot_v_mat <- spread(gdp_tot_v, sector, export, fill = NA, convert = TRUE, drop = TRUE, sep = NULL)
  gdp_tot_v_mat <- t(gdp_tot_v_mat[, -1])
  class(gdp_tot_v_mat) <- "numeric"

  # product of a 1x14 row vect with \phi_{14,s} and a 14x50 matrix with the Y_j,s
  sum_14 <- as.matrix(phi_14) %*% gdp_tot_v_mat
  sum_14 <- t(sum_14) # i confirmed this is the same as the other calculation

  ##
  ## 4.3 sum.not.14: second component in E_j
  ##

  # E_j for all other sectors
  state_imports <- cbind(state_state[4:dim(state_state)[2]], state_country_e[4:dim(state_country_e)[2]])
  expenditure_state <- rowSums(state_imports)
  expenditure_state <- cbind(state_state[2:3], expenditure_state)
  colnames(expenditure_state) <- c("importer", "sector", "import")
  expenditure_vector <- rbind(expenditure_state, expenditure_vector_serv_s) # sec: 1-13
  colnames(expenditure_vector) <- c("importer", "r", "import")

  expenditure_mat <- spread(expenditure_vector, importer, import, fill = NA, convert = FALSE, drop = TRUE, sep = NULL) %>% select(-r)
  expenditure_mat <- t(expenditure_mat)
  ##
  ## checking that expenditure adds up to WIOD totals
  ##
  # expend states
  exp_states <- colSums(expenditure_mat)
  # expend from WIOD

  US_totals <- wiod_base %>%
    filter(year == yr, importer == "USA", sector != 14) %>%
    select(-year, -importer, -sector)
  US_totals <- rowSums(US_totals)
  # check
  if (sum(abs(exp_states / US_totals - 1)) > epsilon) {
    stop(paste("sum(E_j) over states (except agric) != US WIOD for year", yr))
  }

  # IO shares
  io_shares <- read.csv(file = paste("1-Intermediate_Processed_Data//io_shares", yr, ".csv", sep = "")) %>%
    filter(region == "USA") %>%
    select(-year, -region, -sector)
  labor_shares <- read.csv(file = paste("1-Intermediate_Processed_Data//labor_shares_countries", yr, ".csv", sep = "")) %>%
    filter(region == "USA") %>%
    select(-year, -region)
  labor_shares <- matrix(data = rep(as.matrix(labor_shares), (n_sec + 2)), nrow = (n_sec + 2), byrow = TRUE)


  phi_ks <- io_shares * (1 - labor_shares)

  # sum for all receiving sectors
  sum_not_14_v <- as.matrix(phi_ks) %*% gdp_tot_v_mat
  sum_not_14_v <- as.data.frame(t(sum_not_14_v)) %>%
    select(-assign(paste("V", n_sec + 2, sep = ""), n_sec + 2)) 
  # sum over r
  sum_not_14_vector <- as.data.frame(rowSums(expenditure_mat - sum_not_14_v))

  ##
  ## first part of the sum + total agric US consumption = E_j for the US in agric
  ##
  check1 <- wiod_base %>%
    filter(year == yr, importer == "USA", sector == (n_sec + 2))
  c1 <- check1[4:dim(check1)[2]]
  c2 <- sum(sum_14) + C_us_agri
  if (abs(sum(c1) / c2 - 1) > epsilon) {
   stop(paste("problem with sum.14 year", yr))
  }
  ##
  ## second part of the sum needs to add up to total US consumption
  ##
  if (abs(C_us_agri / sum(frac_gamma * sum_not_14_vector) - 1) > epsilon) {
    stop(paste("second part of the summ does not add to total consumption year", yr))
  }
  
  ##
  ## 4.4 final computation for E_j
  ##
  E_j <- sum_14 + (frac_gamma * sum_not_14_vector)
  
   # check: sum(E_j)=WIOD
  c1 <- sum(c1)
  c2 <- sum(E_j)
  if (abs(c1 / c2 - 1) > epsilon) {
    stop(paste("sum(E_j) over states != US WIOD for year", yr))
  }
  # %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  # 5. Calculating lambda and B matrix for the system
  # %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  #
  # 5.1 DISTANCE MATRIX
  #
  dist_matrix <- data_gravity_agriculture %>%
    select(iso_o, iso_d, dist) %>%
    filter(iso_d != "USA" & iso_o != "USA") %>%
    left_join(y = id_total, by = c("iso_o" = "region")) %>%
    dplyr::rename(id_o = id) %>%
    left_join(y = id_total, by = c("iso_d" = "region")) %>%
    dplyr::rename(id_d = id) %>%
    select(id_o, id_d, dist) %>%
    arrange(id_o, id_d) %>%
    spread(key = id_d, value = dist)
  dist_matrix <- as.matrix(dist_matrix[, 2:(n_c + n_s + 1)])
  # we use the coefficients from Country_Gravity_WIOD.
  phi <- diag(x = own_dummy, n_c + n_s, n_c + n_s)
  phi <- exp(phi)
  phi <- phi * dist_matrix^dist_coeff
  dist_matrix <- phi

  #
  # 5.2 lambda vector
  #

  # lambda_j
  expenditure_vector_agri_s <- (as.matrix(E_j))
  state_imports_from_countries <- spread(census_imp, origin, value, fill = NA, convert = FALSE, drop = TRUE, sep = NULL)
  state_imports_from_countries <- state_imports_from_countries %>%
    filter(year == yr) %>%
    select(-year, -importer)
  state_imports_from_countries <- state_imports_from_countries / expenditure_vector_agri_s
  lambda_j <- 1 - rowSums(state_imports_from_countries)

  # chi_i
  gdp_vector_agri_s <- (as.matrix(gdp_vector_agri_s$export))
  state_exports_to_countries <- spread(census_exp, importer, value, fill = NA, convert = FALSE, drop = TRUE, sep = NULL)
  state_exports_to_countries <- state_exports_to_countries %>%
    filter(year == yr) %>%
    select(-year, -origin)
  state_exports_to_countries <- state_exports_to_countries / gdp_vector_agri_s
  chi_i <- 1 - rowSums(state_exports_to_countries)

  # lambda vector
  lambda_vector <- rbind(as.matrix(lambda_j), as.matrix(chi_i))

  #
  # 5.3 BIG MATRIX B
  #

  # Matrices X and Y
  mat_Y <- matrix(data = rep(gdp_vector_agri_s, (n_s)), nrow = (n_s), byrow = TRUE)
  mat_X <- matrix(data = rep(expenditure_vector_agri_s, (n_s)), nrow = (n_s), byrow = TRUE)

  ## Submatrices: TX and TY
  # phi*Y submatrices
  phi_Y_ss <- dist_matrix[(1:n_s), (1:n_s)] * mat_Y
  # phi*X submatrices
  phi_X_ss <- dist_matrix[(1:n_s), (1:n_s)] * mat_X

  # Big zeros matrices
  zeros_big <- matrix(data = rep(0, (n_s) * (n_s)), nrow = (n_s), ncol = (n_s))

  # Relevant matrix
  BIG_MAT <- rbind(
    cbind(zeros_big, phi_Y_ss),
    cbind(phi_X_ss, zeros_big)
  )
  # %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  # 6. SOLVING THE SYSTEM
  # %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


  ### Saving input matrices for the matlab code
  write.csv(BIG_MAT, file = paste("1-Intermediate_Processed_Data//agric_mat_B_", yr, ".csv", sep = ""), row.names = FALSE, na = "")
  write.csv(lambda_vector, file = paste("1-Intermediate_Processed_Data//agric_vec_lambda_", yr, ".csv", sep = ""), row.names = FALSE, na = "")


## Gravity Systems

# Agriculture gravity

BIG.MAT <- as.matrix(read.csv(paste('1-Intermediate_Processed_Data//agric_mat_B_',yr, '.csv', sep= "")))
lambda_vector <- as.matrix(read.csv(paste('1-Intermediate_Processed_Data//agric_vec_lambda_',yr, '.csv', sep= "")))
lb= 0.00001
ub= 10000000

# This function solves the equilibrum system to construct the data for
# RUV using a gravity approach 
gravity_system <- function(x){
    Bfirst <- ( ((lambda_vector*x) / (BIG.MAT%*%(x^(-1)))) -1)*100
    Bsecond <- x[1] - 100
    B <- as.matrix(rbind(Bfirst, Bsecond))
    #B[B >= ub & B <= lb] <- ub # bounds
    #B <- B
    
}
start <- 100*matrix(0.6, 2*n_s, 1)
if (yr > 2000){start <- as.matrix(sol)}

sol <- lsqnonlin(gravity_system, start)
sol <- as.matrix(sol$x)

#residuals
residuals <- (lambda_vector*sol) - (BIG.MAT %*% (sol^(-1)))
print(sum(residuals))

write.csv(sol, file= paste('1-Intermediate_Processed_Data//vec_agric_solution_',yr, '.csv', sep= ""), row.names=FALSE, na="" );


# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  ### SOLUTION FROM MATLAB
  # %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  SOL <- as.matrix(read.csv(paste("1-Intermediate_Processed_Data//vec_agric_solution_", yr, ".csv", sep = "")))
  SOL <- (as.matrix(SOL))[1:(n_s * 2)]
  # checking
  value <- lambda_vector * SOL - BIG.MAT %*% SOL^{-1}
  if (norm(value, "2") > epsilon) {
    stop(paste("Solution from Matlab does not seem to work for year", yr))}

  x <- SOL
  ## calculating Xij
  ### Basic vector
  P.s <- as.matrix(x[1:n_s])
  Pi.s <- as.matrix(x[(n_s + 1):(2 * n_s)])

  ### Inverted basic
  P.s.inv <- P.s^(-1)
  Pi.s.inv <- Pi.s^(-1)

  # E_j
  E_j <- as.matrix(E_j)

  # dist matrix
  dist_matrix <- dist_matrix[(1:n_s), (1:n_s)]

  # %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  # 9. COMPUTING BILATERAL FLOWS

  # Calculating flows
  Pi.sq.mat <- matrix(
    data = rep(Pi.s.inv * gdp_vector_agri_s, (n_s)),
    nrow = (n_s), ncol = (n_s), byrow = TRUE
  )
  P.sq.mat <- matrix(
    data = rep(P.s.inv * E_j, (n_s)),
    nrow = (n_s), ncol = (n_s), byrow = FALSE
  )
  # consistent with WIOD notation
  Xij.matrix <- Pi.sq.mat * dist_matrix * P.sq.mat
  write.csv(Xij.matrix, file = paste("1-Intermediate_Processed_Data//Xij_matrix_agric_", yr, ".csv", sep = ""), row.names = FALSE, na = "")


  # 10. FINAL CHECKS

  # CHECK: US consumption from US =US consumption from US from WIOD
  value1 <- sum(Xij.matrix[(1:n_s), (1:n_s)])
  value2 <- wiod_base %>%
    filter(sector == (n_sec + 2), year == yr, importer == "USA") %>%
    select(-importer, -sector, -year)
  value2 <- value2$USA
  # checking
  if (abs(value1 / value2 - 1) > epsilon) {
    stop(paste(" US consumption from US != value from WIOD for", yr, " value=", abs(value1 / value2 - 1)))
  }

}
```
