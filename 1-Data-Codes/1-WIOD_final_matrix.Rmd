---
title: "1-WIOD_final_matrix"
output:
  html_notebook:
    toc: yes
    df_print: paged
    number_sections: yes    
  pdf_document:
    number_sections: yes
  word_document: default
header-includes:
- \usepackage{amsmath}
- \usepackage{amssymb}
- \usepackage{pifont}
- \usepackage{mathpazo}
---

# General information

Takes WIOD and maps to the 14 relevant sectors that we consider

## Input files

1. `0-Raw_Data/regions.csv`
2. `0-Raw_Data/sectors.csv`
3. `Intermediate_Processed_Data/WiodFixAgg, i,".csv`
4. `1-Intermediate_Processed_Data/wiot_full.csv`

## Output files

1. `Intermediate_Processed_Data/WiodFixAgg, i,".csv`
2. `1-Intermediate_Processed_Data/wiot_full.csv`
3. `1-Intermediate_Processed_Data//WIOD_countries.csv`


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
remove(list = ls())
```

```{r packages, warning=FALSE, include=FALSE, message=FALSE, results='hide', cache=FALSE}
# libraries
options( scipen=100, stringsAsFactors=FALSE );
# vector of libraries to be used
libs <- c( 'dplyr', 'tidyr', 'readstata13', 'haven', 'stringr', 'nleqslv', 'gdata', 'Statamarkdown', 'read_excel', 'readxl', 'Matrix', 'reshape2');
# Install libraries in case they are not installed
#for( i in length(libs)){ 
#if( !(libs[i] %in% installed.packages()) ) install.packages( libs ) 
#};
# load library
lapply( libs, require, character.only=TRUE );
```


## Importing datasets to R

```{r data, warning=FALSE}
regions <- read.csv(paste("0-Raw_Data/regions.csv", sep=""), header = TRUE, sep = ",", dec = ".")

reclass_sectors <- read.csv(paste("0-Raw_Data/sectors.csv", sep=""), header = TRUE, sep = ",", dec = ".")

```


## Fixing WIOD

```{r}
N <- 41   # Number of countries in WIOD
S <- 35   # Number of sectors in WIOD
list <- c("00", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11")
k <- "apr"
count <- 1

for (i in list){
if(count >= 9){k = "sep"}
count <- count+1
#names of rows  
names1 <- as.matrix(read_excel(paste("0-Raw_Data/WIOD/wiot", i,"_row_", k,"12.xlsx", sep=""), range = "C7:C1441", col_names = FALSE))
names2 <- as.matrix(read_excel(paste("0-Raw_Data/WIOD/wiot", i,"_row_", k,"12.xlsx", sep=""), range = "D7:D1441", col_names = FALSE))
names_rows <- as.matrix(paste(names1, names2, sep=""))  
#names of columns
names1 <- as.matrix(read_excel(paste("0-Raw_Data/WIOD/wiot", i,"_row_", k,"12.xlsx", sep=""), range = "E5:BKF5", col_names = FALSE))
names2 <- as.matrix(read_excel(paste("0-Raw_Data/WIOD/wiot", i,"_row_", k,"12.xlsx", sep=""), range = "E6:BKF6", col_names = FALSE))
names_cols <- t(as.matrix(paste(names1, names2, sep="")))
names_cols <- cbind(" ", names_cols)

# Import data
wiodTradeMatrixIO <- as.matrix(read_excel(paste("0-Raw_Data/WIOD/wiot", i,"_row_", k,"12.xlsx", sep=""), range = "E7:BKF1441", col_names = FALSE)) 
# Set zero flows equal to a small number
wiodTradeMatrixIO[wiodTradeMatrixIO == 0] <- 0.0000001   
# unadjusted data on intermediate input flows
Zinit <- wiodTradeMatrixIO[ ,1:1435]  
# unadjusted data on both flows of intermediate and final goods
Xinit <- wiodTradeMatrixIO       
# unadjusted total output
Rinit <- rowSums(Xinit)                                                      
# Adjust for negative inventory changes. See Handbook chapter (online appendix, page 15, footnote 1) for details.
# We model production as Rinit = A*Rinit + FINsum (where A is calculated by Zinit= A * diag(Rinit))
# With the adjustment below we will have R = A*R + Fsum (where again Z = A * diag(R) with no negative final consumption)

# Matrix of final demand and inventories adjustment
FIN <- Xinit[, (1436:dim(Xinit)[2])]      
# This is only needed for checks
FINsum <- rowSums(FIN)     
# Positive component of final demand (becomes final demand after correcting for INV<0)
F <- FIN
F[F < 0] <- 0 
# Initial final demand (remains the same)
Fsum <- rowSums(F) 
# Estimate matrix on direct input coefficients (small number is added to avoid NaN for zero-sectors)
A <- Zinit %*% solve(diag(Rinit))  
# Compute a new vector of total output under zero decline in inventories
R <- as.vector(solve((diag(N*S)-A),Fsum))    
# Compute a new matrix of intermediate goods flows
diagR <- diag(R)
A <- Matrix(A, sparse=TRUE)
diagR <- Matrix(diagR, sparse=TRUE)
Z <- A %*% diagR    
# Both flows of intermediate and final goods
X <- cbind(Z,F)
X <- as.matrix(X)
# Save data to excel spreadsheet
final <- cbind(names_rows, X)
final <- rbind(names_cols, final)
write.table(final, file = paste("1-Intermediate_Processed_Data/WiodFixAgg", i,".csv", sep=""), sep = ",", row.names = FALSE)
}

```


## Wiod full (long format)

```{r}
#sector reclassification table
reclass_sectors <- reclass_sectors %>% 
  select(final_sector, wiod_sector) %>%
  distinct(wiod_sector, .keep_all = TRUE)

list <- c("00", "01", "02", "03", "04", "05", "06", "07")
yr <- 2000
final <- c()
for (i in list){
print(yr)
wiod_full <- read.csv(paste("1-Intermediate_Processed_Data/WiodFixAgg", i,".csv", sep=""), header = TRUE, sep = ",", dec = ".")

col_names <- as.matrix(wiod_full[1, ])
col_names[1,1] <- "row"
colnames(wiod_full) <- col_names
wiod_full <- wiod_full[(2:dim(wiod_full)[1]),]

wiod_full <- melt(wiod_full, id.vars=c("row"), variable.name="col", value.name = "value")

wiod_full <- wiod_full %>% 
  mutate(row_country = substr(x=row, start=1, stop=3)) %>%
  mutate(col_country = substr(x=col, start=1, stop=3)) %>%
  mutate(row_item = as.numeric(substr(x=row, start=5, stop=6))) %>%
  mutate(col_item = as.numeric(substr(x=col, start=5, stop=6))) %>%
  filter(row_country != "LVA" & row_country != "LUX" & row_country != "MLT") %>%
  filter(col_country != "LVA" & col_country != "LUX" & col_country != "MLT") %>%
  filter(row_item != 17 & row_item != 31 & row_item != 35) %>%
  filter(col_item != 17 & col_item != 31 & col_item != 35) %>%
  select(-row, -col) %>%
  mutate(year = yr) %>%
  select(year, row_country, col_country, row_item, col_item, value) %>%
  arrange(year, row_country, col_country, row_item, col_item) %>%
  mutate(row_country = ifelse(row_country == "ROM", "ROU", row_country)) %>%
  mutate(col_country = ifelse(col_country == "ROM", "ROU", col_country))

#Reclassification table
#1.	(NAICS 311-312) Food Products, Beverage, and Tobacco Products (c3);
#2.	(NAICS 313-316) Textile, Textile Product Mills, Apparel, Leather, and Allied Products (c4-c5);
#3.	(NAICS 321-323) Wood Products, Paper, Printing, and Related Sup- port Activities (c6-c7); 
#4.	(NAICS 211-213, 324) Petroleum and Coal Products (c8);
#Mining, Quarrying, and Oil and Gas Extraction (c2). 
#5.	(NAICS 325) Chemical (c9);
#6.	(NAICS 326) Plastics and Rubber Products (c10); 
#7.	(NAICS 327) Nonmetallic Mineral Products (c11); 
#8.	(NAICS 331-332) Primary Metal and Fabricated Metal Products (c12); 
#9.	(NAICS 333); Machinery (c13); 
#10.	(NAICS 334-335) Computer and Electronic Products, and Electrical Equipment and Appliances (c14);
#11.	(NAICS 336) Transportation Equipment (c15); 
#12.	(NAICS 337-339) Furniture and Related Products, and Miscellaneous Manufacturing (c16); 
#13.	((NAICS 23) Construction (c18); 
#14.	(NAICS 42-45) Wholesale and Retail Trade (c19-c21); 
#15.	(NAICS 481-488) Transport Services (c23-c26);
#16.	(NAICS 511-518) Information Services (c27);
#17.	(NAICS 521-525) Finance and Insurance (c28); 
#18.	(NAICS 531-533)  Real Estate (c29-c30); 
#19.	(NAICS 61) Education (c32); 
#20.	(NAICS 621-624) Health Care (c33);
#21.	(NAICS 721-722) Accommodation and Food Services (c22); 
#22.	(NAICS 493, 541, 55, 561, 562, 711-713, 811-814) Other Services (c34).
#23.	(NAICS 111-115) Agriculture, Forestry, Fishing, and Hunting (c1)  
  
#wiod sectors to final sectors   
wiod_full$value <- as.numeric(wiod_full$value)
wiod_full <- wiod_full %>%
  left_join(reclass_sectors, by=c('row_item'='wiod_sector')) %>%
  select(-row_item) %>%
  dplyr::rename(row_item = final_sector) %>%
  left_join(reclass_sectors, by=c('col_item'='wiod_sector')) %>%
  select(-col_item) %>%
  dplyr::rename(col_item = final_sector) %>%
  group_by(year, row_country, col_country, row_item, col_item) %>%
  mutate(tot_value=sum(value)) %>%
  ungroup() %>%
  distinct(year, row_country, col_country, row_item, col_item, .keep_all = TRUE) %>%
  select(-value) %>%
  dplyr::rename(value = tot_value) 
  
final <- rbind(final, wiod_full)  
yr <- yr+1
}

write.table(final, file = paste("1-Intermediate_Processed_Data//wiot_full.csv", sep=""), sep = ",", row.names = FALSE)


```


## WIOD in matrix form

```{r}

regions <- regions %>% 
  filter(status == "country") %>%
  mutate(number = ifelse(region == "USA", 1, number)) %>%
  select(-status) 

wiot_full <- read.csv(paste("1-Intermediate_Processed_Data//wiot_full.csv", sep=""), header = TRUE, sep = ",", dec = ".")

#collapsing by sector origin
wiod_matrix <- wiot_full %>%
  dplyr::rename(sector = row_item) %>%
  group_by(year, sector, row_country, col_country) %>%
  mutate(tot_value = sum(value)) %>%
  ungroup() %>%
  distinct(year, sector, row_country, col_country, .keep_all = TRUE)
  
wiod_matrix <- wiod_matrix %>%  
  left_join(regions, by=c('row_country'='region')) %>%
  dplyr::rename(exporter=number) %>%
  left_join(regions, by=c('col_country'='region')) %>%
  dplyr::rename(importer = number) %>%
  dplyr::rename(importer_country = col_country) %>%
  dplyr::rename(exporter_country = row_country) %>%
  arrange(year, sector, importer, exporter) %>%
  select(-col_item, -exporter, -value)
wiod_matrix$exporter_country <- paste("value", wiod_matrix$exporter_country, sep="_")  
wiod_matrix <- spread(wiod_matrix, exporter_country, tot_value, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)
wiod_matrix <- wiod_matrix %>% select(year, importer_country, sector, importer, value_USA, everything())
wiod_matrix <- wiod_matrix %>% arrange(year, sector, importer)

write.table(wiod_matrix, file = paste("1-Intermediate_Processed_Data//WIOD_countries.csv", sep=""), sep = ",", row.names = FALSE)

```


