---
title: "Bilateral Flows Between Countries"
output:
  html_document:
    df_print: paged
  pdf_document:
    number_sections: yes
header-includes:
- \usepackage{amsmath}
- \usepackage{amssymb}
- \usepackage{pifont}
- \usepackage{mathpazo}
- \newcommand{\xmark}{\ding{55}}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
remove(list = ls())
```

```{r warning=FALSE, include=FALSE, message=FALSE, results='hide', cache=FALSE}
# libraries
options( scipen=100, stringsAsFactors=FALSE );
# vector of libraries to be used
libs <- c( 'dplyr', 'tidyr', 'readstata13', 'haven', 'stringr', 'nleqslv', 'gdata', 'Statamarkdown');
# Install libraries in case they are not installed
for( i in length(libs)){ 
if( !(libs[i] %in% installed.packages()) ) install.packages( libs ) 
};
# load library
lapply( libs, require, character.only=TRUE );
```

##Notation
The dataset "final_matrix_2008" has elements $X_{ij,k}^{Base}$. There are three dimensions: $i$ is the exporter region (in the columns), $j$ is the importer region (in the rows, under the variable "importer"), and $k=1,...,14$ represents the sector. Each region are either US States or Countries (countries are written using 3 letters only. States have their full names).

## General Instructions

To use WIOD data to calculate $X_{ij,k}^{2000}$ for $i\notin US\;  \&\;  j \notin US$, and $\forall k=1,...,14$. I call the output of this part $X_{ij,k}^{Step1}$.


## Importing datasets to R
```{r}
regions <- read_excel("0-Raw_Data/regions.xlsx")
c.names <- regions %>% filter(status=="country")
c.names <- c.names$region

s.names <- regions %>% filter(status=="state") 
s.names <- s.names$region

n.s <- length(s.names)
n.c <- length(c.names) -1


sector.file <- read_excel("0-Raw_Data/sectors.xlsx")
id.sectors <- sector.file %>% 
  select(final_sector, WIOD_sector) %>%
  distinct(WIOD_sector, .keep_all = TRUE)

#WIOD
wiot.full <- read.dta13("1-Intermediate_Processed_Data//wiot_full.dta")
#converting wiod sectors to final sectors
WIOD.base <- wiot.full %>%
  left_join(id.sectors, by=c('row_item'='WIOD_sector')) %>%
  mutate(row_item = final_sector) %>%
  select(-final_sector) %>%
  left_join(id.sectors, by=c('col_item'='WIOD_sector')) %>%
  mutate(col_item = final_sector) %>%
  select(-final_sector) %>%
  arrange(year, row_country, col_country, row_item, col_item) %>%
  group_by(year, row_country, col_country, row_item, col_item) %>% #aggregating repeated r-c sequence
  mutate(value1= sum(value)) %>%
  ungroup() %>%
  distinct(year, row_country, col_country, row_item, col_item, .keep_all = TRUE) %>%
  select(-value) %>%
  dplyr::rename(value=value1)
#colapsing by origin sectors 
WIOD.base <- WIOD.base %>%
  group_by(year, row_country, col_country, row_item) %>%
  mutate(val= sum(value)) %>%
  ungroup() %>%
  distinct(year, row_country, col_country, row_item, .keep_all = TRUE) %>%
  select(-value, -col_item) %>%
  dplyr::rename(value= val)
colnames(WIOD.base) <- c("year", "exporter", "importer", "sector", "value")  
WIOD.base <-spread(WIOD.base, exporter, value, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)
WIOD.base <- WIOD.base %>% arrange(year, sector, importer)
WIOD.base <- data.frame(WIOD.base)
```

## Country-Country Step

For the dataset "WIOD", the elements are defined as $X_{ij,k}^{WIOD}$. As usual, there are three dimensions: $i$ is the exporter country (in the columns), $j$ is the importer country (in the rows, under the variable "importer"), and $k=1,...,14$ represents the sector. 

The matrix we care about is $X_{ij,k}^{Step1}=X_{ij,k}^{WIOD} \quad \forall i\notin US\; \& \; j\notin US$. This means that I only need to take out the first row and the variable "value_USA".
```{r}

for (yr in 2000:2007) {
  Step1 <- WIOD.base %>%
    filter(year==yr) %>%
    select(year, importer, sector, everything())
  #Exporting
  write.table(Step1, file = paste("1-Intermediate_Processed_Data//country_country_step_", yr,".txt", sep=""), sep = ",", row.names = FALSE)
}
```



