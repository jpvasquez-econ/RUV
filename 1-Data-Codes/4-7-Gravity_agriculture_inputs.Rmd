---
title: "Gravity for Agriculture: Inputs for the System"
author: "JP"
date: "April 2, 2020"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##General description

This file generates the inputs of the gravity system for agriculture.

Start with the standard gravity equation,
$$
X_{ij}=\left(\frac{w_{i}\tau_{ij}}{P_{j}}\right)^{-\varepsilon}X_{j}.
$$
Define: $\Pi_{i}^{-\varepsilon}=\sum_{j}\tau_{ij}^{-\varepsilon}P_{j}^{\varepsilon}X_{j}$. Let $\tilde{P}_{j}\equiv P_{j}^{-\varepsilon}$ and $\tilde{\Pi}_{i}\equiv\Pi_{i}^{-\varepsilon}, and \tilde{\tau}_{ij}\equiv\tau_{ij}^{-\varepsilon}$. Then we have the system
$$
\tilde{P}_{j}=\sum_{i}\tilde{\tau}_{ij}\tilde{\Pi}_{i}^{-1}Y_{i} \nonumber
$$

$$
\tilde{\Pi}_{i}=\sum_{j}\tilde{\tau}_{ij}\tilde{P}_{j}^{-1}X_{j}
$$

So far this is the same we had before. Given $\{X_{j}\}$ and $\{Y_{i}\}$ and $\{\tilde{\tau}_{ij}\}$ then from here one can get $\{\tilde{P}_{j}\}$ and $\{\tilde{\Pi}_{i}\}$. Then we get $\{X_{ij}\}$ from 
$$
X_{ij}=\tilde{\tau}_{ij}\tilde{\Pi}_{i}^{-1}\tilde{P}_{j}^{-1}Y_{i}X_{j} \label{eq:Xij}
$$
We don't know $\{X_{j}\}_{j\in US}$. But we know: 1) $\{X_{ij}\}\quad\forall i,j\notin US$ (from WIOD), 2) $\{X_{ij}\}\quad\forall i\notin US\;or\:j\notin US$ (from CENSUS). 

##Libraries
```{r warning=FALSE, include=FALSE, message=FALSE, results='hide', cache=FALSE}
# libraries
remove(list = ls())
options( scipen=100, stringsAsFactors=FALSE );
# vector of libraries to be used
libs <- c( 'dplyr', 'readstata13', 'nleqslv', 'haven', 'tidyverse', 'optimx', 'optimization',
           'optimx', 'tidyr', 'readxl', 'Rcpp', 'DEoptim', 'parallel', 'reshape2');
# Install libraries in case they are not installed
for( i in length(libs)){ 
  if( !(libs[i] %in% installed.packages()) ) install.packages( libs ) 
};
# Carga de bibliotecas
lapply( libs, require, character.only=TRUE );
```
##Data
```{r warning=FALSE, include=FALSE, message=FALSE, results='hide', cache=FALSE}
# OPTIONS AND LIBRARIES
options( scipen=100 );
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#example vs real
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
## real
# number of countries (n.c) and number of states (n.s)
n.c <- 37; 
n.s <- 50; 
WIOD.base <- read.dta13( file="1-Intermediate_Processed_Data//WIOD_countries.dta" )
data_gravity_agriculture.base <- read.csv( file="1-Intermediate_Processed_Data//data_agriculture.csv", header=TRUE, sep="," )
data_gravity_serv.base <- read.csv( file="1-Intermediate_Processed_Data//data_services.csv", header=TRUE, sep="," )
#state level imports and exports
CENSUS.exp <- read.csv("1-Intermediate_Processed_Data//census.exp.agri.proportionality.csv")
CENSUS.imp <- read.csv("1-Intermediate_Processed_Data//census.imp.agri.proportionality.csv")
wiot.full <- read.dta13("1-Intermediate_Processed_Data//wiot_full.dta")
wiot.full=data.frame(wiot.full)
wiot.full <- wiot.full %>% 
  filter(year>=2000, col_country!="LUX", col_country!="LVA", col_country!="MLT", row_country!="LUX", row_country!="LVA", row_country!="MLT") %>% #since distances are available from that year on
  mutate(row_country= ifelse(row_country=="ROM", "ROU", row_country)) %>%
  mutate(col_country= ifelse(col_country=="ROM", "ROU", col_country)) 
epsilon<-0.0001

# # ##################example  (do not run creation of dist.matrix in section 3.1)
# ####################Select the block of code that you want to comment. Press Ctrl + Shift + C.
# example <- read_excel( "2-Final_Data//ejemplo.xlsx")
# WIOD.base <- WIOD.base [1:3, 1:7]
# WIOD.base$value_AUS[2] <- example$`X_{ij}`[1]
# WIOD.base$value_AUS[3] <- example$`X_{ij}`[2]
# WIOD.base$value_AUT[2] <- example$`X_{ij}`[5]
# WIOD.base$value_AUT[3] <- example$`X_{ij}`[6]
# WIOD.base$value_AUS[1] <- example$`X_{ij}`[3] + example$`X_{ij}`[4]
# WIOD.base$value_AUT[1] <- example$`X_{ij}`[7] + example$`X_{ij}`[8]
# WIOD.base$value_USA[2] <- example$`X_{ij}`[9] + example$`X_{ij}`[13]
# WIOD.base$value_USA[3] <- example$`X_{ij}`[10] + example$`X_{ij}`[14]
# WIOD.base$value_USA[1] <- NA
# WIOD.base <- WIOD.base %>%
#   mutate(sector=14)
# data_gravity_agriculture.base <- data_gravity_agriculture.base %>%
#   filter(year==2000, (iso_o=="Alabama" | iso_o=="Alaska" | iso_o=="AUS" | iso_o=="AUT"), (iso_d=="Alabama" | iso_d=="Alaska" | iso_d=="AUS" | iso_d=="AUT") ) %>%
#   mutate(X_j= ifelse(iso_d=="AUS", example$X_j[1], X_j)) %>%
#   mutate(X_j= ifelse(iso_d=="AUT", example$X_j[2], X_j)) %>%
#   mutate(Y_i= ifelse(iso_o=="AUS", example$Y_i[1], Y_i)) %>%
#   mutate(Y_i= ifelse(iso_o=="AUT", example$Y_i[5], Y_i)) %>%
#   mutate(Y_i= ifelse(iso_o=="Alabama", example$Y_i[9], Y_i)) %>%
#   mutate(Y_i= ifelse(iso_o=="Alaska", example$Y_i[13], Y_i))
# data_gravity_agriculture.base$Y_i <- as.numeric((data_gravity_agriculture.base$Y_i))
# data_gravity_agriculture.base$X_j <- as.numeric(as.character(data_gravity_agriculture.base$X_j))
# dist.matrix <- matrix(c(example$phi_ij[11], example$phi_ij[12], example$phi_ij[9], example$phi_ij[10], example$phi_ij[15], example$phi_ij[16], example$phi_ij[13], example$phi_ij[14], example$phi_ij[3], example$phi_ij[4], example$phi_ij[1], example$phi_ij[2], example$phi_ij[7], example$phi_ij[8], example$phi_ij[5], example$phi_ij[6]), nrow=4, ncol=4)
# dist.matrix <- data.frame(dist.matrix)
# colnames(dist.matrix) <- c("1", "2", "3", "4")
# dist.matrix <- matrix(unlist(dist.matrix), ncol = 4, byrow = TRUE)
# n.c <- 2;
# n.s <- 2;
# yr=2000
# CENSUS.exp <- CENSUS.exp %>%
#   filter(year==2000, (origin=="Alabama" | origin=="Alaska"), (importer=="AUS" | importer=="AUT")) %>%
#   mutate(value= ifelse(origin=="Alabama" & importer=="AUS", example$`X_{ij}`[9], value)) %>%
#   mutate(value= ifelse(origin=="Alabama" & importer=="AUT", example$`X_{ij}`[10], value)) %>%
#   mutate(value= ifelse(origin=="Alaska" & importer=="AUS", example$`X_{ij}`[13], value)) %>%
#   mutate(value= ifelse(origin=="Alaska" & importer=="AUT", example$`X_{ij}`[14], value))
# wiot.full <- wiot.full %>%
#   filter(year==2000, (row_country=="AUS" | row_country=="AUT" | row_country=="USA"), (col_country=="AUS" | col_country=="AUT" | col_country=="USA"), row_item==1, col_item==1) %>%
#   mutate(value= ifelse(row_country=="AUS" & col_country=="AUS", WIOD.base$value_AUS[2], value)) %>%
#   mutate(value= ifelse(row_country=="AUS" & col_country=="AUT", WIOD.base$value_AUS[3], value)) %>%
#   mutate(value= ifelse(row_country=="AUS" & col_country=="USA", WIOD.base$value_AUS[1], value)) %>%
#   mutate(value= ifelse(row_country=="AUT" & col_country=="AUS", WIOD.base$value_AUT[2], value)) %>%
#   mutate(value= ifelse(row_country=="AUT" & col_country=="AUT", WIOD.base$value_AUT[3], value)) %>%
#   mutate(value= ifelse(row_country=="AUT" & col_country=="USA", WIOD.base$value_AUT[1], value)) %>%
#   mutate(value= ifelse(row_country=="USA" & col_country=="AUS", WIOD.base$value_USA[2], value)) %>%
#   mutate(value= ifelse(row_country=="USA" & col_country=="AUT", WIOD.base$value_USA[3], value)) %>%
#   mutate(value= ifelse(row_country=="USA" & col_country=="USA", WIOD.base$value_USA[1], value))
# CENSUS.exp$value <- as.numeric(CENSUS.exp$value)
# # ##############################

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
```


Looping over years
```{r warning=FALSE}
for (yr in 2000:2007) {
# 1. LOAD DATA
WIOD<-WIOD.base
## WIOD
WIOD <- WIOD.base %>% 
  filter( year==yr, sector==14 ) %>% 
  filter( importer_country!='USA' ) %>% 
  select( -year, -value_USA, -sector, -importer_country, -importer  ) ;
## Gravity data csv format with comma as the separator
data_gravity_agriculture <- data_gravity_agriculture.base %>% 
  filter( year==yr ) %>% 
  select( -year ) %>% 
  mutate( iso_o=as.character(iso_o), iso_d=as.character(iso_d) ) %>% 
  mutate( len_o=ifelse(nchar(iso_o)<4, 'COUNTRY', 'STATE'), 
          len_d=ifelse(nchar(iso_d)<4, 'COUNTRY', 'STATE') );

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 2. NUMBER STATES AND COUNTRIES
# States
id.states <- data_gravity_agriculture %>% 
  filter( len_o=='STATE' ) %>% 
  select( iso_o ) %>% 
  distinct( iso_o ) %>% 
  arrange( iso_o ) %>% 
  mutate( id=row_number() ) %>% 
  dplyr::rename( region=iso_o ) %>% 
  select( id, region );
# Countries
id.countries <- data_gravity_agriculture %>% 
  filter( len_o=='COUNTRY' ) %>% 
  select( iso_o ) %>% 
  distinct( iso_o ) %>% 
  arrange( iso_o ) %>% 
  mutate( id=n.s+row_number() ) %>% 
  dplyr::rename( region=iso_o ) %>% 
  select( id, region );
# Total
id.total <- rbind( id.states, id.countries );
#t(id.total)

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 3. ELEMENTARY MATRICES FOR KRONECKER PRODUCTS

# 3.1. DISTANCE MATRIX
dist.matrix <- data_gravity_agriculture %>% 
  select( iso_o, iso_d, dist ) %>% 
  left_join( y=id.total, by=c('iso_o'='region') ) %>% 
  dplyr::rename( id_o=id ) %>% 
  left_join( y=id.total, by=c('iso_d'='region') ) %>% 
  dplyr::rename( id_d=id ) %>% 
  select( id_o, id_d, dist ) %>% 
  arrange( id_o, id_d ) %>% 
  spread( key=id_d, value=dist );
dist.matrix <- as.matrix( dist.matrix[,2:(n.c+n.s+1)] );

#we use the coefficients from 4-4-Country_Gravity_WIOD.
#own dummy=4.1, Distance elasticity=-1.8
phi<-diag(x = 4.1, n.c+n.s, n.c+n.s);
phi<-exp(phi);
phi<-phi/dist.matrix^1.8; 
dist.matrix<-phi

# 3.2. GDP VECTOR 
gdp.vector <- data_gravity_agriculture %>% 
  select( iso_o, Y_i ) %>% 
  distinct( iso_o, .keep_all=TRUE ) %>% 
  left_join( y=id.total, by=c('iso_o'='region') ) %>% 
  select( id, Y_i ) %>% 
  arrange( id );
gdp.vector <- as.vector( gdp.vector$Y_i );

# 3.3. EXPENDITURE VECTOR 
exp.vector <- data_gravity_agriculture %>% 
  select( iso_d, X_j ) %>% 
  distinct( iso_d, .keep_all=TRUE ) %>% 
  left_join( y=id.total, by=c('iso_d'='region') ) %>% 
  select( id, X_j ) %>% 
  arrange( id );
exp.vector <- as.vector( exp.vector$X_j );

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 4. BIG MATRICES

# 4.1 Matrices X and Y (repeat gdp and expenditure vectors in ns+nc rows)
mat.Y <- matrix( data=rep(gdp.vector, (n.s+n.c)), nrow=(n.s+n.c), byrow=TRUE );
mat.X <- matrix( data=rep(exp.vector, (n.s+n.c)), nrow=(n.s+n.c), byrow=TRUE );

# 4.2 Submatrices
##phi*Y submatrices
phi.Y.ss <- dist.matrix[(1:n.s), (1:n.s)] * mat.Y[(1:n.s), (1:n.s)];
phi.Y.sc <- dist.matrix[(1:n.s), ((n.s+1):(n.s+n.c))] * mat.Y[(1:n.s), ((n.s+1):(n.s+n.c))];
#phi.Y.cs <- dist.matrix[((n.s+1):(n.s+n.c)), (1:n.s)] * mat.Y[((n.s+1):(n.s+n.c)), (1:n.s)];
phi.Y.cc <- dist.matrix[((n.s+1):(n.s+n.c)), ((n.s+1):(n.s+n.c))] * 
  mat.Y[((n.s+1):(n.s+n.c)), ((n.s+1):(n.s+n.c))];
## phi*X submatrices
#phi.X.ss <- dist.matrix[(1:n.s), (1:n.s)] * mat.X[(1:n.s), (1:n.s)];
phi.X.sc <- dist.matrix[(1:n.s), ((n.s+1):(n.s+n.c))] * mat.X[(1:n.s), ((n.s+1):(n.s+n.c))];
#phi.X.cs <- dist.matrix[((n.s+1):(n.s+n.c)), (1:n.s)] * mat.X[((n.s+1):(n.s+n.c)), (1:n.s)];
phi.X.cc <- dist.matrix[((n.s+1):(n.s+n.c)), ((n.s+1):(n.s+n.c))] * 
  mat.X[((n.s+1):(n.s+n.c)), ((n.s+1):(n.s+n.c))];


#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 5. WIOD MATRIX AND RELATED QUANTITIES

## 5.1 WIOD matrix (d,o)
wiod.matrix <- as.matrix( WIOD );

## 5.2 lambda vector
### imports and exports of countries to countries
exports.to.countries <- as.matrix( apply(X=wiod.matrix, MARGIN=2, FUN=sum) )

wiot.full.c <- wiot.full %>%
  filter(col_country!="USA", row_country!="USA", row_item==1) %>%
  group_by(year, col_country) %>%
  mutate(consumption= sum(value)) %>%
  ungroup() %>%
  distinct(year, col_country, .keep_all = TRUE) 
wiot.full.c <- wiot.full.c %>%
  filter(year==yr) %>%
  arrange(col_country)
imports.from.countries <- matrix(wiot.full.c$consumption);


### shares of imports and exports of countries
X_c <- as.matrix( exp.vector[(n.s+1):(n.s+n.c)] );
Y_s <- as.matrix( gdp.vector[(1):(n.s)] );
Y_c <- as.matrix( gdp.vector[(n.s+1):(n.s+n.c)] );

state.exports.to.countries <- CENSUS.exp %>%
  filter(year==yr) %>%
  group_by(origin) %>%
  mutate(exp= sum(value)) %>%
  ungroup() %>%
  distinct(origin, .keep_all = TRUE) %>%
  arrange(origin)
state.exports.to.countries <- matrix(state.exports.to.countries$exp)


### lambdas and chis
lambda.cj <- imports.from.countries/ X_c;
chi.si <- state.exports.to.countries/Y_s;
chi.ci <- exports.to.countries/Y_c;
### lambda vector
ones.ns <- matrix( data=rep(1, n.s), nrow=n.s, ncol=1 );
lambda_vector <- rbind( ones.ns, lambda.cj, chi.si, chi.ci );

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
## 6.1 Big zeros matrices
zeros.nc.ns <- matrix( data=rep(0, n.c*n.s), nrow=n.c, ncol=n.s );
zeros.ns.ns <- matrix( data=rep(0, n.s*n.s), nrow=n.s, ncol=n.s );
zeros.big <- matrix( data=rep(0, (n.s+n.c)*(n.s+n.c)), nrow=(n.s+n.c), ncol=(n.s+n.c) );

## 6.2 GIANT MATRIX 
### Block for system 10
block.10 <- rbind( cbind(phi.Y.ss, phi.Y.sc),
                   cbind(zeros.nc.ns, phi.Y.cc) );
### Block for system 11
block.11 <- rbind( cbind(zeros.ns.ns, phi.X.sc),
                   cbind(zeros.nc.ns, phi.X.cc) );
### Relevant matrix
BIG.MAT <- rbind( cbind(zeros.big, block.10),
                  cbind(block.11, zeros.big) );

### Saving input matrices for the matlab code
write.csv(BIG.MAT, file= paste('1-Intermediate_Processed_Data//agric_mat_B_',yr, '.csv', sep= ""), row.names=FALSE, na="" );
write.csv(lambda_vector, file= paste('1-Intermediate_Processed_Data//agric_vec_lambda_',yr, '.csv', sep= ""), row.names=FALSE, na="" );
}
```

##NEW SYSTEM
```{r warning=FALSE}
for (yr in 2000:2007) {

#################example: do not run neither section 3.1 dist matrix nor function(x)
example <- read_excel( "1-Intermediate_Processed_Data//ejemplo_new.xlsx")
data_gravity_agriculture.base <- data_gravity_agriculture.base %>%
  filter(year==2000, (iso_o=="Alabama" | iso_o=="Alaska" | iso_o=="AUS" | iso_o=="AUT"), (iso_d=="Alabama" | iso_d=="Alaska" | iso_d=="AUS" | iso_d=="AUT") ) %>%
  mutate(X_j= ifelse(iso_d=="AUS", example$X_j[1], X_j)) %>%
  mutate(X_j= ifelse(iso_d=="AUT", example$X_j[2], X_j)) %>%
  mutate(Y_i= ifelse(iso_o=="AUS", example$Y_i[1], Y_i)) %>%
  mutate(Y_i= ifelse(iso_o=="AUT", example$Y_i[5], Y_i)) %>%
  mutate(Y_i= ifelse(iso_o=="Alabama", example$Y_i[9], Y_i)) %>%
  mutate(Y_i= ifelse(iso_o=="Alaska", example$Y_i[13], Y_i))
data_gravity_agriculture.base$Y_i <- as.numeric((data_gravity_agriculture.base$Y_i))
data_gravity_agriculture.base$X_j <- as.numeric(as.character(data_gravity_agriculture.base$X_j))
dist.matrix <- matrix(c(example$phi_ij[11], example$phi_ij[12], example$phi_ij[9], example$phi_ij[10], example$phi_ij[15], example$phi_ij[16], example$phi_ij[13], example$phi_ij[14], example$phi_ij[3], example$phi_ij[4], example$phi_ij[1], example$phi_ij[2], example$phi_ij[7], example$phi_ij[8], example$phi_ij[5], example$phi_ij[6]), nrow=4, ncol=4)
dist.matrix <- data.frame(dist.matrix)
colnames(dist.matrix) <- c("1", "2", "3", "4")
dist.matrix <- matrix(unlist(dist.matrix), ncol = 4, byrow = TRUE)
n.c <- 2;
n.s <- 2;
yr=2000
CENSUS.exp <- CENSUS.exp %>%
  filter(year==2000, (origin=="Alabama" | origin=="Alaska"), (importer=="AUS" | importer=="AUT")) %>%
  mutate(value= ifelse(origin=="Alabama" & importer=="AUS", example$`X_{ij}`[9], value)) %>%
  mutate(value= ifelse(origin=="Alabama" & importer=="AUT", example$`X_{ij}`[10], value)) %>%
  mutate(value= ifelse(origin=="Alaska" & importer=="AUS", example$`X_{ij}`[13], value)) %>%
  mutate(value= ifelse(origin=="Alaska" & importer=="AUT", example$`X_{ij}`[14], value))
CENSUS.exp$value <- as.numeric(CENSUS.exp$value)
CENSUS.imp <- CENSUS.imp %>%
  filter(year==2000, (origin=="AUS" | origin=="AUT"), (importer=="Alabama" | importer=="Alaska")) %>%
  mutate(value= ifelse(origin=="AUS" & importer=="Alabama", example$`X_{ij}`[3], value)) %>%
  mutate(value= ifelse(origin=="AUS" & importer=="Alaska", example$`X_{ij}`[4], value)) %>%
  mutate(value= ifelse(origin=="AUT" & importer=="Alabama", example$`X_{ij}`[7], value)) %>%
  mutate(value= ifelse(origin=="AUT" & importer=="Alaska", example$`X_{ij}`[8], value))
CENSUS.imp$value <- as.numeric(CENSUS.imp$value)
#############
  
# 1. LOAD DATA
# WIOD<-WIOD.base
# ## WIOD
# WIOD <- WIOD.base %>% 
#   filter( year==yr, sector==14 ) %>% 
#   filter( importer_country!='USA' ) %>% 
#   select( -year, -value_USA, -sector, -importer_country, -importer  ) ;
## Gravity data csv format with comma as the separator
data_gravity_agriculture <- data_gravity_agriculture.base %>% 
  filter( year==yr ) %>% 
  select( -year ) %>% 
  mutate( iso_o=as.character(iso_o), iso_d=as.character(iso_d) ) %>% 
  mutate( len_o=ifelse(nchar(iso_o)<4, 'COUNTRY', 'STATE'), 
          len_d=ifelse(nchar(iso_d)<4, 'COUNTRY', 'STATE') );

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 2. NUMBER STATES AND COUNTRIES
# States
id.states <- data_gravity_agriculture %>% 
  filter( len_o=='STATE' ) %>% 
  select( iso_o ) %>% 
  distinct( iso_o ) %>% 
  arrange( iso_o ) %>% 
  mutate( id=row_number() ) %>% 
  dplyr::rename( region=iso_o ) %>% 
  select( id, region );
# Countries
id.countries <- data_gravity_agriculture %>% 
  filter( len_o=='COUNTRY' ) %>% 
  select( iso_o ) %>% 
  distinct( iso_o ) %>% 
  arrange( iso_o ) %>% 
  mutate( id=n.s+row_number() ) %>% 
  dplyr::rename( region=iso_o ) %>% 
  select( id, region );
# Total
id.total <- rbind( id.states, id.countries );
#t(id.total)

# 3. ELEMENTARY MATRICES FOR KRONECKER PRODUCTS

# 3.1. DISTANCE MATRIX
dist.matrix <- data_gravity_agriculture %>% 
  select( iso_o, iso_d, dist ) %>% 
  left_join( y=id.total, by=c('iso_o'='region') ) %>% 
  dplyr::rename( id_o=id ) %>% 
  left_join( y=id.total, by=c('iso_d'='region') ) %>% 
  dplyr::rename( id_d=id ) %>% 
  select( id_o, id_d, dist ) %>% 
  arrange( id_o, id_d ) %>% 
  spread( key=id_d, value=dist );
dist.matrix <- as.matrix( dist.matrix[,2:(n.c+n.s+1)] );

#we use the coefficients from 4-4-Country_Gravity_WIOD.
#own dummy=4.1, Distance elasticity=-1.8
phi<-diag(x = 4.1, n.c+n.s, n.c+n.s);
phi<-exp(phi);
phi<-phi/dist.matrix^1.8; 
dist.matrix<-phi

# 3.2. GDP VECTOR 
gdp.vector <- data_gravity_agriculture %>% 
  select( iso_o, Y_i ) %>% 
  distinct( iso_o, .keep_all=TRUE ) %>% 
  left_join( y=id.total, by=c('iso_o'='region') ) %>% 
  select( id, Y_i ) %>% 
  arrange( id );
gdp.vector <- matrix( gdp.vector$Y_i );

#state import and export to countries 
state.exports.to.countries <- CENSUS.exp %>%
  filter(year==yr) %>%
  group_by(origin) %>%
  mutate(exp= sum(value)) %>%
  ungroup() %>%
  distinct(origin, .keep_all = TRUE) %>%
  arrange(origin)
state.exports.to.countries <- matrix(state.exports.to.countries$exp)
state.imports.from.countries <- CENSUS.imp %>%
  filter(year==yr) %>%
  group_by(importer) %>%
  mutate(imp= sum(value)) %>%
  ungroup() %>%
  distinct(importer, .keep_all = TRUE) %>%
  arrange(importer)
state.imports.from.countries <- matrix(state.imports.from.countries$imp)

## IMPORTANT ELEMENTS FOR LHS-RHS THAT DO NOT CHANGE BETWEEN ITERATIONS
Y_i <- as.matrix( gdp.vector[(1):(n.s)] );
ones.vec <- matrix( data=rep(1, n.s*3), nrow=n.s*3, ncol=1)
#For RHS
forall <- state.imports.from.countries
forall.tilde <- state.exports.to.countries
forall.tilde2 <- Y_i + forall - forall.tilde
big.forall <- rbind(forall, forall.tilde, forall.tilde2)
#For LHS
zeros.ns.ns <- matrix( data=rep(0, n.s), nrow=n.s, ncol=n.s);
tau.ns.ns <- dist.matrix[(1:n.s), (1:n.s)]
tau.ns.ns.diag <- tau.ns.ns
diag(tau.ns.ns.diag)<- 0
big.tau <- rbind( cbind(zeros.ns.ns, tau.ns.ns, zeros.ns.ns), cbind(zeros.ns.ns, zeros.ns.ns, tau.ns.ns))
ones <- matrix( data=rep(1, n.s), nrow=1, ncol=n.s)


#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 3. SOLVING THE SYSTEM
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
##### WE WANT TO MINIMIZE THE FUNCTION gravity.us
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
gravity.us <- function( x ) {  
  
#splitting the guess
P_j.0 <- matrix(x[(1):(n.s)]) 
Pi_i.0 <- matrix(x[(n.s+1):(n.s*2)]) 
X_j.0 <- matrix(x[( (n.s*2)+1 ):(n.s*3)])  
######
###### CONSTRUCTING RHS
######
X.inv.new <- rbind(X_j.0^(-1),Pi_i.0^(-1),P_j.0^(-1))
X.X <- rbind(X_j.0, Y_i, X_j.0)
X.X.inv <- X.X^(-1)
#Right hand side
RHS <- x*( ones.vec- (big.forall*X.X.inv)) 
######
###### CONSTRUCTING LHS
######
kron.1 <- kronecker((P_j.0^(-1))*X_j.0 , ones)*tau.ns.ns.diag
kron.2 <- kronecker(((Pi_i.0^(-1))*Y_i), ones)*((-1)*tau.ns.ns.diag)
Big.Matrix <- rbind(big.tau, cbind(zeros.ns.ns, kron.1, kron.2))
#left hand side
LHS <- Big.Matrix %*%(X.inv.new*X.X)
######
###### OBJECTIVE FUNCTION TO MINIMIZE
######
#NORMALIZING FIRST P TO 100 
constraint<-((x[1]/100)-1)*10000
objective<-rbind((LHS/RHS)-1,constraint)
#FINAL OBJECTIVE FUNCTION: SUM OF SQUARES OF THE DIFFERENCE
fx<- apply(objective^2, 2, sum)
#THE VALUE THE FUNCTION RETURNS: gravity.us(x)=fx
return(fx)
}
#SHOWING THAT IN THE EXAMPLE, THE REAL SOLUTION MAKES FUNCTION CLOSE TO ZERO
####
x=c(100.0000483, 105.8821817, 203.9996694, 221.0001074, 9621.345733, 12972.01184)
####
gravity.us(x) #seems to work!

####
#### SOLVING
####
#potential initial value: X_j=Y_j (no deficit)
init<-rep(100, 3*n.s);
init[((n.s*2)+1 ):(n.s*3)]<-Y_i;
###FIRST OPTIMIZATION ALGORITHM: LOWER AND UPPER BOUNDS
optimal.model <- optimx( par=init, fn=gravity.us,
                         lower=rep(0.0000000000001, 3*n.s), upper=rep(1000000000000, 3*n.s),
                         control=list(maxit=100000, eps=1.0E-20));
#VALUE THAT SHOWS OBJECTIVE FUNCTION EVALUATED AT THE SOLUTION
optimal.model$value #THIS SHOULD BE CLOSE TO ZERO!
#VECTOR OF SOLUTION
solu.1<-t(as.matrix(optimal.model[1:(3*n.s)]));  #not the same at the real solution!

###SECOND OPTIMIZATION ALGORITHM
optimal.model<-optim(par=init, fn=gravity.us, method = "Nelder-Mead", control = list(maxit = 20000,             abstol=1e-10, reltol=1e-10,ndeps=1e-8))
#VALUE THAT SHOWS OBJECTIVE FUNCTION EVALUATED AT THE SOLUTION
optimal.model$value #THIS SHOULD BE CLOSE TO ZERO!
#VECTOR OF SOLUTION
solu.2<-optimal.model$par

###THIRD. STARTING AT THE SOLUTION!
optimal.model<-optim(par=c(100.0000483, 105.8821817, 203.9996694, 221.0001074, 9621.345733, 12972.01184), fn=gravity.us, method = "Nelder-Mead", control = list(maxit = 20000,             abstol=1e-10, reltol=1e-10,ndeps=1e-8))
#VALUE THAT SHOWS OBJECTIVE FUNCTION EVALUATED AT THE SOLUTION
optimal.model$value #THIS SHOULD BE CLOSE TO ZERO!
#VECTOR OF SOLUTION
solu.3<-optimal.model$par
## comparing solutions
(solu.3/c(100.0000483, 105.8821817, 203.9996694, 221.0001074, 9621.345733, 12972.01184))-1

#checking
if(as.numeric( optimal.model$value )>epsilon) 
  stop(paste("Cannot find a solution for X_j states for year", yr))

solu<-t(as.matrix(optimal.model[1:150]));

}
```


#New system by calculating $X_j first$
```{r warning=FALSE}

for (yr in 2000:2007){

## Gravity data csv format with comma as the separator
data_gravity_agriculture <- data_gravity_agriculture.base %>% 
  filter( year==yr ) %>% 
  select( -year ) %>% 
  mutate( iso_o=as.character(iso_o), iso_d=as.character(iso_d) ) %>% 
  mutate( len_o=ifelse(nchar(iso_o)<4, 'COUNTRY', 'STATE'), 
          len_d=ifelse(nchar(iso_d)<4, 'COUNTRY', 'STATE') );
data_gravity_serv <- data_gravity_serv.base %>% 
  filter( year==yr ) %>% 
  select( -year )
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# NUMBER STATES AND COUNTRIES
# States
id.states <- data_gravity_agriculture %>% 
  filter( len_o=='STATE' ) %>% 
  select( iso_o ) %>% 
  distinct( iso_o ) %>% 
  arrange( iso_o ) %>% 
  mutate( id=row_number() ) %>% 
  dplyr::rename( region=iso_o ) %>% 
  select( id, region );
# Countries
id.countries <- data_gravity_agriculture %>% 
  filter( len_o=='COUNTRY' ) %>% 
  select( iso_o ) %>% 
  distinct( iso_o ) %>% 
  arrange( iso_o ) %>% 
  mutate( id=n.s+row_number() ) %>% 
  dplyr::rename( region=iso_o ) %>% 
  select( id, region );
# Total
id.total <- rbind( id.states, id.countries );
state.names <- id.total$region[1:n.s]
#t(id.total)

# GDP VECTOR: services and agriculture 
gdp.vector.serv <- data_gravity_serv %>% 
  select( iso_o, Y_i ) %>% 
  distinct( iso_o, .keep_all=TRUE ) %>% 
  left_join( y=id.total, by=c('iso_o'='region') ) %>% 
  select( id, Y_i ) %>% 
  arrange( id );
gdp.vector.serv <- matrix( gdp.vector.serv$Y_i );
gdp.vector.serv.s <- data.frame(gdp.vector.serv[1:n.s])
gdp.vector.serv.s$sector <- 13
gdp.vector.serv.s$exporter <- state.names
colnames(gdp.vector.serv.s) <- c("export", "sector", "exporter")
gdp.vector.agri <- data_gravity_agriculture %>% 
  select( iso_o, Y_i ) %>% 
  distinct( iso_o, .keep_all=TRUE ) %>% 
  left_join( y=id.total, by=c('iso_o'='region') ) %>% 
  select( id, Y_i ) %>% 
  arrange( id );
gdp.vector.agri <- matrix( gdp.vector.agri$Y_i );
gdp.vector.agri.s <- data.frame(gdp.vector.agri[1:n.s])
gdp.vector.agri.s$sector <- 14
gdp.vector.agri.s$exporter <- state.names
colnames(gdp.vector.agri.s) <- c("export", "sector", "exporter")

#Expenditure vector: services
expenditure.vector.serv <- data_gravity_serv %>% 
  select( iso_d, X_j ) %>% 
  distinct( iso_d, .keep_all=TRUE ) %>% 
  left_join( y=id.total, by=c('iso_d'='region') ) %>% 
  select( id, X_j ) %>% 
  arrange( id );
expenditure.vector.serv <- matrix( expenditure.vector.serv$X_j );
expenditure.vector.serv.s <- data.frame(expenditure.vector.serv[1:n.s])
expenditure.vector.serv.s$sector <- 13
expenditure.vector.serv.s$importer <- state.names
colnames(expenditure.vector.serv.s) <- c("import", "sector", "importer")
expenditure.vector.serv.s <- expenditure.vector.serv.s %>% select(importer, sector, import)

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

#sum.14: first component in X_j
io.shares <- read.csv( file= paste("1-Intermediate_Processed_Data//io_shares", yr, ".csv", sep=""))
io.0 <- io.shares %>%
  filter(country=="USA", sector==14) %>%
  select(-year, -country, -sector)
io.0 <- t(io.0)
state.state <- read.csv(paste('1-Intermediate_Processed_Data//state_cfs_step_', yr, '.txt', sep= ""), header = TRUE, sep = ",", dec = ".")
state.country.y <- read.csv(paste('1-Intermediate_Processed_Data//state_country_step_y_', yr, '.txt', sep= ""), header = TRUE, sep = ",", dec = ".")
state.country.e <- read.csv(paste('1-Intermediate_Processed_Data//state_country_step_e_', yr, '.txt', sep= ""), header = TRUE, sep = ",", dec = ".")
state.exports <- rbind(state.state, state.country.y)
exp.v <- c()
for (sec in 1:12) {
  state.exports.1 <- state.exports %>%
    filter(sector==sec) %>%
    select(-year, -importer, -sector)
  export <- matrix(colSums(state.exports.1))
  export <- data.frame(export)
  export$sector <- sec
  export$exporter <- state.names
  exp.v <- rbind(exp.v, export)
}
gdp.tot.v <- rbind(exp.v, gdp.vector.serv.s, gdp.vector.agri.s)
gdp.tot.v$phi <-NA
for (sec in 1:14) {
  gdp.tot.v <- gdp.tot.v %>%
    mutate(phi= ifelse(sector==sec, io.0[sec], phi))
}
gdp.tot.v <- gdp.tot.v %>%
  mutate(val= phi*export)
sum.14 <- gdp.tot.v %>%
  group_by(exporter) %>%
  mutate(value= sum(val)) %>%
  ungroup() %>%
  distinct(exporter, .keep_all = TRUE)
sum.14 <- sum.14$value  
  
#sum.not.14: second component in X_j
state.imports <- cbind(state.state[4:dim(state.country.e)[2]], state.country.e[4:dim(state.country.e)[2]])
expenditure.state <- rowSums(state.imports)
expenditure.state <- cbind( state.state[2:3], expenditure.state)
colnames(expenditure.state) <- c("importer", "sector", "import")
expenditure.vector.serv.s <- rbind(expenditure.state, expenditure.vector.serv.s)
colnames(expenditure.vector.serv.s) <- c("importer", "r", "import")

sum.not.14 <- c()
for (r in 1:13) {
io.shares <- read.csv( file= paste("1-Intermediate_Processed_Data//io_shares", yr, ".csv", sep=""))
io.0 <- io.shares %>%
  filter(country=="USA", sector==r) %>%
  select(-year, -country, -sector)
io.0 <- t(io.0)
state.exports <- rbind(state.state, state.country.y)
exp.v <- c()
for (sec in 1:12) {
  state.exports.1 <- state.exports %>%
    filter(sector==sec) %>%
    select(-year, -importer, -sector)
  exp <- matrix(colSums(state.exports.1))
  exp <- data.frame(exp)
  exp$sector <- sec
  exp$exporter <- state.names
  exp.v <- rbind(exp.v, exp)
}
gdp.tot.v <- rbind(exp.v, gdp.vector.serv.s, gdp.vector.agri.s)
gdp.tot.v$phi <-NA
for (sec in 1:14) {
  gdp.tot.v <- gdp.tot.v %>%
    mutate(phi= ifelse(sector==sec, io.0[sec], phi))
}
gdp.tot.v <- gdp.tot.v %>%
    mutate(val= phi*exp)
sum.not.14.0 <- gdp.tot.v %>%
  group_by(exporter) %>%
  mutate(value= sum(val)) %>%
  ungroup() %>%
  distinct(exporter, .keep_all = TRUE) %>%
  select(-phi, -val, -exp) %>%
  select(exporter, sector, value)
sum.not.14 <- rbind(sum.not.14, sum.not.14.0)
}
sum.not.14 <- cbind(sum.not.14, expenditure.vector.serv.s)
sum.not.14 <- sum.not.14 %>%
  mutate(diff= import - value) %>%
  group_by(importer) %>%
  mutate(sum.not.14= sum(diff)) %>%
  ungroup() %>%
  distinct(importer, .keep_all = TRUE) %>%
  select(importer, sum.not.14)

#share of US agriculture consumption to total US consumption 
wiot.full.0 <- wiot.full %>%
  filter(year==yr & row_item!=17 & row_item!=31 & row_item<=34) %>%
  filter(col_item>=37 & col_item<=42 & col_country=="USA")
wiot.full.1 <- wiot.full.0 %>%
  group_by(year, col_country) %>%
  mutate(C.us= sum(value)) %>%
  ungroup() %>%
  distinct(year, col_country, .keep_all = TRUE)
wiot.full.2 <- wiot.full.0 %>%
  filter(row_item==1) %>%
  group_by(year, col_country) %>%
  mutate(C.us.agri= sum(value)) %>%
  ungroup() %>%
  distinct(year, col_country, .keep_all = TRUE)
C.us <- wiot.full.1$C.us
C.us.agri <- wiot.full.2$C.us.agri
gamma <- C.us.agri/C.us
#gamma
frac.gamma <- gamma/(1-gamma)


#final computation for X_j
X_j <- sum.14 + (frac.gamma*sum.not.14$sum.not.14)


#check
HOLA <- WIOD.base %>%
  filter(year==2000, importer_country=="USA", sector==14)
H=HOLA[5:dim(HOLA)[2]]
sum(H)
sum(X_j)

}



```




