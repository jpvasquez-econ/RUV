---
title: "Putting all together"
output:
  html_document:
    df_print: paged
  pdf_document:
    number_sections: yes
header-includes:
- \usepackage{amsmath}
- \usepackage{amssymb}
- \usepackage{pifont}
- \usepackage{mathpazo}
- \newcommand{\xmark}{\ding{55}}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
remove(list = ls())
```

```{r warning=FALSE, include=FALSE, message=FALSE, results='hide', cache=FALSE}
# libraries
options( scipen=100, stringsAsFactors=FALSE );
# vector of libraries to be used
libs <- c( 'dplyr', 'tidyr', 'readstata13', 'haven', 'stringr', 'nleqslv', 'gdata', 'Statamarkdown', 'reshape2');
# Install libraries in case they are not installed
for( i in length(libs)){ 
  if( !(libs[i] %in% installed.packages()) ) install.packages( libs ) 
};
# Carga de bibliotecas
lapply( libs, require, character.only=TRUE );
```

# General Instructions

The final goal is to combine the previous steps in order to obtain a new Final Matrix for 2000 through 2007: $X_{ij,k}^{year}$.

## Importing datasets to R
```{r}
regions <- read_excel("0-Raw_Data/regions.xlsx")
c.names <- regions %>% filter(status=="country", region!="USA")
c.names <- data.frame(c.names$region)
colnames(c.names) <- c("region")

s.names <- regions %>% filter(status=="state") 
s.names <- data.frame(s.names$region)
colnames(s.names) <- c("region")

regions<- data.frame(rbind(s.names, c.names))

s.names <- as.matrix(s.names)
c.names <- as.matrix(c.names)

n.s <- length(s.names)
n.c <- length(c.names)

sector.file <- read_excel("0-Raw_Data/sectors.xlsx")
n.sec <- length(unique(sector.file$final_sector)) -3

services.all=c()
agriculture.all=c()
state.state.all=c()
country.country.all=c()
state.country.e.all=c()
state.country.y.all=c()

for (yr in 2000:2007) {
##Gravity step: services  
services <- read.csv(paste('1-Intermediate_Processed_Data//Xij_matrix_services_', yr, '.csv', sep= ""), header = TRUE, sep = ",", dec = ".")
services <- data.frame(services)
colnames(services)= regions$region
services <- services %>%
  mutate(year=yr, sector=(n.sec+1), importer=regions$region) %>%
  select(year, importer, sector, everything())
##Gravity step: agriculture  
agriculture <- read.csv(paste('1-Intermediate_Processed_Data//Xij_matrix_agric_', yr, '.csv', sep= ""), header = TRUE, sep = ",", dec = ".")
agriculture <- data.frame(agriculture)
colnames(agriculture)= regions$region[1:n.s]
agriculture <- agriculture %>%
  mutate(year=yr, sector=(n.sec+2), importer=regions$region[1:n.s]) %>%
  select(year, importer, sector, everything())
#country-country
country.country <- read.csv(paste('1-Intermediate_Processed_Data//country_country_step_', yr, '.txt', sep= ""), header = TRUE, sep = ",", dec = ".")
country.country <- country.country %>%
  filter(importer!="USA") %>%
  select(-USA)
#state-state
state.state <- read.csv(paste('1-Intermediate_Processed_Data//state_cfs_step_', yr, '.txt', sep= ""), header = TRUE, sep = ",", dec = ".")
#state-country-state
state.country.e <- read.csv(paste('1-Intermediate_Processed_Data//state_country_step_e_', yr, '.txt', sep= ""), header = TRUE, sep = ",", dec = ".")
state.country.y <- read.csv(paste('1-Intermediate_Processed_Data//state_country_step_y_', yr, '.txt', sep= ""), header = TRUE, sep = ",", dec = ".")
#appending
state.state.all <- rbind(state.state.all, state.state)
country.country.all <- rbind(country.country.all, country.country)
state.country.e.all <- rbind(state.country.e.all, state.country.e)
state.country.y.all <- rbind(state.country.y.all, state.country.y)
services.all <- rbind(services.all, services)
agriculture.all <- rbind(agriculture.all, agriculture)
}
```

##Incorporating services (sector 13) and agriculture (sector 14)
```{r}
#services state-state
serv_state <- services.all%>%
  filter(importer %in% s.names)
serv_state <- serv_state[ ,1:(n.s+3)]
state.state.all <- rbind(state.state.all, serv_state)
state.state.all <- state.state.all %>%
  arrange(year, sector)
#agricultre state-state
agri_state <- agriculture.all%>%
  filter(importer %in% s.names)
agri_state <- agri_state[ ,1:(n.s+3)]
state.state.all <- rbind(state.state.all, agri_state)
state.state.all <- state.state.all %>%
  arrange(year, sector)

#imports of states from countries: services
serv_state_country_e <- services.all%>%
  filter(importer %in% s.names)
temp <- serv_state_country_e[ ,1:3]
serv_state_country_e <- serv_state_country_e[ ,(n.s+3+1):dim(serv_state_country_e)[2]]
serv_state_country_e <- cbind(temp, serv_state_country_e)
state.country.e.all <- rbind(state.country.e.all, serv_state_country_e)
state.country.e.all <- state.country.e.all %>%
  arrange(year, sector)
# #imports of states from countries: agriculture
# agri_state_country_e <- agriculture.all%>%
#   filter(importer %in% s.names)
# temp <- agri_state_country_e[ ,1:3]
# agri_state_country_e <- agri_state_country_e[ ,(n.s+3+1):dim(agri_state_country_e)[2]]
# agri_state_country_e <- cbind(temp, agri_state_country_e)
# state.country.e.all <- rbind(state.country.e.all, agri_state_country_e)
# state.country.e.all <- state.country.e.all %>%
#   arrange(year, sector)

#exports of states to countries: services
serv_state_country_y <- services.all%>%
  filter(importer %in% c.names)
serv_state_country_y <- serv_state_country_y[ ,1:(n.s+3)]
state.country.y.all <- rbind(state.country.y.all, serv_state_country_y)
state.country.y.all <- state.country.y.all %>%
  arrange(year, sector)
# #exports of states to countries: agriculture
# agri_state_country_y <- agriculture.all%>%
#   filter(importer %in% c.names)
# agri_state_country_y <- agri_state_country_y[ ,1:(n.s+3)]
# state.country.y.all <- rbind(state.country.y.all, agri_state_country_y)
# state.country.y.all <- state.country.y.all %>%
#   arrange(year, sector)
```

# Putting all together

Constructing the full matrix $X_{ij,k}^{year}$ by putting together all elements using the steps described in the previous codes. 
```{r}

for (yr in 2000:2007) {

country.country <- subset(country.country.all, year==yr)
country.country <- subset(country.country, select= -year)  
  
state.state <- subset(state.state.all, year==yr)
state.state <- subset(state.state, select= -year)   
  
state.country.y <- subset(state.country.y.all, year==yr)
state.country.y <- subset(state.country.y, select= -year)   
  
state.country.e <- subset(state.country.e.all, year==yr)
state.country.e <- subset(state.country.e, select= -year) 


final_matrix=c()
#loop across sectors
for (k in 1:(n.sec+2)) {
  state.country.e.0 <- state.country.e %>%
    filter(sector==k) %>%
    select(-importer, -sector)
  state.state.0 <- state.state %>%
    filter(sector==k)
  matrix_top=cbind(state.state.0, state.country.e.0)
   
  country.country.0 <- country.country %>%
    filter(sector==k) %>%
    select(-importer, -sector)
  state.country.y.0 <- state.country.y %>%
    filter(sector==k)
  matrix_sub=cbind(state.country.y.0, country.country.0)
  
  colnames(matrix_top) = colnames(matrix_sub) #matching names

  ma02=rbind(matrix_top, matrix_sub)
  
  final_matrix=rbind(final_matrix, ma02 ) #Final 
  
}
final_matrix$sector=100+final_matrix$sector;

write.table(final_matrix, file = paste("1-Intermediate_Processed_Data//final_matrix_", yr, ".csv", sep=""), sep = ",", row.names = FALSE)
}

```


# General Instructions

The final goal is to check that the final trade matrices are consistent with WIOD database.

## Importing datasets to R
```{r}

#Final WIOD
#WIOD
WIOD.base <- c()
for (yr in 2000:2007) {
  wiot <- country.country <- read.csv(paste('1-Intermediate_Processed_Data//country_country_step_', yr, '.txt', sep= ""), header = TRUE, sep = ",", dec = ".")
  WIOD.base <- rbind(WIOD.base, wiot)
}

CDP.base <- c()
#Final matrices 
for (yr in 2000:2007) {
##Gravity step: services  
matrix <- read.csv(paste("1-Intermediate_Processed_Data//final_matrix_", yr, ".csv", sep=""), header = TRUE, sep = ",", dec = ".")
matrix$year <- yr
matrix <- matrix %>% select(year, everything())

CDP.base <- rbind(CDP.base, matrix)
}

#
epsilon <- 0.0001
```

#Checks
```{r}
for (yr in 2000:2007) {

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#country-country  
wiot <- melt(WIOD.base, id.vars=c("year", "importer", "sector"), variable.name="exporter", value.name = "value")
wiot.cc <- wiot %>%
  filter(year==yr, importer %in% c.names, exporter %in% c.names) %>%
  arrange(sector, exporter, importer)

CDP <- melt(CDP.base, id.vars=c("year", "importer", "sector"), variable.name="exporter", value.name = "value")
CDP.cc <- CDP %>%
  filter(year==yr, importer %in% c.names, exporter %in% c.names) %>%
  arrange(sector, exporter, importer)

if(abs(sum(CDP.cc$val)/sum(wiot.cc$value) -1)>epsilon) 
  stop(paste("countries' exports to countries != countries' WIOD exports for year", yr))
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#state-to-country

wiot.cs <- wiot %>%
  filter(year==yr, importer %in% c.names, exporter %in% c("USA")) %>%
  arrange(sector, exporter, importer)


CDP.cs <- CDP %>%
  filter(year==yr, importer %in% c.names, exporter %in% s.names) %>%
  group_by(sector, importer) %>%
  mutate(val=sum(value)) %>%
  ungroup() %>%
  distinct(year, sector, importer, .keep_all = TRUE) %>%
  arrange(sector, exporter, importer)

if(abs(sum(CDP.cs$val)/sum(wiot.cs$value) -1)>epsilon) 
  stop(paste("states' exports to countries != US WIOD exports to countries for year", yr))
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# country-to-state

wiot.sc <- wiot %>%
  filter(year==yr, importer %in% c("USA"), exporter %in% c.names) %>%
  arrange(sector, exporter, importer)


CDP.sc <- CDP %>%
  filter(year==yr, importer %in% s.names, exporter %in% c.names) %>%
  group_by(sector, exporter) %>%
  mutate(val=sum(value)) %>%
  ungroup() %>%
  distinct(year, sector, exporter, .keep_all = TRUE) %>%
  arrange(sector, exporter, importer)

if(abs(sum(CDP.sc$val)/sum(wiot.sc$value) -1)>epsilon) 
  stop(paste("countries' exports to states != countries' WIOD exports to US for year", yr))
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#state-state

wiot.ss <- wiot %>%
  filter(year==yr, importer %in% c("USA"), exporter %in% c("USA")) %>%
  arrange(sector, exporter, importer)


CDP.ss <- CDP %>%
  filter(year==yr, importer %in% s.names, exporter %in% s.names) %>%
  group_by(sector) %>%
  mutate(val=sum(value)) %>%
  ungroup() %>%
  distinct(year, sector, .keep_all = TRUE) %>%
  arrange(sector, exporter, importer)

if(abs(sum(CDP.ss$val)/sum(wiot.ss$value) -1)>epsilon) 
  stop(paste("states' exports to states != US WIOD exports to US for year", yr))

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


}
```

