---
title: "Input-Output tables"
output:
  html_notebook:
    toc: yes
    df_print: paged
    number_sections: yes    
  pdf_document:
    number_sections: yes
  word_document: default
header-includes:
- \usepackage{amsmath}
- \usepackage{amssymb}
- \usepackage{pifont}
- \usepackage{mathpazo}
---

# General information

This code calculates the input output matrix shares for each sector, country and year using data from WIOD. Each entry is the share of expenditure of each buying sector. For each country-year, the sum across rows of each column sums up to one. 

## Input files

1. `0-Raw_Data/regions.csv`
2. `0-Raw_Data/sectors.csv`
3. `1-Intermediate_Processed_Data//wiot_full.csv`

## Output files

One CSV file per year with root: `1-Intermediate_Processed_Data/io_shares.csv`. The final output of this code is a (sectors*countries)$\times$(2+sectors) matrix, where the first two columns indicate the year and country, and the rest the sectors associated with the input-output shares of the country.  


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
remove(list = ls())
```

```{r packages, warning=FALSE, include=FALSE, message=FALSE, results='hide', cache=FALSE}
# libraries
options( scipen=100, stringsAsFactors=FALSE );
# vector of libraries to be used
libs <- c( 'dplyr', 'tidyr', 'readstata13', 'haven', 'stringr', 'nleqslv', 'gdata', 'Statamarkdown', 'readxl', 'foreign', 'reshape2');
# Install libraries in case they are not installed
for( i in length(libs)){ 
  if( !(libs[i] %in% installed.packages()) ) install.packages( libs ) 
};
# Carga de bibliotecas
lapply( libs, require, character.only=TRUE );
```

# Constructing Input-Output matrices for countries

Define $\alpha_{j,ks}$ for region $j$ as the share of purchases of sector $s$ that come from sector $k$ in the total purchases of sector $s$ (this is the input output coefficient). We have that:

$$\alpha_{j,ks}=\dfrac{\sum_{i}X_{ij,ks}}{\sum_{r}\sum_{i}X_{ij,rs}}=\dfrac{X_{j,ks}}{\sum_{r}X_{j,rs}}$$

Note that $\sum_{k}\alpha_{j,ks}=1\quad\forall j$. 

## Importing datasets to R

```{r data}

regions <- read.csv("0-Raw_Data/regions.csv")
c.names <- regions %>% filter(status == "country")
c.names <- c.names$region

s.names <- regions %>% filter(status == "state") 
s.names <- s.names$region

n.s <- length(s.names)
n.c <- length(c.names) - 1

reclass_sectors <- read.csv("0-Raw_Data/sectors.csv")
reclass_sectors <- reclass_sectors %>% 
  select(final_sector, wiod_sector) %>%
  distinct(wiod_sector, .keep_all = TRUE)

# WIOD Full
wiot <- read.csv("1-Intermediate_Processed_Data//wiot_full.csv")
wiot <- wiot %>%
  filter(row_item != 0, col_item != 0) #NOT CONSUMPTION
```

## Calculating shares

```{r}
num <- wiot %>%
  group_by(year, col_country, col_item, row_item) %>%
  mutate(val = sum(value)) %>%
  ungroup() %>%
  distinct(year, col_country, col_item, row_item, .keep_all = TRUE) %>%
  select(-row_country, -value) %>%
  dplyr::rename(region = col_country, sector_o = row_item, sector_d = col_item)

num <- spread(num, sector_o, val, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)

io.shares <- num[, 4:dim(num)[2]] / rowSums(num[, 4:dim(num)[2]])
io.shares <- cbind(num[, 1:3], io.shares)

io <- melt(io.shares, id.vars=c("year", "region", "sector_d"), variable.name="sector_o", value.name = "share")
id.tot <- data.frame(c.names)
id.tot$id <- c(1:(n.c+1))
colnames(id.tot) <- c("regions", "id")

io <- io %>%
  left_join(id.tot, by=c('region'='regions')) %>%
  mutate(region = id) %>%
  select(-id) %>%
  arrange(year, region, sector_d)

io <-spread(io, sector_d, share, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)
io <- io %>% 
  dplyr::rename(sector = sector_o) %>%
  left_join(id.tot, by=c('region'='id')) %>%
  mutate(region = regions) %>%
  select(-regions)

# #check: 8x38=304
# colSums(io[, 4:dim(io)[2]])

for (yr in 2000:2007) {
  final <- io %>%
    filter(year == yr)
  write.table(final, file = paste("1-Intermediate_Processed_Data//io_shares", yr, ".csv", sep=""), sep = ",", row.names = FALSE)
}


```

