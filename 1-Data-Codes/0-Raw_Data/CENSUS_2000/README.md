# Computation of Employment Allocations and the Matrices of Migration Flows

This file explains how to calculate labor allocation by state an sector for the years 1999-2007 and how to compute the labor movements across these states and sectors for all those years.

## Task 1:

This code computes the employment level for each state and sector in the year 2000.

Steps:

1) Download the employment and unemployment levels for each state in the year 2000 that the Census Bureau published based on the 2000 Decennial Census. The file is title Table 1. Employment Status of the Population 16 Years Old and Over in Households for the United States, States, Counties, and for Puerto Rico: 2000; download the revised Excel xls file. The file can be accessed [here](https://www.census.gov/data/tables/2000/dec/phc-t-28.html). Change the name of the downloaded excel file to "employment_2000.xls".

2) The previous file is missing the distribution of workers by sectors. To gather such disaggregation we will use the 5 % sample PUMS files of the 2000 Census. These files are available [here](https://www.census.gov/data/datasets/2000/dec/microdata.html); specifically, open the folder "All additional files for the PUMS 5-Percent Dataset" and download the file "PUMS5__.txt" within each state folder. There is no need to change the name of the downloaded text files.  Also, note that the variable dictionary for the census data is located in the same link and is titled "5%_PUMS_record_layout.xls".  Note that each observation is compressed in a single line of numbers to save space; therefore, variables of interest have to be created using start and stop character positions as the code does.  For more information regarding the NAICS industry codes used in the census sample files, see p. 547 in [here](https://www.census.gov/prod/cen2000/doc/pums.pdf); the most updated version of the previous NAICS table can be found in [here](https://www2.census.gov/programs-surveys/cps/methodology/Industry Codes.pdf). Whenever available we will use NAICS codes instead of Census Industry codes, and then recode them to final sectors, as we did in this step. 

3) In the census 2000 sample we only keep observations type "P" (persons) with age in between 25 and 65, and that are either employed or unemployed. Unemployment will be considered an extra sector: sector 0. NAICS sectors are recoded into final sectors of interest. Their industry sector and state are used to compute the labor distribution by those aspects and then proportionality is applied with respect to the population employment and unemployment levels by state to obtain the desired labor distribution matrix by state and sector for 2000, $L_{2000}$. 


## Task 2:

This code computes the mobility matrices, $\mu_{yr}$, for each state and sector for the years 1999-2006. The American Community Survey (ACS) Public Use Microdata Sample (PUMS) files provide details of workers' current employment status, sector, and state, and the state in which they lived a year ago; however, this survey does not provide information regarding people's employment status and sector in the previous year. Therefore, this is only one of two data sources used. The second one is the Current Population Survey (CPS), which provides details of people's employment status, industry sector and state for each month from 1999 to 2007. However, it only does so for households and people within each state, therefore, it does not provide information regarding movements across states. The previous explanations clarify why both surveys have to be used to compute the labor transitions across states and sectors between every two years in 1999-2007.

Steps:

1)  The ACS PUMS csv files can be downloaded from the FTP server in [here](https://www.census.gov/programs-surveys/acs/microdata/access.html). Within the FTP server open the folders for the years 2000-2007 and download the files titled "csv_p{state}.zip". The survey's variable dictionary can be accessed through this [link](https://www2.census.gov/programs-surveys/acs/tech_docs/pums/data_dict/PUMSDataDict06.pdf) and the questionnaire through this [link](https://www2.census.gov/programs-surveys/acs/methodology/questionnaires/2020/quest20.pdf). There is no need to change the name of the downloaded csv files after decompressing the zip files.

2) We only keep observations with age in between 25 and 65, and that are either employed or unemployed. Unemployment will be considered an extra sector: sector 0. NAICS sectors are recoded into final sectors of interest. Their industry sector, current state and previous year state are used to compute partial transition matrices with state of origin and destination and destination sector. We refer to the values in these matrices as "y" values; these values are in levels and sum up to the sample, not yet the population. 

3) The CPS PUMS files can be downloaded [here](https://www.census.gov/data/datasets/time-series/demo/cps/cps-basic.2000.html); specifically, access each year (1999-2007) tab and download the DOS/Windows files for each month. Once decompressed, .dat or .cps files will be generated. Save each of these files with the same name (add a "_" at the end) as .txt. The survey's variable dictionary can be found in the same link for each year; in this case, the dictionary is important since it changed some times and affected some of the variables of interest. Note that each observation is compressed in a single line of numbers to save space; therefore, variables of interest have to be created using start and stop character positions as the code does.

4) The CPS surveys households in a 4-8-4 format; that is, interviews the household for 4 consecutive months, gives them an 8 month break and interviews them again for 4 consecutive months. Also, a new household can start the 4-8-4 sequence any month of the year. Since the CPS data comes in a monthly frequency and we are interested in workers' movements across time we have to match households and individuals across time. Each household ID is a concatenation of 4 variables (see code). However, this ID suffers a simplification in May-2004, difficulting automatic matches around that period. The necessary adjustment is detailed in the new dictionary and implemented in the code; basically, the new household ID is the previous one with some specific digits taken out. Persons within a household do not have a unique ID, therefore, one is created for them using the household ID and the person's age and gender.

5) We only keep observations with age in between 25 and 65, and that are either employed or unemployed. Unemployment will be considered an extra sector: sector 0. CPS uses Census industry codes instead of NAICS, so, a different recoding is applied to convert them to the final sectors of interest. Also, the Census industry codes were updated in 2003 and changed positions in the variable dictionary. For more information regarding the Census industry codes changes see [link](https://www.bls.gov/cps/cpsoccind.htm); the old and new codes can be accessed  [here](https://www.nlsinfo.org/sites/nlsinfo.org/files/attachments/12124/NLSY97 1990 Census I and O codes.pdf) and in [here](https://www2.census.gov/programs-surveys/cps/methodology/Industry Codes.pdf).

6) CPS observations (individuals) are matched in time using the interview number; each of the first 4 monthly interviews are 12 months apart from the final 4 interviews. That is why worker movements' information is gathered using the following interview matching system: (1,5), (2,6), (3,7) and (4,8); the latter is equivalent to match each month in one year to the respective one in the following year. These matchings between years, and each person's information about past and current state and sector make it possible to see the labor redistribution in time; these values are referred to as "x" (see Table IV in CDP, 2019). Recall that the survey does not account for movements across states and that is why we still need the ACS's "y" values. We follow CDP's  assumption that interstates movements (i to j) across sectors follow the same pattern that intrastate movements (j) across sectors. Given that an assumption is used for interstates movements in the "x" values,  proportionality is applied to "x" values to sum up to "y" values, which do not incur in assumptions and are available for interstate movements; the columns of "x" values that suffered proportionality are substituted with the respective national values as if the state factor did not exist only if the "x" column consists of zeros. Similarly, if that substitution renders the same column of zeros a 1 is introduced in the origin=destination state-sector space to avoid losing information in the "y" value. This process results in "x adjusted" values and these cover the four aspects of the mobility matrices: origin and destination state and origin and destination sector. These values are levels and are not yet population statistics; nevertheless, dividing them by the rowsum of the matrix (flows go from rows to columns) gives the mobility matrices as shares of each initial state-sector; if all shares in a single row are zeros, then a value of 1 is introduced in the origin=destination state-sector position.

7) This process is used to compute mobility matrices for the years 1999-2006, where the year represents the start year. Any zero value in a mobility matrix diagonal is changed into the minimum non-zero diagonal value and then the mobility matrix is re-normalized so that shares in the same row sum to 1. 

## Task 3:

This code computes the employment distribution, L, for 1999, 2001-2007 and the mobility matrix 1999, $\mu_{1999}$.

Steps:

1) Using the labor distribution for 2000, $L_{2000}$, and the mobility matrix, $\mu_{2000}$, for 2000-2001 it is possible to compute the labor of the following year using: $L_{2001} = t(\mu_{2000})*L_{2000}$. All subsequent labors distributions are computed in the same way. 

2) $L_{1999}$ can be computed similarly, using $ (t(\mu_{2000}))^{-1}*L_{2000} =L_{1999}$, but negative values arise in the result. Therefore, the 1999 labor distribution is computed using $L_{2000}$, and the 1999 mobility matrix in levels form (and adjusted with proportionality so that it is consistent and sums to labor distribution in 2000).  After computing $L_{1999}$, the 1999 level mobility matrix adjusted by $L_{2000}$ is used to calculate the 1999 mobility matrix, $\mu_{1999}$, as shares of each initial state-sector labor, in the same way the others ($\mu_{yr}$) were computed in Task 2. 

