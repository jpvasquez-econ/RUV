---
title: "Agriculture data"
output:
  html_notebook:
    toc: yes
    df_print: paged
    number_sections: yes    
  pdf_document:
    number_sections: yes
header-includes:
- \usepackage{amsmath}
- \usepackage{amssymb}
- \usepackage{pifont}
- \usepackage{mathpazo}
---

# General information

This code creates a file that contains information about distances between regions, agricultural production for all regions and agricultural consumption for countries. In doing so, the code also applies the usual proportionality rule so that aggregate expenditure and production matches WIOD. 

## Input files

1. `0-Raw_Data/regions.xlsx`
2. `0-Raw_Data/sectors.xlsx`
3. `1-Intermediate_Processed_Data/state_imports_exports.dta`
4. `1-Intermediate_Processed_Data/country_country_step_`
5. `0-Raw_Data//Agriculture_Census/data_agriculture.csv`
6. `1-Intermediate_Processed_Data/data_services.csv`

## Output files

1. `1-Intermediate_Processed_Data/census.exp.agri.proportionality.csv`
2. `1-Intermediate_Processed_Data/census.imp.agri.proportionality.csv`
3. `1-Intermediate_Processed_Data/data_agriculture.csv`


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, warning=FALSE, include=FALSE, message=FALSE, results='hide', cache=FALSE}
# libraries
remove(list = ls())
# vector of libraries to be used
libs <- c( 'dplyr', 'tidyr', 'readstata13', 'haven', 'stringr', 'nleqslv', 'gdata', 'Statamarkdown', 'formattable', 'reshape', 'ggplot2', 'viridis', 'RColorBrewer', 'reshape2', 'foreign', 'readxl');
#Installing libraries in case they are not installed
for( i in length(libs)){ 
  if( !(libs[i] %in% installed.packages()) ) install.packages( libs ) 
};
#Loading libraries
lapply( libs, require, character.only=TRUE );
```

## Importing data to R

```{r data-importing}
#General parameters
regions <- read_excel("0-Raw_Data/regions.xlsx")
c.names <- regions %>% filter(status=="country", region!="USA")
c.names <- c.names$region

s.names <- regions %>% filter(status=="state") 
s.names <- s.names$region

n.s <- length(s.names)
n.c <- length(c.names)

sector.file <- read_excel("0-Raw_Data/sectors.xlsx")
id.sectors <- sector.file %>% 
  select(final_sector, WIOD_sector) %>%
  distinct(WIOD_sector, .keep_all = TRUE)

#WIOD
WIOD.base <- c()
for (yr in 2000:2007) {
  wiot <- country.country <- read.csv(paste('1-Intermediate_Processed_Data//country_country_step_', yr, '.txt', sep= ""), header = TRUE, sep = ",", dec = ".")
  WIOD.base <- rbind(WIOD.base, wiot)
}
WIOD.full <- read.dta13("1-Intermediate_Processed_Data//wiot_full.dta")
WIOD.full <- WIOD.full %>% 
  left_join(id.sectors, by=c('row_item'='WIOD_sector')) %>%
  mutate(row_item = final_sector) %>%
  select(-final_sector) %>%
  left_join(id.sectors, by=c('col_item'='WIOD_sector')) %>%
  mutate(col_item = final_sector) %>%
  select(-final_sector) %>%
  arrange(year, row_country, col_country, row_item, col_item) %>%
  group_by(year, row_country, col_country, row_item, col_item) %>% #aggregating repeated r-c sequence
  mutate(value1= sum(value)) %>%
  ungroup() %>%
  distinct(year, row_country, col_country, row_item, col_item, .keep_all = TRUE) %>%
  select(-value) %>%
  dplyr::rename(value=value1)

#CENSUS
CENSUS <- read.dta13("1-Intermediate_Processed_Data//state_imports_exports.dta")
state_imp_exp.0 <- CENSUS %>%
  filter(origin!="AllStates", destination!="AllStates")
  
#Agriculture production states
data_agri <- read.csv("0-Raw_Data//Agriculture_Census//data_agriculture.csv")

#Fish production states
data_fish <- read.csv("0-Raw_Data//Agriculture_Census//data_fish.csv")

#Trade distances
#temporarily using data_services to get the structure of the output and the distances
data_agriculture <- read.csv("1-Intermediate_Processed_Data//data_services.csv")
data_agriculture <- data_agriculture %>%
                    select(-Y_i, -X_j) 
#names as characters
data_agriculture$iso_o<-as.character(data_agriculture$iso_o)
data_agri$iso_o <- lapply(data_agri$iso_o, as.character)
#epsilon for checks
epsilon <- 0.0001

sector.file <- read_excel("0-Raw_Data/sectors.xlsx")
#non-gravity sectors
n.sec <- length(unique(sector.file$final_sector)) -3

```


# State's agriculture production 

Each state production in agriculture is defined as the sum of: i) total exports to other countries (after applying proportionality to match WIOD) and ii) the total value of production coming from the Agriculture Census (after applying proportionality to match exports of US to US exports in WIOD).

Initially, total production was defined only using the relative production in the agriculture CENSUS and aplying proportionality to match US production from WIOD. But this generated an issue: some few shares (e.g., the one of Alaska) in total production were small enough that made total production smaller than total exports to other countries. This is an inconsistency since the exports to other countries should be a subset of total production.  

Our solution described above makes sure by construction that total production total production is larger than total exports. However, it assumes that the relative importance of each state in trade with other states is the same as the relative importance of each state in their total production. We apply this assumptions for all states.

Another way to go is to only make corrections to the states generating issues. This correction would require to apply proportionality again and to verify that new problems of the same nature don't arise.  

## Production of agriculture of US states according to census of agriculture

```{r agric-census}
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 1. sum of crops, livestock, and fish
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
states_full<- merge(data_agri,data_fish, by=c("iso_o", "year"))
states_full$tot_prod <- states_full$fish_prod+states_full$Y_i

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 2. calculating relative state productions
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
states_full <- states_full %>%
  group_by(year) %>%
  mutate(tot_US= sum(tot_prod)) %>%
  ungroup() %>%
  mutate(rel= tot_prod/tot_US) 
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 3. Assigning data to years
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
agri <- c() 
# We use Agriculture Census of 2002 for years 2000-2004 
# and Agriculture Census of 2007 for years 2005-2007
agri.2002 <- states_full %>% filter(year==2002)
agri.2007 <- states_full %>% filter(year==2007)
for (yr in 2000:2007) {
  if (yr<2005) {
    num  <- agri.2002
  } else {
    num  <- agri.2007  
  }  
  num    <- num %>%
            select(iso_o, rel,tot_prod) %>%
            mutate(year=yr)
  
  agri <- rbind(agri, num)
}
agri$Y_i  <- NA
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 4. APPLYING PROPORTIONALITY TO WIOD
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
## SUM OF PRODUCTIONS ACROSS STATES = TOTAL PRODUCTION OF US ACCORDING TO WIOD

##
## 4.1 TOTAL PRODUCTION OF US IN AGRICULTURE ACCORDING TO WIOD
## 

WIOD.agri <- WIOD.full %>%
  filter(row_country=="USA", row_item==(n.sec+2), year<=2007) %>%
  group_by(year) %>%
  mutate(production= sum(value)) %>%
  ungroup() %>%
  distinct(year, .keep_all = TRUE) %>%
  select(-value, -col_item, -col_country)

##
## 4.2 DIVIDING TOTAL US PRODUCTION ACROSS STATES ACCORDING TO RELATIVE IMPORTANCE IN CENSUS
## 

for (yr in 2000:2007) {
  wiod.value  <- WIOD.agri %>%
                 filter(year==yr)
  wiod.value  <- wiod.value$production[1]
  agri        <- agri %>%
                 mutate(Y_i= ifelse(year==yr, rel*wiod.value, Y_i))
}

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 5. CHECKING
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

##
## 5.1 Check: total production of US states = total US in WIOD
## 

# total production of US states from proportionality 
check_1     <- agri %>%
               group_by(year) %>%
               mutate(total= sum(Y_i)) %>%
               ungroup() %>% 
               select(total, year) %>%
               distinct(year, total) 

# total production of US states from WIOD 
check_2     <- WIOD.full %>%
               filter(row_country=="USA", row_item==(n.sec+2)) %>%
               filter(year<=2007) %>%
               group_by(year) %>%
               mutate(production= sum(value)) %>%
               ungroup() %>%
               distinct(year, .keep_all = TRUE) %>%
               select(production, year)
#check
if(abs(sum(check_2$production / check_1$total-1)>epsilon)) 
   stop(paste("states' production does not add to WIOD for")) 

##
## 5.2 Check: total production of each state > total exports of each state
## 

#importing exports by state
exports <- c()
for (yr in 2000:2007) {
exports_0      <- read.csv(paste('1-Intermediate_Processed_Data//state_country_step_y_', yr, '.txt', sep= ""),                   header = TRUE, sep = ",", dec = ".")  
exports_0      <- exports_0 %>%
                  filter(sector==(n.sec+2)) %>%
                  select(-importer, -year, -sector)
exports_0      <- colSums(exports_0)
exports_0      <- as.data.frame(exports_0)
exports_0$year <- yr
exports_0$iso_o<- rownames(exports_0)
exports        <- rbind(exports, exports_0)
}

#comparing production and exports 

non_exports                   <- merge(exports,agri, by=c("iso_o", "year"));
non_exports$share_non_exports <- 1-non_exports$exports_0/non_exports$Y_i;  
#there is an issue with Alaska and Louisiana. Exports seem to be bigger than production. We will increase production by $\eta_1$ in order to get production> exports*1.05

```

### Fixing exports>production for Alaska and Louisiana

Define $s_0 = \dfrac{Y_{AK}^{Ag.Census}}{\sum_{j \in US\, ,\, j\neq AK}Y_{j}^{Ag.Census}+Y_{AK}^{Ag.Census}}$ as the relative importance of the production of Alaska in the total of the US according to the agriculture (plus fishing) Census. We want to find a value $\eta_1$ such that increasing the origina value $Y_{AK}^{Ag.Census}$ by $\eta_1$ percent would make the total production of Alaska equal to its total exports  (after accounting for the proportionality with WIOD). We want that:

$$
\dfrac{Y_{AK}^{Ag.Census}(1+\eta_1)}{\sum_{j \in US\, ,\, j\neq AK}Y_{j}^{Ag.Census}+Y_{AK}^{Ag.Census}(1+\eta_1)} \times Y^{WIOD}_{US} = \sum_{j \notin US} X_{AK\, j}
$$
Define $\omega_0=\dfrac{\sum_{j \notin US} X_{AK\, j}}{Y^{WIOD}_{US}}$. Using the definition of $s_o$, we get that:

$$
\eta_1 = \dfrac{\omega_0 s_0^{-1} -1 }{1-\omega_0}
$$
Finally, we compute $Y^{new}_{AK}=Y_{AK}^{Ag.Census}(1+\eta_1)\times 1.05$, and use proportionality to match WIOD.

```{r alaska}
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 1. COMPUTING $\eta_1$
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

##
## 1.1 computing $\omega_0$
##
#exports
exports_ak <- exports %>%
              filter(iso_o=="Alaska" | iso_o=="Louisiana") %>%
              merge(WIOD.agri, by=c("year")) %>%
              mutate(omega_0 = exports_0 / production) %>%
              select(iso_o, year, omega_0)

##
## 1.2 computing $s_0$
##
agri_ak    <- agri %>% 
              group_by(year) %>%
              mutate(tot_census= sum(Y_i)) %>%
              ungroup() %>%
              filter(iso_o=="Alaska" | iso_o=="Louisiana") %>%
              mutate(s_o=Y_i / tot_census) %>%
              select(year, iso_o, s_o, tot_prod)
              
##
## 1.3 computing $\eta_1$
##

agri_ak    <- agri_ak %>%
              merge(exports_ak, by=c("year", "iso_o")) %>%
              mutate(eta_1= (omega_0*s_o^(-1)-1) / (1-omega_0))

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 2. FIXING VALUE OF ALASKA
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

agri_ak   <- agri_ak %>%
             filter(eta_1>-0.05) %>%
             mutate(tot_prod_fixed=tot_prod*(1+eta_1)*1.05) %>%
             select(iso_o, tot_prod_fixed, year)


#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 3. REPLACING IN ORIGINAL DATA
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
agri      <- as.data.frame(lapply(agri, unlist))

agri_new  <- agri %>%
             select(iso_o, tot_prod, year) %>%
             merge(agri_ak, by=c("iso_o", "year"), all=TRUE) %>%
             mutate(tot_prod= ifelse(is.na(tot_prod_fixed), tot_prod, tot_prod_fixed)) %>%
             select(iso_o, year, tot_prod)
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 4. RECOMPUTING THE SHARES AND PROPORTIONALITY TO WIOD
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%              
##
## 4.2 SHARES
##
agri_new      <- agri_new %>%
                 group_by(year) %>%
                 mutate(tot_US= sum(tot_prod)) %>%
                 ungroup() %>%
                 mutate(rel= tot_prod/tot_US) 
agri_new$Y_i  <- NA
##
## 4.1 DIVIDING TOTAL US PRODUCTION ACROSS STATES ACCORDING TO RELATIVE IMPORTANCE IN CENSUS
## 

for (yr in 2000:2007) {
  wiod.value  <- WIOD.agri %>%
                 filter(year==yr)
  wiod.value  <- wiod.value$production[1]
  agri_new    <- agri_new %>%
                 mutate(Y_i= ifelse(year==yr, rel*wiod.value, Y_i))
}
agri_new <- agri_new %>%
            select(iso_o, year, Y_i)
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 5. CHECKING WITH EXPORTS AGAIN
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
non_exports <- merge(exports,agri_new, by=c("iso_o", "year")) %>%
               mutate(share_non_exports=1-exports_0/Y_i)        
#check
if(min(non_exports$share_non_exports<0)) 
   stop(paste("Still production<exports")) 

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# 6. CORRECT PRODUCTION OF US STATES
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

data_agriculture <- data_agriculture %>%
                    merge(agri_new, by=c("iso_o", "year"), all=TRUE) 

```

## Production and expenditure for countries

```{r prod-exp-countries}
##
## 1. agricultural production for countries 
##

WIOD.p <- WIOD.full %>%
          filter(row_item==n.sec+2) %>%
          group_by(year, row_country) %>%
          mutate(production= sum(value)) %>%
          ungroup() %>%
          distinct(year, row_country, .keep_all = TRUE) %>%
          mutate(iso_o=row_country) %>%
          select(iso_o, year, production)
##
## 2. agricultural expenditure for countries
##

WIOD.c <- WIOD.full %>%
          filter(row_item==n.sec+2) %>%
          group_by(year, col_country) %>%
          mutate(X_j= sum(value)) %>%
          ungroup() %>%
          distinct(year, col_country, .keep_all = TRUE) %>%
          mutate(iso_d=col_country) %>%
          select(iso_d, year, X_j)

##
## 3. merging with data_agriculture
##

#expenditure
data_agriculture <- data_agriculture %>%
                    merge(WIOD.c, by=c("iso_d", "year"), all=TRUE) 
#production
data_agriculture <- data_agriculture %>%
                    merge(WIOD.p, by=c("iso_o", "year"), all=TRUE) %>%
                    mutate(Y_i= ifelse(is.na(production), Y_i, production)) %>%
                    select(-production)
#arranging before saving
data_agriculture <- data_agriculture %>%
                    mutate(iso_o=as.character(iso_o), iso_d=as.character(iso_d)) %>%
                    mutate(c_o=ifelse(nchar(iso_o)>3, 0, 1), c_d=ifelse(nchar(iso_d)>3, 0, 1)) %>%
                    arrange(year, c_o, iso_o, c_d, iso_d) %>%
                    select(-c_o,-c_d)
data_agriculture <- data_agriculture[c("year", "iso_o", "iso_d", "dist", "Y_i", "X_j")]


write.table(data_agriculture, file = paste("1-Intermediate_Processed_Data//data_agriculture.csv", sep=""), sep = ",", row.names = FALSE)
```

# Proportionality for state-level imports and exports in agriculture

This is useful to calculate $X_j$ in a later code

## Imports of agriculture

```{r imports}
### Base year for imports (2008)
state_imp_exp <- data.frame(state_imp_exp.0) %>% 
  filter(year==2008, file=="i not in US, j in US") %>%
  select(-year, -file)

state_imp_exp <-spread(state_imp_exp, origin, value, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)
Base.e <- state_imp_exp %>% 
  arrange(sector, destination) %>%
  filter(sector==n.sec+2)

colnames(Base.e)= c("importer", "sector", c.names)
Base.e[is.na(Base.e)] <- 0

step3e.1 <- c()
for (yr in 2000:2007) {

#WIOD
WIOD <- subset(WIOD.base, year==yr)
WIOD <- subset(WIOD, select = -year) 


##################################################

eijkBase <- melt(Base.e, id.vars=c("importer", "sector"), variable.name="origin", value.name = "value")
eijkBase <-spread(eijkBase, importer, value, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)
eijkBase <- eijkBase[, 3:dim(eijkBase)[2]] / rowSums(eijkBase[, 3:dim(eijkBase)[2]]) 


#######################################Main Variable
#e
df.WIOD = data.frame(WIOD)
df.WIOD <- df.WIOD %>%
  filter(sector==n.sec+2) %>%
  filter(importer=='USA')
df.WIOD1 <- df.WIOD %>% select(-USA, -importer, -importer)
colnames(df.WIOD1) <- c("sector", c.names)
df.WIOD1 <- melt(df.WIOD1, id.vars=c("sector"), variable.name="origin", value.name = "value")
df.WIOD1 <- df.WIOD1 %>% arrange(sector, origin)

step3e=eijkBase*df.WIOD1$value
step3e <- cbind(df.WIOD1[, 1:2], step3e)


#Check
check= as.matrix(rowSums(step3e[, 3:dim(step3e)[2]]) - df.WIOD1$value)

##############################
#Correcting if needed
m.correct <- c()
for (sec in (n.sec+2)) {
m <- Base.e %>% filter(sector==sec)
m <- (rowSums(m[, 3:dim(m)[2]]) / sum(m[, 3:dim(m)[2]]))
m= t(matrix(replicate(n.c, m), nrow = length(m), ncol = n.c))
m.correct <- rbind(m.correct, m) 
}
m.correct <- m.correct*df.WIOD1$value

for (r in 1:(dim(check)[1])) {
  if(is.na(check[r])==TRUE){step3e[r, 3:dim(step3e)[2]] = m.correct[r, ]}
}

if(abs(sum(rowSums(step3e[, 3:dim(step3e)[2]]) - df.WIOD1$value))>epsilon) 
   stop(paste("states' imports from countries != WIOD US imports from countries for", yr, " value=", abs(sum(step3e[, 3:dim(step3e)[2]] - df.WIOD1$value))))
################

step3e <- melt(step3e, id.vars=c("origin", "sector"), variable.name="importer", value.name = "value")
step3e <-spread(step3e, origin, value, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)

step3e <- step3e %>%
  mutate(year=yr) %>%
  select(year, importer, sector, everything()) %>%
  select(-sector)
step3e.1 <- rbind(step3e.1, step3e)

}

CENSUS.imp <- melt(step3e.1, id.var=c("year", "importer"), variable.name = "origin")
CENSUS.imp$origin <- as.character(CENSUS.imp$origin)
write.table(CENSUS.imp, file = paste("1-Intermediate_Processed_Data//census.imp.agri.proportionality.csv", sep=""), sep = ",", row.names = FALSE)
```

## Exports of agriculture

```{r exports}
step3y.1 <- c()
for (yr in 2000:2007) {

#WIOD
WIOD <- subset(WIOD.base, year==yr)
WIOD <- subset(WIOD, select = -year) 


#Base year for exports (2002)
yr.=yr
if(yr<2002){yr.=2002}
state_imp_exp <- data.frame(state_imp_exp.0) %>% 
  filter(year==yr., file=="i in US, j not in US") %>%
  select(-year, -file)
state_imp_exp <-spread(state_imp_exp, origin, value, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)
#no trade from US states to SVK in sector 4 in 2002
if(yr<=2002) {row <- c("SVK", 4L, matrix(0, nrow=1, ncol=n.s))
state_imp_exp <- rbind(state_imp_exp, row)}
state_imp_exp$sector <- as.numeric(state_imp_exp$sector)

Base.y <- state_imp_exp %>% 
  arrange(sector, destination) %>%
  filter(sector==(n.sec+2)) #agric always sector n.sec+2
colnames(Base.y)= c("importer", "sector", s.names)
Base.y[is.na(Base.y)] <- 0
Base.y <- cbind(Base.y[, 1:2], mapply(Base.y[, 3:dim(Base.y)[2]], FUN=as.numeric))


########################################################
# proportions of trade of states to countries in agricu 
#######################################################

yijkBase <- Base.y[, 3:dim(Base.y)[2]] / rowSums(Base.y[, 3:dim(Base.y)[2]]) 

############################### Main variable
#y
df.WIOD = data.frame(WIOD)
df.WIOD <- df.WIOD %>%
  filter(sector==n.sec+2) %>%
  filter(importer!='USA') 

df.WIOD1 <- df.WIOD %>% select(importer, sector, USA)

step3y <- yijkBase*df.WIOD1$USA
step3y <- cbind(df.WIOD1[, 1:2], step3y)

#Check
check= as.matrix(rowSums(step3y[, 3:dim(step3y)[2]]) / df.WIOD1$USA-1)
if(sum(abs(check))>epsilon) 
   stop(paste("check not satisfied in", yr, " value=", abs(check)))

##############################
#Correcting if needed
Base.y1 <- melt(Base.y, id.vars=c("importer", "sector"), variable.name="origin", value.name = "value")
Base.y1 <-spread(Base.y1, importer, value, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)

m.correct <- c()
for (sec in (n.sec+2)) {
m <- Base.y1 %>% filter(sector==sec)
m <- (rowSums(m[, 3:dim(m)[2]]) / sum(m[, 3:dim(m)[2]]))
m= t(matrix(replicate(n.c, m), nrow = length(m), ncol = n.c))
m.correct <- rbind(m.correct, m) 
}
m.correct <- m.correct*df.WIOD1$USA

for (r in 1:(dim(check)[1])) {
  if(is.na(check[r])==TRUE){step3y[r, 3:dim(step3y)[2]] = m.correct[r, ]}
}

if(abs(sum(rowSums(step3y[, 3:dim(step3y)[2]]) - df.WIOD1$USA))>epsilon) 
   stop(paste("states' exports to countries != WIOD US exports to countries for", yr, " value=", abs(sum(step3y[, 3:dim(step3y)[2]] - df.WIOD1$value))))
################

step3y <- step3y %>%
  mutate(year=yr) %>%
  select(year, importer, sector, everything()) %>%
  filter(sector==n.sec+2) %>%
  select(-sector)
colnames(step3y) <- c("year", "importer", s.names)

step3y.1 <- rbind(step3y.1, step3y)
}
CENSUS.exp <- melt(step3y.1, id.var=c("year", "importer"), variable = "origin")
CENSUS.exp$origin <- as.character(CENSUS.exp$origin)
write.table(CENSUS.exp, file = paste("1-Intermediate_Processed_Data//census.exp.agri.proportionality.csv", sep=""), sep = ",", row.names = FALSE)

```


