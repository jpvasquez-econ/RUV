---
title: "Census trade flows between US states and other countries"
output:
  html_notebook:
    toc: yes
    df_print: paged
    number_sections: yes    
  pdf_document:
    number_sections: yes
header-includes:
- \usepackage{amsmath}
- \usepackage{amssymb}
- \usepackage{pifont}
- \usepackage{mathpazo}
---

# General information

This code calculates the sector-country bilateral trade flows $X_{ij,k}$ when $i\in US\;  \&\;  j \notin US$ (exports from each state to each country) and $i\notin US\;  \&\;  j \in US$ (imports from each country to each state), for all sectors $k$ (except services).

## Input files

1. `0-Raw_Data/regions.csv`
2. `0-Raw_Data/sectors.csv`
3. `1-Intermediate_Processed_Data/state_imports_exports.csv`
4. `1-Intermediate_Processed_Data/country_country_step_.csv`

## Output files

Two csv files per year. The first one has exports of states to countries and the second one imports of states from countries. The roots of the files are: 

1. `Intermediate_Processed_Data//state_country_step_y_.csv`
2. `Intermediate_Processed_Data//state_country_step_e_.csv`


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
remove(list = ls())
```

```{r packages, warning=FALSE, include=FALSE, message=FALSE, results='hide', cache=FALSE}
# libraries
options( scipen=100, stringsAsFactors=FALSE );
# vector of libraries to be used
libs <- c( 'dplyr', 'tidyr', 'readstata13', 'haven', 'stringr', 'nleqslv', 'gdata', 'Statamarkdown', 'foreign', 'reshape2', 'read_excel', 'readxl');
# Install libraries in case they are not installed
for( i in length(libs)){ 
  if( !(libs[i] %in% installed.packages()) ) install.packages( libs ) 
};
# Carga de bibliotecas
lapply( libs, require, character.only=TRUE );
```

# Exports and imports of US states

We use $X_{ij,k}^{Census}$ and $X_{ij,k}^{WIOD}$ plus proportionality to calculate $X_{ij,k}$ for $i\in US\;  \&\;  j \notin US$ (exports from each State to each country) and $i\notin US\;  \&\;  j \in US$ (imports from each country to each State), and $\forall k$ (except services). We do the same procedure each year. Census data on exports and imports starts in 2002 and 2008 respectively. For the years before the starting Census year we assume that the share of sector-level imports (exports) of each state from (to) each country in the total imports (exports) of the state in each year remains constant at the level of the starting Census year.

## Intermediate variables 

Define the share of exports of US State $i$ in sector $k$, going to country $j$ as: $$y_{ij,k}^{Census}\equiv\dfrac{X_{ij,k}^{Census}}{\sum_{h\in US}X_{hj,k}^{Census}} \; \forall i\in US \, , \, j\notin US.$$ 

Similarly, only for $j \in US$ define the share of imports of State $j$ in sector $k$, coming from country $i$ as
$$e_{ij,k}^{Census}\equiv\dfrac{X_{ij,k}^{Census}}{\sum_{l\in US}X_{il,k}^{Census}}. \; \forall i\notin US \, , \, j\in US.$$ 

**Note**: There are some very few cases that required corrections. For instance, say country j (i) did not import (export) from (to) the US in a given sector $k$ according to CENSUS data but it did it according to WIOD data. Then we would calculate $e_{ij,k}$ ($y_{ij,k}$) by splitting WIOD imports (exports) between the states according to the share of imports (exports) of that state in the total US imports (exports) of that sector $k$. This means:

$$
y_{i\;j,k}^{census}\equiv\dfrac{\sum_{j\notin US}X_{ij,k}^{census}}{\sum_{h\in US}\sum_{l\notin US}X_{hl,k}^{census}}, \; i\in US \, , \, j\notin US
$$

$$
e_{i\;j,k}^{census}\equiv\dfrac{\sum_{i\notin US}X_{ij,k}^{census}}{\sum_{h\notin US}\sum_{l\in US}X_{hl,k}^{census}}, \; i\notin US \, , \, j\in US
$$

## Main variable

Define $\forall k$: 

$$X_{ij,k}=
\begin{cases}
e_{ij,k}^{Census}X_{i\,US,k}^{WIOD} \quad \forall i\notin US, \; \forall j\in US\\
y_{ij,k}^{Census}X_{US\,j,k}^{WIOD} \quad \forall i\in US, \; \forall j\notin US
\end{cases} $$

# Calculations 

## Importing datasets to R

```{r data}
#state level imports and exports
state_imp_exp.0 <- read.csv("1-Intermediate_Processed_Data//state_imports_exports.csv")
state_imp_exp.0 <- state_imp_exp.0 %>% filter(origin!="AllStates", destination!="AllStates")

#WIOD
wiod_base <- c()
for (yr in 2000:2007) {
  wiod <- country.country <- read.csv(paste('1-Intermediate_Processed_Data//country_country_step_', yr, '.csv', sep= ""), header = TRUE, sep = ",", dec = ".")
  wiod_base <- rbind(wiod_base, wiod)
}


#General parameters
regions <- read.csv("0-Raw_Data/regions.csv")
c.names <- regions %>% filter(status=="country", region!="USA")
c.names <- c.names$region

s.names <- regions %>% filter(status=="state") 
s.names <- s.names$region

n.s <- length(s.names)
n.c <- length(c.names)

reclass_sectors <- read.csv("0-Raw_Data/sectors.csv")
n.sec <- length(unique(reclass_sectors$final_sector)) - 3

epsilon <- 0.0001;

```

## Imports and Exports

### Imports

```{r}
### Base year for imports (2008)
state_imp_exp <- data.frame(state_imp_exp.0) %>% 
  filter(year == 2008, file == "i not in US, j in US") %>%
  select(-year, -file)

state_imp_exp <-spread(state_imp_exp, origin, value, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)
base_e <- state_imp_exp %>% 
  arrange(sector, destination) %>%
  filter(sector <= n.sec | sector == (n.sec+2))

colnames(base_e) <- c("importer", "sector", c.names)
base_e[is.na(base_e)] <- 0


for (yr in 2000:2007) {

#WIOD
wiod <- subset(wiod_base, year==yr)
wiod <- subset(wiod, select = -year) 


##################################################

eijkBase <- melt(base_e, id.vars=c("importer", "sector"), variable.name="origin", value.name = "value")
eijkBase <-spread(eijkBase, importer, value, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)
eijkBase <- eijkBase[, 3:dim(eijkBase)[2]] / rowSums(eijkBase[, 3:dim(eijkBase)[2]]) 


#######################################Main Variable
#e
df_wiod <- data.frame(wiod)
df_wiod <- df_wiod %>%
  filter(sector <= n.sec | sector == (n.sec+2)) %>%
  filter(importer == 'USA')
df_wiod1 <- df_wiod %>% select(-USA, -importer)
colnames(df_wiod1) <- c("sector", c.names)
df_wiod1 <- melt(df_wiod1, id.vars=c("sector"), variable.name = "origin", value.name = "value")
df_wiod1 <- df_wiod1 %>% arrange(sector, origin)

step3e <- eijkBase*df_wiod1$value
step3e <- cbind(df_wiod1[, 1:2], step3e)


#Check
check <- as.matrix(rowSums(step3e[, 3:dim(step3e)[2]]) - df_wiod1$value)

##############################
#Correcting if needed
m.correct <- c()
for (sec in c(1:(n.sec), (n.sec+2))) {
m <- base_e %>% filter(sector == sec)
m <- (rowSums(m[, 3:dim(m)[2]]) / sum(m[, 3:dim(m)[2]]))
m <- t(matrix(replicate(n.c, m), nrow = length(m), ncol = n.c))
m.correct <- rbind(m.correct, m) 
}
m.correct <- m.correct*df_wiod1$value

for (r in 1:(dim(check)[1])) {
  if(is.na(check[r]) == TRUE){step3e[r, 3:dim(step3e)[2]] = m.correct[r, ]}
}

if(sum(abs(rowSums(step3e[, 3:dim(step3e)[2]])/df_wiod1$value -1))>epsilon) 
   stop(paste("states' imports from countries != WIOD US imports from countries for", yr, " value=", sum(abs(rowSums(step3e[, 3:dim(step3e)[2]])/df_wiod1$value -1))))
################

step3e <- melt(step3e, id.vars=c("origin", "sector"), variable.name="importer", value.name = "value")
step3e <-spread(step3e, origin, value, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)

step3e <- step3e %>%
  mutate(year = yr) %>%
  select(year, importer, sector, everything())

  #Exporting dataset
write.table(step3e, file = paste("1-Intermediate_Processed_Data//state_country_step_e_", yr,".csv", sep=""), sep = ",", row.names = FALSE)
}

```


### Exports

```{r}

for (yr in 2000:2007) {

#WIOD
wiod <- subset(wiod_base, year == yr)
wiod <- subset(wiod, select = -year) 


#Base year for exports (2002)
yr. <- yr
if(yr < 2002){yr. = 2002}
state_imp_exp <- data.frame(state_imp_exp.0) %>% 
  filter(year == yr., file == "i in US, j not in US") %>%
  select(-year, -file)
state_imp_exp <- spread(state_imp_exp, origin, value, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)
#no trade from US states to SVK in sector 4 in 2002
if(yr <= 2002) {row <- c("SVK", 4L, matrix(0, nrow = 1, ncol = n.s))
state_imp_exp <- rbind(state_imp_exp, row)}
state_imp_exp$sector <- as.numeric(state_imp_exp$sector)

base_y <- state_imp_exp %>% 
  arrange(sector, destination) %>%
  filter(sector <= n.sec | sector == (n.sec+2))
colnames(base_y) = c("importer", "sector", s.names)
base_y[is.na(base_y)] <- 0
base_y <- cbind(base_y[, 1:2], mapply(base_y[, 3:dim(base_y)[2]], FUN=as.numeric))


##################################################

##################################################

yijkBase <- base_y[, 3:dim(base_y)[2]] / rowSums(base_y[, 3:dim(base_y)[2]]) 

############################### Main variable
#y
df_wiod <- data.frame(wiod)
df_wiod <- df_wiod %>%
  filter(sector <= n.sec | sector == (n.sec+2)) %>%
  filter(importer != 'USA') 

df_wiod1 <- df_wiod %>% select(importer, sector, USA)

step3y <- yijkBase*df_wiod1$USA
step3y <- cbind(df_wiod1[, 1:2], step3y)

#Check
check <- as.matrix(rowSums(step3y[, 3:dim(step3y)[2]]) - df_wiod1$USA)


##############################
#Correcting if needed
base_y1 <- melt(base_y, id.vars=c("importer", "sector"), variable.name="origin", value.name = "value")
base_y1 <-spread(base_y1, importer, value, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)

m.correct <- c()
for (sec in c(1:(n.sec), (n.sec+2))) {
m <- base_y1 %>% filter(sector == sec)
m <- (rowSums(m[, 3:dim(m)[2]]) / sum(m[, 3:dim(m)[2]]))
m <- t(matrix(replicate(n.c, m), nrow = length(m), ncol = n.c))
m.correct <- rbind(m.correct, m) 
}
m.correct <- m.correct*df_wiod1$USA

for (r in 1:(dim(check)[1])) {
  if(is.na(check[r]) == TRUE){step3y[r, 3:dim(step3y)[2]] = m.correct[r, ]}
}

if(sum(abs(rowSums(step3y[, 3:dim(step3y)[2]])/df_wiod1$USA -1))>epsilon) 
   stop(paste("states' exports to countries != WIOD US exports to countries for", yr, " value=", sum(abs(rowSums(step3y[, 3:dim(step3y)[2]])/df_wiod1$USA -1))))
################

step3y <- step3y %>%
  mutate(year = yr) %>%
  select(year, importer, sector, everything())
colnames(step3y) <- c("year", "importer", "sector", s.names)

#Exporting data
write.table(step3y, file = paste("1-Intermediate_Processed_Data//state_country_step_y_", yr,".csv", sep=""), sep = ",", row.names = FALSE)
}
```






