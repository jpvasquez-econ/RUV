---
title: "6-2-Value_added_shares_countries"
output:
  html_document:
    df_print: paged
  pdf_document:
    number_sections: yes
  word_document: default
header-includes:
- \usepackage{amsmath}
- \usepackage{amssymb}
- \usepackage{pifont}
- \usepackage{mathpazo}
- \newcommand{\xmark}{\ding{55}}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
remove(list = ls())
```

```{r warning=FALSE, include=FALSE, message=FALSE, results='hide', cache=FALSE}
# libraries
options( scipen=100, stringsAsFactors=FALSE );
## vector of libraries to be used
libs <- c( 'dplyr', 'tidyr', 'readstata13', 'haven', 'stringr', 'nleqslv', 'gdata', 'Statamarkdown', 'readxl', 'reshape2');
# Install libraries in case they are not installed
for( i in length(libs)){
  if( !(libs[i] %in% installed.packages()) ) install.packages( libs )
};
# Carga de bibliotecas
lapply( libs, require, character.only=TRUE );
```

# General Instructions

This code calculates the share of value added in gross output for each US state and each country, for each sector.

### Constructing Value-Added for countries ("Labor Shares")

We need to compute the share of value added in gross output the 50 for US states.  We can obtain data on sectoral and regional value added for the US from the Bureau of Economic Analysis (BEA). The final output would a matrix 50 $\times$ 13 with the shares of value added in gross output for each state, for each sector. Let's focus on the year 2000.

- Value added for each of the 50 U.S. states and 13 sectors can be obtained from the Bureau of Economic Analysis (BEA) by subtracting taxes and subsidies from GDP data 
- Gross outputs for each region $i$ is just $Y_{i,k}= \sum_j X_{ij,k}$ 
- In a few cases, gross output might be smaller than value added (probably due to some small discrepancies between trade and production data, etc). In such cases, just constrain value added to be equal to gross output. 


## Importing datasets to R
```{r}
n.s <- 50
n.c <- 37

#WIOD
wiot.full <- read.dta13("1-Intermediate_Processed_Data//wiot_full.dta")
wiot.full=data.frame(wiot.full)
wiot.full <- wiot.full %>% 
  filter(year>=2000, col_country!="LUX", col_country!="LVA", col_country!="MLT", row_country!="LUX", row_country!="LVA", row_country!="MLT") %>% 
  mutate(row_country= ifelse(row_country=="ROM", "ROU", row_country)) %>%
  mutate(col_country= ifelse(col_country=="ROM", "ROU", col_country)) %>%
  mutate(row_item= recode(row_item, '1'=14L, '2'=4L, '3'=1L, '4'=2L, '5'=2L, '6'=3L, '7'=3L, '8'=4L, '9'=5L, '10'=6L, '11'=7L, '12'=8L, '13'=9L, '14'=10L, '15'=11L, '16'=12L, '17'=0L, '18'=13L, '19'=13L, '20'=13L, '21'=13L, '22'=13L, '23'=13L, '24'=13L, '25'=13L, '26'=13L, '27'=13L, '28'=13L, '29'=13L, '30'=13L, '31'=0L, '32'=13L, '33'=13L, '34'=13L, '35'=0L, '36'=0L, '37'=37L, '38'=37L, '39'=37L, '40'=37L, '41'=37L, '42'=37L )) %>%
  mutate(col_item= recode(col_item, '1'=14L, '2'=4L, '3'=1L, '4'=2L, '5'=2L, '6'=3L, '7'=3L, '8'=4L, '9'=5L, '10'=6L, '11'=7L, '12'=8L, '13'=9L, '14'=10L, '15'=11L, '16'=12L, '17'=0L, '18'=13L, '19'=13L, '20'=13L, '21'=13L, '22'=13L, '23'=13L, '24'=13L, '25'=13L, '26'=13L, '27'=13L, '28'=13L, '29'=13L, '30'=13L, '31'=0L, '32'=13L, '33'=13L, '34'=13L, '35'=0L, '36'=0L, '37'=37L, '38'=37L, '39'=37L, '40'=37L, '41'=37L, '42'=37L )) %>%
  filter(col_item!=0 & row_item!=0) %>% #consumption is sec 37
  arrange(year, row_country, col_country, row_item, col_item) %>%
  group_by(year, row_country, col_country, row_item, col_item) %>% #aggregating repeated r-c sequence
  mutate(value1= sum(value)) %>%
  ungroup() %>%
  distinct(year, row_country, col_country, row_item, col_item, .keep_all = TRUE) %>%
  select(-value) %>%
  dplyr::rename(value=value1)

wiot.full.inter <- wiot.full %>%
  filter(col_item!=37)
```


Gross output for each region, for each sector
$Y_{i,k}= \sum_j X_{ij,k} \quad for \quad all \quad j$
```{r}
Y <- wiot.full %>%
  group_by(year, row_country, row_item) %>%
  mutate(val= sum(value)) %>%
  ungroup() %>%
  distinct(year, row_country, row_item, .keep_all = TRUE) %>%
  select(-col_country, -col_item, -value) %>%
  dplyr::rename(sector=row_item, region=row_country) %>%
  arrange(year, sector, region)

```


Calculating value added
```{r}
#calculating value added for countries
sum.s.X_jsk <- wiot.full.inter %>%
  group_by(year, col_country, col_item) %>%
  mutate(val= sum(value)) %>%
  ungroup() %>%
  distinct(year, col_country, col_item, .keep_all = TRUE) %>%
  select(-row_country, -row_item, -value) %>%
  dplyr::rename(region=col_country, sector=col_item) %>%
  arrange(year, sector, region)
VA <- Y$val - sum.s.X_jsk$val
VA <- cbind(Y[1:3], VA)
colnames(VA) <- c("year", "region", "sector", "value_added")

VA<-spread(VA, sector, value_added, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)
Y <-spread(Y, sector, val, fill = NA, convert = TRUE,  drop = TRUE, sep = NULL)


```

share of value added in gross output
$Labor share = \frac{VA_{i,k}}{Y_{i,k}}$
```{r}
labor_shares <- VA[, 3:dim(VA)[2]] / Y[, 3:dim(Y)[2]]
labor_shares[labor_shares>1] <- 1
labor_shares[labor_shares<(-1)] <- (-1)
labor_shares <- cbind(VA[, 1:2], labor_shares)

for (yr in 2000:2007) {
  final <- labor_shares %>%
    filter(year==yr)
  write.table(final, file = paste("1-Intermediate_Processed_Data//value_shares_countries", yr, ".csv", sep=""), sep = ",", row.names = FALSE)
}


```
